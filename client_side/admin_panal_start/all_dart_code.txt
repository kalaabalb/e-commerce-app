
========== FILE: lib/core/data/data_provider.dart ==========

import 'dart:convert';
import 'dart:io';
import 'package:admin_panal_start/services/admin_auth_service.dart';

import '../../models/api_response.dart';
import '../../models/coupon.dart';
import '../../models/my_notification.dart';
import '../../models/order.dart';
import '../../models/poster.dart';
import '../../models/product.dart';
import '../../models/variant_type.dart';
import '../../services/http_services.dart';
import '../../utility/snack_bar_helper.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/foundation.dart' hide Category;
import 'package:get/get.dart';
import '../../../models/category.dart';
import '../../models/brand.dart';
import '../../models/sub_category.dart';
import '../../models/variant.dart';

class DataProvider extends ChangeNotifier {
  HttpService service = HttpService();

  List<Category> _allCategories = [];
  List<Category> _filteredCategories = [];
  List<Category> get categories => _filteredCategories;

  List<SubCategory> _allSubCategories = [];
  List<SubCategory> _filteredSubCategories = [];
  List<SubCategory> get subCategories => _filteredSubCategories;

  List<Brand> _allBrands = [];
  List<Brand> _filteredBrands = [];
  List<Brand> get brands => _filteredBrands;

  List<VariantType> _allVariantTypes = [];
  List<VariantType> _filteredVariantTypes = [];
  List<VariantType> get variantTypes => _filteredVariantTypes;

  List<Variant> _allVariants = [];
  List<Variant> _filteredVariants = [];
  List<Variant> get variants => _filteredVariants;

  List<Product> _allProducts = [];
  List<Product> _filteredProducts = [];
  List<Product> get products => _filteredProducts;

  List<Coupon> _allCoupons = [];
  List<Coupon> _filteredCoupons = [];
  List<Coupon> get coupons => _filteredCoupons;

  List<Poster> _allPosters = [];
  List<Poster> _filteredPosters = [];
  List<Poster> get posters => _filteredPosters;

  List<Order> _allOrders = [];
  List<Order> _filteredOrders = [];
  List<Order> get orders => _filteredOrders;

  List<MyNotification> _allNotifications = [];
  List<MyNotification> _filteredNotifications = [];
  List<MyNotification> get notifications => _filteredNotifications;

  bool _isLoading = false;
  bool get isLoading => _isLoading;

  DataProvider() {
    // Don't initialize data immediately - wait for the app to be ready
  }

  void initializeAppData() {
    _initializeData();
  }

// Add this method to your existing DataProvider class
  void filterDataBasedOnUserRole() {
    final authService = Get.find<AdminAuthService>();

    if (authService.canManageAllContent()) {
      // Super admin sees everything
      _filteredProducts = List.from(_allProducts);
      _filteredCategories = List.from(_allCategories);
      _filteredSubCategories = List.from(_allSubCategories);
      _filteredBrands = List.from(_allBrands);
      _filteredVariantTypes = List.from(_allVariantTypes);
      _filteredVariants = List.from(_allVariants);
      _filteredCoupons = List.from(_allCoupons);
      _filteredPosters = List.from(_allPosters);
      _filteredOrders = List.from(_allOrders);
      _filteredNotifications = List.from(_allNotifications);
    } else {
      // Regular admin sees only their own items
      final currentUserId = authService.getUserId();
      _filteredProducts = _allProducts
          .where((product) => product.createdBy == currentUserId)
          .toList();
      _filteredCategories = _allCategories
          .where((category) => category.createdBy == currentUserId)
          .toList();
      _filteredSubCategories = _allSubCategories
          .where((subCategory) => subCategory.createdBy == currentUserId)
          .toList();
      _filteredBrands = _allBrands
          .where((brand) => brand.createdBy == currentUserId)
          .toList();
      _filteredVariantTypes = _allVariantTypes
          .where((variantType) => variantType.createdBy == currentUserId)
          .toList();
      _filteredVariants = _allVariants
          .where((variant) => variant.createdBy == currentUserId)
          .toList();
      _filteredCoupons = _allCoupons
          .where((coupon) => coupon.createdBy == currentUserId)
          .toList();
      _filteredPosters = _allPosters
          .where((poster) => poster.createdBy == currentUserId)
          .toList();

      // Orders and notifications might be visible to all admins
      _filteredOrders = List.from(_allOrders);
      _filteredNotifications = List.from(_allNotifications);
    }
    notifyListeners();
  }

// Call this method after loading data in your initialization
  void _initializeData() async {
    try {
      _isLoading = true;
      notifyListeners();

      await Future.wait([
        getAllProduct(),
        getAllVariant(),
        getAllCategory(),
        getAllSubCategory(),
        getAllBrands(),
        getAllVariantType(),
        getAllPosters(),
        getAllCoupons(),
        getAllOrders(),
      ], eagerError: false);
      debugDataState();
      // Filter data based on user role after loading
      filterDataBasedOnUserRole();
    } catch (e) {
      if (kDebugMode) {
        print('Error initializing DataProvider: $e');
      }
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  void debugDataState() {
    if (kDebugMode) {
      print('üîç DataProvider Debug:');
      print('   All Products: ${_allProducts.length}');
      print('   Filtered Products: ${_filteredProducts.length}');
      print('   All Categories: ${_allCategories.length}');
      print('   All Brands: ${_allBrands.length}');

      if (_allProducts.isNotEmpty) {
        print('   First Product: ${_allProducts.first.name}');
        print(
            '   First Product Category: ${_allProducts.first.proCategoryId?.name}');
      }
    }
  }

  void testConnectivity() async {
    try {
      final response = await service.getItems(endpointUrl: 'health');
    } catch (e) {
      if (kDebugMode) {
        print('Connectivity test failed: $e');
      }
    }
  }

  void testConnection() async {
    try {
      final response = await service.getItems(endpointUrl: 'health');
    } catch (e) {
      if (kDebugMode) {
        print('Connection test failed: $e');
      }
    }
  }

  Future<List<Category>> getAllCategory({bool showSnack = false}) async {
    try {
      Response response = await service.getItems(endpointUrl: 'categories');

      if (response.body == null) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('No response from server');
        }
        return _filteredCategories;
      }

      dynamic responseBody = response.body;
      if (responseBody is String) {
        try {
          responseBody = json.decode(responseBody);
        } catch (e) {
          if (showSnack) {
            SnackBarHelper.showErrorSnackBar('Invalid response format');
          }
          return _filteredCategories;
        }
      }

      if (responseBody is! Map<String, dynamic>) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('Invalid response format');
        }
        return _filteredCategories;
      }

      ApiResponse<List<Category>> apiResponse = ApiResponse.fromJson(
        responseBody,
        (json) =>
            (json as List).map((item) => Category.fromJson(item)).toList(),
      );

      _allCategories = apiResponse.data ?? [];
      _filteredCategories = List.from(_allCategories);

      notifyListeners();

      if (showSnack && apiResponse.message.isNotEmpty) {
        SnackBarHelper.showSuccessSnackBar(apiResponse.message);
      }
    } catch (e) {
      if (kDebugMode) {
        print('Error in getAllCategory: $e');
      }
      if (showSnack) {
        SnackBarHelper.showErrorSnackBar('Failed to load categories');
      }
    }
    return _filteredCategories;
  }

  void checkHttpConfiguration() {
    // Test if we can reach the server
    testConnectivity();
  }

  void filterCategories(String keyword) {
    if (keyword.isEmpty) {
      _filteredCategories = List.from(_allCategories);
    } else {
      final lowcase = keyword.toLowerCase();
      _filteredCategories = _allCategories.where((category) {
        return (category.name ?? '').toLowerCase().contains(lowcase);
      }).toList();
    }
    notifyListeners();
  }

  Future<List<SubCategory>> getAllSubCategory({bool showSnack = false}) async {
    try {
      Response response = await service.getItems(endpointUrl: 'subCategories');

      if (response.body == null) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('No response from server');
        }
        return _filteredSubCategories;
      }

      dynamic responseBody = response.body;
      if (responseBody is String) {
        try {
          responseBody = json.decode(responseBody);
        } catch (e) {
          if (showSnack) {
            SnackBarHelper.showErrorSnackBar('Invalid response format');
          }
          return _filteredSubCategories;
        }
      }

      if (responseBody is! Map<String, dynamic>) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('Invalid response format');
        }
        return _filteredSubCategories;
      }

      ApiResponse<List<SubCategory>> apiResponse = ApiResponse.fromJson(
        responseBody,
        (json) =>
            (json as List).map((item) => SubCategory.fromJson(item)).toList(),
      );

      _allSubCategories = apiResponse.data ?? [];
      _filteredSubCategories = List.from(_allSubCategories);
      notifyListeners();

      if (showSnack && apiResponse.message.isNotEmpty) {
        SnackBarHelper.showSuccessSnackBar(apiResponse.message);
      }
    } catch (e) {
      if (kDebugMode) {
        print('Error in getAllSubCategory: $e');
      }
      if (showSnack) {
        SnackBarHelper.showErrorSnackBar('Failed to load subcategories');
      }
    }
    return _filteredSubCategories;
  }

  void filteredSubCategories(String keyword) {
    if (keyword.isEmpty) {
      _filteredSubCategories = List.from(_allSubCategories);
    } else {
      final lowcase = keyword.toLowerCase();
      _filteredSubCategories = _allSubCategories.where((SubCategory) {
        return (SubCategory.name ?? '').toLowerCase().contains(lowcase);
      }).toList();
    }
    notifyListeners();
  }

  Future<List<Brand>> getAllBrands({bool showSnack = false}) async {
    try {
      Response response = await service.getItems(endpointUrl: 'brands');

      if (response.body == null) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('No response from server');
        }
        return _filteredBrands;
      }

      dynamic responseBody = response.body;
      if (responseBody is String) {
        try {
          responseBody = json.decode(responseBody);
        } catch (e) {
          if (showSnack) {
            SnackBarHelper.showErrorSnackBar('Invalid response format');
          }
          return _filteredBrands;
        }
      }

      if (responseBody is! Map<String, dynamic>) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('Invalid response format');
        }
        return _filteredBrands;
      }

      ApiResponse<List<Brand>> apiResponse = ApiResponse.fromJson(
        responseBody,
        (json) => (json as List).map((item) => Brand.fromJson(item)).toList(),
      );

      _allBrands = apiResponse.data ?? [];
      _filteredBrands = List.from(_allBrands);
      notifyListeners();

      if (showSnack && apiResponse.message.isNotEmpty) {
        SnackBarHelper.showSuccessSnackBar(apiResponse.message);
      }
    } catch (e) {
      if (kDebugMode) {
        print('Error in getAllBrands: $e');
      }
      if (showSnack) {
        SnackBarHelper.showErrorSnackBar('Failed to load brands');
      }
    }
    return _filteredBrands;
  }

  void filteredBrands(String keyword) {
    if (keyword.isEmpty) {
      _filteredBrands = List.from(_allBrands);
    } else {
      final lowcase = keyword.toLowerCase();
      _filteredBrands = _allBrands.where((Brand) {
        return (Brand.name ?? '').toLowerCase().contains(lowcase);
      }).toList();
    }
    notifyListeners();
  }

  void testProductsAPI() async {
    try {
      final response = await service.getItems(endpointUrl: 'products');

      if (response.isOk) {
        final data = response.body;
        if (data is Map) {
          if (data['data'] is List) {
            final products = data['data'] as List;
          }
        }
      }
    } catch (e) {
      if (kDebugMode) {
        print('API Test Error: $e');
      }
    }
  }

  Future<List<VariantType>> getAllVariantType({bool showSnack = false}) async {
    try {
      Response response = await service.getItems(endpointUrl: 'variantTypes');

      if (response.body == null) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('No response from server');
        }
        return _filteredVariantTypes;
      }

      dynamic responseBody = response.body;
      if (responseBody is String) {
        try {
          responseBody = json.decode(responseBody);
        } catch (e) {
          if (showSnack) {
            SnackBarHelper.showErrorSnackBar('Invalid response format');
          }
          return _filteredVariantTypes;
        }
      }

      if (responseBody is! Map<String, dynamic>) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('Invalid response format');
        }
        return _filteredVariantTypes;
      }

      ApiResponse<List<VariantType>> apiResponse = ApiResponse.fromJson(
        responseBody,
        (json) =>
            (json as List).map((item) => VariantType.fromJson(item)).toList(),
      );

      _allVariantTypes = apiResponse.data ?? [];
      _filteredVariantTypes = List.from(_allVariantTypes);
      notifyListeners();

      if (showSnack && apiResponse.message.isNotEmpty) {
        SnackBarHelper.showSuccessSnackBar(apiResponse.message);
      }
    } catch (e) {
      if (kDebugMode) {
        print('Error in getAllVariantType: $e');
      }
      if (showSnack) {
        SnackBarHelper.showErrorSnackBar('Failed to load variant types');
      }
    }
    return _filteredVariantTypes;
  }

  void filterVariantTypes(String keyword) {
    if (keyword.isEmpty) {
      _filteredVariantTypes = List.from(_allVariantTypes);
    } else {
      final lowcase = keyword.toLowerCase();
      _filteredVariantTypes = _allVariantTypes.where((VariantType) {
        return (VariantType.name ?? '').toLowerCase().contains(lowcase);
      }).toList();
    }
    notifyListeners();
  }

  Future<List<Variant>> getAllVariant({bool showSnack = false}) async {
    try {
      Response response = await service.getItems(endpointUrl: 'variants');

      if (response.body == null) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('No response from server');
        }
        return _filteredVariants;
      }

      dynamic responseBody = response.body;
      if (responseBody is String) {
        try {
          responseBody = json.decode(responseBody);
        } catch (e) {
          if (showSnack) {
            SnackBarHelper.showErrorSnackBar('Invalid response format');
          }
          return _filteredVariants;
        }
      }

      if (responseBody is! Map<String, dynamic>) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('Invalid response format');
        }
        return _filteredVariants;
      }

      ApiResponse<List<Variant>> apiResponse = ApiResponse.fromJson(
        responseBody,
        (json) => (json as List).map((item) => Variant.fromJson(item)).toList(),
      );

      _allVariants = apiResponse.data ?? [];
      _filteredVariants = List.from(_allVariants);
      notifyListeners();

      if (showSnack && apiResponse.message.isNotEmpty) {
        SnackBarHelper.showSuccessSnackBar(apiResponse.message);
      }
    } catch (e) {
      if (kDebugMode) {
        print('Error in getAllVariant: $e');
      }
      if (showSnack) {
        SnackBarHelper.showErrorSnackBar('Failed to load variants');
      }
    }
    return _filteredVariants;
  }

  void filterVariants(String keyword) {
    if (keyword.isEmpty) {
      _filteredVariants = List.from(_allVariants);
    } else {
      final lowcase = keyword.toLowerCase();
      _filteredVariants = _allVariants.where((Variant) {
        return (Variant.name ?? '').toLowerCase().contains(lowcase);
      }).toList();
    }
    notifyListeners();
  }

  Future<List<Product>> getAllProduct({bool showSnack = false}) async {
    try {
      Response response = await service.getItems(endpointUrl: 'products');

      if (response.body == null) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('No response from server');
        }
        return _filteredProducts;
      }

      dynamic responseBody = response.body;

      // Debug: Print the actual response structure
      if (kDebugMode) {
        print('üì• Products API Response: $responseBody');
      }

      // Handle different response formats
      if (responseBody is String) {
        try {
          responseBody = json.decode(responseBody);
        } catch (e) {
          if (showSnack) {
            SnackBarHelper.showErrorSnackBar('Invalid response format');
          }
          return _filteredProducts;
        }
      }

      if (responseBody is! Map<String, dynamic>) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('Invalid response format');
        }
        return _filteredProducts;
      }

      // Check if the response has the expected structure
      if (responseBody['success'] == true) {
        // Handle different possible data structures
        dynamic data = responseBody['data'];

        List<Product> products = [];

        if (data is List) {
          // Direct array: {success: true, data: [...]}
          products = data.map((item) => Product.fromJson(item)).toList();
        } else if (data is Map<String, dynamic> && data['products'] is List) {
          // Nested array: {success: true, data: {products: [...]}}
          products = (data['products'] as List)
              .map((item) => Product.fromJson(item))
              .toList();
        } else if (data is Map<String, dynamic> && data['items'] is List) {
          // Alternative nested array: {success: true, data: {items: [...]}}
          products = (data['items'] as List)
              .map((item) => Product.fromJson(item))
              .toList();
        }

        _allProducts = products;
        _filteredProducts = List.from(_allProducts);

        // Filter data based on user role after loading
        filterDataBasedOnUserRole();

        notifyListeners();

        if (showSnack) {
          SnackBarHelper.showSuccessSnackBar('Products loaded successfully');
        }
      } else {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar(
              responseBody['message'] ?? 'Failed to load products');
        }
      }
    } catch (e) {
      if (kDebugMode) {
        print('Error in getAllProduct: $e');
      }
      if (showSnack) {
        SnackBarHelper.showErrorSnackBar('Failed to load products: $e');
      }
    }
    return _filteredProducts;
  }

  void filterProducts(String keyword) {
    if (keyword.isEmpty) {
      _filteredProducts = List.from(_allProducts);
    } else {
      final lowcase = keyword.toLowerCase();

      _filteredProducts = _allProducts.where((product) {
        final ProductNameContainsKeyword =
            (product.name ?? '').toLowerCase().contains(lowcase);
        final categoryNameContainsKeyword =
            product.proCategoryId?.name?.toLowerCase().contains(lowcase) ??
                false;
        final subCategoryNameContainsKeyword =
            product.proSubCategoryId?.name?.toLowerCase().contains(lowcase) ??
                false;
        final brandNameContainsKeyword =
            product.proBrandId?.name?.toLowerCase().contains(lowcase) ?? false;

        return ProductNameContainsKeyword ||
            categoryNameContainsKeyword ||
            subCategoryNameContainsKeyword ||
            brandNameContainsKeyword;
      }).toList();
    }
    notifyListeners();
  }

  Future<List<Coupon>> getAllCoupons({bool showSnack = false}) async {
    try {
      Response response = await service.getItems(endpointUrl: 'couponCodes');

      if (response.body == null) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('No response from server');
        }
        return _filteredCoupons;
      }

      dynamic responseBody = response.body;
      if (responseBody is String) {
        try {
          responseBody = json.decode(responseBody);
        } catch (e) {
          if (showSnack) {
            SnackBarHelper.showErrorSnackBar('Invalid response format');
          }
          return _filteredCoupons;
        }
      }

      if (responseBody is! Map<String, dynamic>) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('Invalid response format');
        }
        return _filteredCoupons;
      }

      ApiResponse<List<Coupon>> apiResponse = ApiResponse.fromJson(
        responseBody,
        (json) => (json as List).map((item) => Coupon.fromJson(item)).toList(),
      );

      _allCoupons = apiResponse.data ?? [];
      _filteredCoupons = List.from(_allCoupons);
      notifyListeners();

      if (showSnack && apiResponse.message.isNotEmpty) {
        SnackBarHelper.showSuccessSnackBar(apiResponse.message);
      }
    } catch (e) {
      if (kDebugMode) {
        print('Error in getAllCoupons: $e');
      }
      if (showSnack) {
        SnackBarHelper.showErrorSnackBar('Failed to load coupons');
      }
    }
    return _filteredCoupons;
  }

  void filterCoupons(String keyword) {
    if (keyword.isEmpty) {
      _filteredCoupons = List.from(_allCoupons);
    } else {
      final lowcase = keyword.toLowerCase();
      _filteredCoupons = _allCoupons.where((coupon) {
        return (coupon.couponCode ?? '').toLowerCase().contains(lowcase);
      }).toList();
    }
    notifyListeners();
  }

  Future<List<Poster>> getAllPosters({bool showSnack = false}) async {
    try {
      Response response = await service.getItems(endpointUrl: 'posters');

      if (response.body == null) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('No response from server');
        }
        return _filteredPosters;
      }

      dynamic responseBody = response.body;
      if (responseBody is String) {
        try {
          responseBody = json.decode(responseBody);
        } catch (e) {
          if (showSnack) {
            SnackBarHelper.showErrorSnackBar('Invalid response format');
          }
          return _filteredPosters;
        }
      }

      if (responseBody is! Map<String, dynamic>) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('Invalid response format');
        }
        return _filteredPosters;
      }

      ApiResponse<List<Poster>> apiResponse = ApiResponse.fromJson(
        responseBody,
        (json) => (json as List).map((item) => Poster.fromJson(item)).toList(),
      );

      _allPosters = apiResponse.data ?? [];
      _filteredPosters = List.from(_allPosters);
      notifyListeners();

      if (showSnack && apiResponse.message.isNotEmpty) {
        SnackBarHelper.showSuccessSnackBar(apiResponse.message);
      }
    } catch (e) {
      if (kDebugMode) {
        print('Error in getAllPosters: $e');
      }
      if (showSnack) {
        SnackBarHelper.showErrorSnackBar('Failed to load posters');
      }
    }
    return _filteredPosters;
  }

  void filterPosters(String keyword) {
    if (keyword.isEmpty) {
      _filteredPosters = List.from(_allPosters);
    } else {
      final lowcase = keyword.toLowerCase();
      _filteredPosters = _allPosters.where((poster) {
        return (poster.posterName ?? '').toLowerCase().contains(lowcase);
      }).toList();
    }
    notifyListeners();
  }

  Future<List<MyNotification>> getAllNotifications(
      {bool showSnack = false}) async {
    try {
      Response response =
          await service.getItems(endpointUrl: 'notification/all-notification');

      if (response.body == null) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('No response from server');
        }
        return _filteredNotifications;
      }

      dynamic responseBody = response.body;
      if (responseBody is String) {
        try {
          responseBody = json.decode(responseBody);
        } catch (e) {
          if (showSnack) {
            SnackBarHelper.showErrorSnackBar('Invalid response format');
          }
          return _filteredNotifications;
        }
      }

      if (responseBody is! Map<String, dynamic>) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('Invalid response format');
        }
        return _filteredNotifications;
      }

      ApiResponse<List<MyNotification>> apiResponse = ApiResponse.fromJson(
        responseBody,
        (json) => (json as List)
            .map((item) => MyNotification.fromJson(item))
            .toList(),
      );

      _allNotifications = apiResponse.data ?? [];
      _filteredNotifications = List.from(_allNotifications);
      notifyListeners();

      if (showSnack && apiResponse.message.isNotEmpty) {
        SnackBarHelper.showSuccessSnackBar(apiResponse.message);
      }
    } catch (e) {
      if (kDebugMode) {
        print('Error in getAllNotifications: $e');
      }
      if (showSnack) {
        SnackBarHelper.showErrorSnackBar('Failed to load notifications');
      }
    }
    return _filteredNotifications;
  }

  int calculateOrdersWithPaymentStatus(String? status) {
    int total = 0;

    if (status == null) {
      total = _allOrders.length;
    } else {
      for (Order order in _allOrders) {
        if (order.paymentStatus == status) {
          total += 1;
        }
      }
    }

    return total;
  }

  List<Order> get pendingPaymentVerification {
    return _allOrders
        .where((order) =>
            order.paymentMethod != 'cod' &&
            order.paymentStatus == 'pending' &&
            order.paymentProof?.imageUrl != null)
        .toList();
  }

  int get pendingVerificationCount {
    return pendingPaymentVerification.length;
  }

  void filterOrdersByPaymentStatus(String status) {
    if (status.isEmpty) {
      _filteredOrders = List.from(_allOrders);
    } else {
      _filteredOrders = _allOrders.where((order) {
        return (order.paymentStatus ?? '')
            .toLowerCase()
            .contains(status.toLowerCase());
      }).toList();
    }
    notifyListeners();
  }

  void filterNotifications(String keyword) {
    if (keyword.isEmpty) {
      _filteredNotifications = List.from(_allNotifications);
    } else {
      final lowcase = keyword.toLowerCase();
      _filteredNotifications = _allNotifications.where((notification) {
        return (notification.title ?? '').toLowerCase().contains(lowcase) ||
            (notification.description ?? '').toLowerCase().contains(lowcase);
      }).toList();
    }
    notifyListeners();
  }

  Future<List<Order>> getAllOrders({bool showSnack = false}) async {
    try {
      Response response = await service.getItems(endpointUrl: 'orders');

      if (response.body == null) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('No response from server');
        }
        return _filteredOrders;
      }

      dynamic responseBody = response.body;
      if (responseBody is String) {
        try {
          responseBody = json.decode(responseBody);
        } catch (e) {
          if (showSnack) {
            SnackBarHelper.showErrorSnackBar('Invalid response format');
          }
          return _filteredOrders;
        }
      }

      if (responseBody is! Map<String, dynamic>) {
        if (showSnack) {
          SnackBarHelper.showErrorSnackBar('Invalid response format');
        }
        return _filteredOrders;
      }

      ApiResponse<List<Order>> apiResponse = ApiResponse<List<Order>>.fromJson(
        responseBody,
        (json) => (json as List).map((item) => Order.fromJson(item)).toList(),
      );

      _allOrders = apiResponse.data ?? [];
      _filteredOrders = List.from(_allOrders);
      notifyListeners();

      if (showSnack && apiResponse.message.isNotEmpty) {
        SnackBarHelper.showSuccessSnackBar(apiResponse.message);
      }
    } catch (e) {
      if (kDebugMode) {
        print('Error in getAllOrders: $e');
      }
      if (showSnack) {
        SnackBarHelper.showErrorSnackBar('Failed to load orders');
      }
    }
    return _filteredOrders;
  }

  void filterOrders(String keyword) {
    if (keyword.isEmpty) {
      _filteredOrders = List.from(_allOrders);
    } else {
      final lowcase = keyword.toLowerCase();
      _filteredOrders = _allOrders.where((order) {
        bool nameMatches =
            (order.userID?.name ?? '').toLowerCase().contains(lowcase);
        bool statusMatches =
            (order.orderStatus ?? '').toLowerCase().contains(lowcase);
        return nameMatches || statusMatches;
      }).toList();
    }
    notifyListeners();
  }

  int calculateOrdersWithStatus(String? status) {
    int totalPrdt = 0;

    if (status == null) {
      totalPrdt = _allOrders.length;
    } else {
      for (Order order in _allOrders) {
        if (order.orderStatus == status) {
          totalPrdt += 1;
        }
      }
    }

    return totalPrdt;
  }

  void filterProductsByQuantity(String productQfilter) {
    if (productQfilter == 'All Product') {
      _filteredProducts = List.from(_allProducts);
    } else if (productQfilter == 'Out Of Stack') {
      _filteredProducts = _allProducts.where((product) {
        return product.quantity != null && product.quantity == 0;
      }).toList();
    } else if (productQfilter == 'Limited Stack') {
      _filteredProducts = _allProducts.where((product) {
        return product.quantity != null && product.quantity == 1;
      }).toList();
    } else if (productQfilter == 'Other Stack') {
      _filteredProducts = _allProducts.where((product) {
        return product.quantity != null &&
            product.quantity != 1 &&
            product.quantity != 0;
      }).toList();
    } else {
      _filteredProducts = List.from(_allProducts);
    }
    notifyListeners();
  }

  int calculateProductWithQuantity(int? quantity) {
    int totalPrdt = 0;

    if (quantity == null) {
      totalPrdt = _allProducts.length;
    } else {
      for (Product product in _allProducts) {
        if (product.quantity != null && product.quantity == quantity) {
          totalPrdt += 1;
        }
      }
    }

    return totalPrdt;
  }
}

========== FILE: lib/core/routes/app_pages.dart ==========

import 'package:admin_panal_start/screens/auth/login_screen.dart';
import 'package:get/get_navigation/src/routes/get_route.dart';
import '../../screens/main/main_screen.dart';

class AppPages {
  static const LOGIN = '/login';
  static const MAIN = '/main';

  static final routes = [
    GetPage(
      name: LOGIN,
      page: () => LoginScreen(),
    ),
    GetPage(
      name: MAIN,
      page: () => MainScreen(),
    ),
  ];
}

========== FILE: lib/main.dart ==========

import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:provider/provider.dart';
import 'core/data/data_provider.dart';
import 'core/routes/app_pages.dart';
import 'services/admin_auth_service.dart'; // Add this import
import 'services/http_services.dart'; // Add this import
import 'screens/auth/login_screen.dart';
import 'screens/brands/provider/brand_provider.dart';
import 'screens/category/provider/category_provider.dart';
import 'screens/coupon_code/provider/coupon_code_provider.dart';
import 'screens/dashboard/provider/dash_board_provider.dart';
import 'screens/main/main_screen.dart';
import 'screens/main/provider/main_screen_provider.dart';
import 'screens/notification/provider/notification_provider.dart';
import 'screens/order/provider/order_provider.dart';
import 'screens/posters/provider/poster_provider.dart';
import 'screens/sub_category/provider/sub_category_provider.dart';
import 'screens/variants/provider/variant_provider.dart';
import 'screens/variants_type/provider/variant_type_provider.dart';
import 'screens/ratings/provider/rating_provider.dart';
import 'utility/constants.dart';

void main() {
  WidgetsFlutterBinding.ensureInitialized();
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MultiProvider(
      providers: [
        ChangeNotifierProvider(create: (context) => DataProvider()),
        ChangeNotifierProvider(create: (context) => MainScreenProvider()),
        ChangeNotifierProvider(
          create: (context) => CategoryProvider(
            Provider.of<DataProvider>(context, listen: false),
          ),
        ),
        ChangeNotifierProvider(
          create: (context) => SubCategoryProvider(
            Provider.of<DataProvider>(context, listen: false),
          ),
        ),
        ChangeNotifierProvider(
          create: (context) => BrandProvider(
            Provider.of<DataProvider>(context, listen: false),
          ),
        ),
        ChangeNotifierProvider(
          create: (context) => VariantTypeProvider(
            Provider.of<DataProvider>(context, listen: false),
          ),
        ),
        ChangeNotifierProvider(
          create: (context) => VariantProvider(
            Provider.of<DataProvider>(context, listen: false),
          ),
        ),
        ChangeNotifierProvider(
          create: (context) => DashBoardProvider(
            Provider.of<DataProvider>(context, listen: false),
          ),
        ),
        ChangeNotifierProvider(
          create: (context) => CouponCodeProvider(
            Provider.of<DataProvider>(context, listen: false),
          ),
        ),
        ChangeNotifierProvider(
          create: (context) => PosterProvider(
            Provider.of<DataProvider>(context, listen: false),
          ),
        ),
        ChangeNotifierProvider(
          create: (context) => OrderProvider(
            Provider.of<DataProvider>(context, listen: false),
          ),
        ),
        ChangeNotifierProvider(create: (context) => RatingProvider()),
        ChangeNotifierProvider(
          create: (context) => NotificationProvider(
            Provider.of<DataProvider>(context, listen: false),
          ),
        ),
      ],
      child: GetMaterialApp(
        debugShowCheckedModeBanner: false,
        title: 'Flutter Admin Panel',
        theme: ThemeData.dark().copyWith(
          scaffoldBackgroundColor: bgColor,
          textTheme: GoogleFonts.poppinsTextTheme(
            Theme.of(context).textTheme,
          ).apply(bodyColor: Colors.white),
          canvasColor: secondaryColor,
        ),
        home: LoginScreen(),
        initialRoute: AppPages.LOGIN,
        unknownRoute: GetPage(name: '/notFound', page: () => LoginScreen()),
        defaultTransition: Transition.cupertino,
        getPages: AppPages.routes,
        initialBinding: BindingsBuilder(() {
          Get.lazyPut(() => HttpService());
          Get.put(
              AdminAuthService()); // This makes AdminAuthService available via Get.find()
        }),
      ),
    );
  }
}

========== FILE: lib/models/admin_user.dart ==========

class AdminUser {
  String? sId;
  String? username;
  String? name;
  String? email;
  String? clearanceLevel;
  String? createdBy; // ID of admin who created this user
  String? createdAt;
  String? updatedAt;

  AdminUser({
    this.sId,
    this.username,
    this.name,
    this.email,
    this.clearanceLevel,
    this.createdBy,
    this.createdAt,
    this.updatedAt,
  });

  AdminUser.fromJson(Map<String, dynamic> json) {
    sId = json['_id'];
    username = json['username'];
    name = json['name'];
    email = json['email'];
    clearanceLevel = json['clearanceLevel'];
    createdBy = json['createdBy'];
    createdAt = json['createdAt'];
    updatedAt = json['updatedAt'];
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['_id'] = sId;
    data['username'] = username;
    data['name'] = name;
    data['email'] = email;
    data['clearanceLevel'] = clearanceLevel;
    data['createdBy'] = createdBy;
    data['createdAt'] = createdAt;
    data['updatedAt'] = updatedAt;
    return data;
  }

  bool get isSuperAdmin => clearanceLevel == 'super_admin';
  bool get isAdmin => clearanceLevel == 'admin';
}

========== FILE: lib/models/api_response.dart ==========

import 'package:flutter/foundation.dart';

class ApiResponse<T> {
  final bool success;
  final String message;
  final T? data;

  ApiResponse({required this.success, required this.message, this.data});

  factory ApiResponse.fromJson(
    Map<String, dynamic> json,
    T Function(Object? json)? fromJsonT,
  ) {
    try {
      return ApiResponse(
        success: json['success'] as bool? ?? false,
        message: json['message'] as String? ?? 'No message',
        data: (json['data'] != null && fromJsonT != null)
            ? fromJsonT(json['data'])
            : null,
      );
    } catch (e) {
      if (kDebugMode) {
        print('Error parsing ApiResponse: $e');
      }
      return ApiResponse(
        success: false,
        message: 'Error parsing response: $e',
        data: null,
      );
    }
  }
}

========== FILE: lib/models/brand.dart ==========

class Brand {
  String? sId;
  String? name;
  SubcategoryId? subcategoryId;
  String? createdBy; // Add this field
  String? createdAt;
  String? updatedAt;

  Brand(
      {this.sId,
      this.name,
      this.subcategoryId,
      this.createdBy, // Add this
      this.createdAt,
      this.updatedAt});

  Brand.fromJson(Map<String, dynamic> json) {
    sId = json['_id'];
    name = json['name'];
    subcategoryId = json['subcategoryId'] != null
        ? SubcategoryId.fromJson(json['subcategoryId'])
        : null;
    createdBy = json['createdBy']; // Add this
    createdAt = json['createdAt'];
    updatedAt = json['updatedAt'];
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['_id'] = sId;
    data['name'] = name;
    if (subcategoryId != null) {
      data['subcategoryId'] = subcategoryId!.toJson();
    }
    data['createdBy'] = createdBy; // Add this
    data['createdAt'] = createdAt;
    data['updatedAt'] = updatedAt;
    return data;
  }
}

class SubcategoryId {
  String? sId;
  String? name;
  String? categoryId;
  String? createdBy; // Add this field
  String? createdAt;
  String? updatedAt;

  SubcategoryId(
      {this.sId,
      this.name,
      this.categoryId,
      this.createdBy, // Add this
      this.createdAt,
      this.updatedAt});

  SubcategoryId.fromJson(Map<String, dynamic> json) {
    sId = json['_id'];
    name = json['name'];
    categoryId = json['categoryId'];
    createdBy = json['createdBy']; // Add this
    createdAt = json['createdAt'];
    updatedAt = json['updatedAt'];
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['_id'] = sId;
    data['name'] = name;
    data['categoryId'] = categoryId;
    data['createdBy'] = createdBy; // Add this
    data['createdAt'] = createdAt;
    data['updatedAt'] = updatedAt;
    return data;
  }
}

========== FILE: lib/models/category.dart ==========

class Category {
  String? sId;
  String? name;
  String? image;
  String? createdBy; // Add this field
  String? createdAt;
  String? updatedAt;

  Category(
      {this.sId,
      this.name,
      this.image,
      this.createdBy,
      this.createdAt,
      this.updatedAt});

  Category.fromJson(Map<String, dynamic> json) {
    sId = json['_id'];
    name = json['name'];
    image = json['image'];
    createdBy = json['createdBy']; // Add this
    createdAt = json['createdAt'];
    updatedAt = json['updatedAt'];
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['_id'] = sId;
    data['name'] = name;
    data['image'] = image;
    data['createdBy'] = createdBy; // Add this
    data['createdAt'] = createdAt;
    data['updatedAt'] = updatedAt;
    return data;
  }
}

========== FILE: lib/models/coupon.dart ==========

class Coupon {
  String? sId;
  String? couponCode;
  String? discountType;
  double? discountAmount;
  double? minimumPurchaseAmount;
  String? endDate;
  String? status;
  CatRef? applicableCategory;
  CatRef? applicableSubCategory;
  CatRef? applicableProduct;
  String? createdBy; // Add this field
  String? createdAt;
  String? updatedAt;
  int? iV;

  Coupon(
      {this.sId,
      this.couponCode,
      this.discountType,
      this.discountAmount,
      this.minimumPurchaseAmount,
      this.endDate,
      this.status,
      this.applicableCategory,
      this.applicableSubCategory,
      this.applicableProduct,
      this.createdBy, // Add this
      this.createdAt,
      this.updatedAt,
      this.iV});

  Coupon.fromJson(Map<String, dynamic> json) {
    sId = json['_id'];
    couponCode = json['couponCode'];
    discountType = json['discountType'];
    discountAmount = json['discountAmount']?.toDouble();
    minimumPurchaseAmount = json['minimumPurchaseAmount']?.toDouble();
    endDate = json['endDate'];
    status = json['status'];
    applicableCategory = json['applicableCategory'] != null
        ? CatRef.fromJson(json['applicableCategory'])
        : null;
    applicableSubCategory = json['applicableSubCategory'] != null
        ? CatRef.fromJson(json['applicableSubCategory'])
        : null;
    applicableProduct = json['applicableProduct'] != null
        ? CatRef.fromJson(json['applicableProduct'])
        : null;
    createdBy = json['createdBy']; // Add this
    createdAt = json['createdAt'];
    updatedAt = json['updatedAt'];
    iV = json['__v'];
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['_id'] = sId;
    data['couponCode'] = couponCode;
    data['discountType'] = discountType;
    data['discountAmount'] = discountAmount;
    data['minimumPurchaseAmount'] = minimumPurchaseAmount;
    data['endDate'] = endDate;
    data['status'] = status;
    if (applicableCategory != null) {
      data['applicableCategory'] = applicableCategory!.toJson();
    }
    if (applicableSubCategory != null) {
      data['applicableSubCategory'] = applicableSubCategory!.toJson();
    }
    if (applicableProduct != null) {
      data['applicableProduct'] = applicableProduct!.toJson();
    }
    data['createdBy'] = createdBy; // Add this
    data['createdAt'] = createdAt;
    data['updatedAt'] = updatedAt;
    data['__v'] = iV;
    return data;
  }
}

class CatRef {
  String? sId;
  String? name;
  String? createdBy; // Add this field

  CatRef({this.sId, this.name, this.createdBy}); // Add this

  CatRef.fromJson(Map<String, dynamic> json) {
    sId = json['_id'];
    name = json['name'];
    createdBy = json['createdBy']; // Add this
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['_id'] = sId;
    data['name'] = name;
    data['createdBy'] = createdBy; // Add this
    return data;
  }
}

========== FILE: lib/models/my_notification.dart ==========

class MyNotification {
  String? sId;
  String? notificationId;
  String? title;
  String? description;
  String? imageUrl;
  String? createdAt;
  String? updatedAt;
  int? iV;

  MyNotification(
      {this.sId,
      this.notificationId,
      this.title,
      this.description,
      this.imageUrl,
      this.createdAt,
      this.updatedAt,
      this.iV});

  MyNotification.fromJson(Map<String, dynamic> json) {
    sId = json['_id'];
    notificationId = json['notificationId'];
    title = json['title'];
    description = json['description'];
    imageUrl = json['imageUrl'];
    createdAt = json['createdAt'];
    updatedAt = json['updatedAt'];
    iV = json['__v'];
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['_id'] = sId;
    data['notificationId'] = notificationId;
    data['title'] = title;
    data['description'] = description;
    data['imageUrl'] = imageUrl;
    data['createdAt'] = createdAt;
    data['updatedAt'] = updatedAt;
    data['__v'] = iV;
    return data;
  }
}

========== FILE: lib/models/notification_result.dart ==========

class NotificationResult {
  String? platform;
  int? successDelivery;
  int? failedDelivery;
  int? erroredDelivery;
  int? openedNotification;

  NotificationResult(
      {this.platform,
      this.successDelivery,
      this.failedDelivery,
      this.erroredDelivery,
      this.openedNotification});

  NotificationResult.fromJson(Map<String, dynamic> json) {
    platform = json['platform'];
    successDelivery = json['success_delivery'];
    failedDelivery = json['failed_delivery'];
    erroredDelivery = json['errored_delivery'];
    openedNotification = json['opened_notification'];
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['platform'] = platform;
    data['success_delivery'] = successDelivery;
    data['failed_delivery'] = failedDelivery;
    data['errored_delivery'] = erroredDelivery;
    data['opened_notification'] = openedNotification;
    return data;
  }
}

========== FILE: lib/models/order.dart ==========

class Order {
  ShippingAddress? shippingAddress;
  OrderTotal? orderTotal;
  String? sId;
  UserID? userID;
  String? orderStatus;
  List<Items>? items;
  double? totalPrice;
  String? paymentMethod;
  String? paymentStatus;
  PaymentProof? paymentProof;
  CouponCode? couponCode;
  String? trackingUrl;
  String? orderDate;
  int? iV;

  Order({
    this.shippingAddress,
    this.orderTotal,
    this.sId,
    this.userID,
    this.orderStatus,
    this.items,
    this.totalPrice,
    this.paymentMethod,
    this.paymentStatus,
    this.paymentProof,
    this.couponCode,
    this.trackingUrl,
    this.orderDate,
    this.iV,
  });

  Order.fromJson(Map<String, dynamic> json) {
    shippingAddress = json['shippingAddress'] != null
        ? ShippingAddress.fromJson(json['shippingAddress'])
        : null;
    orderTotal = json['orderTotal'] != null
        ? OrderTotal.fromJson(json['orderTotal'])
        : null;
    sId = json['_id'];
    userID = json['userID'] != null ? UserID.fromJson(json['userID']) : null;
    orderStatus = json['orderStatus'];
    paymentStatus = json['paymentStatus'];
    paymentProof = json['paymentProof'] != null
        ? PaymentProof.fromJson(json['paymentProof'])
        : null;
    if (json['items'] != null) {
      items = <Items>[];
      json['items'].forEach((v) {
        items!.add(Items.fromJson(v));
      });
    }
    totalPrice = json['totalPrice']?.toDouble();
    paymentMethod = json['paymentMethod'];
    couponCode = json['couponCode'] != null
        ? CouponCode.fromJson(json['couponCode'])
        : null;
    trackingUrl = json['trackingUrl'];
    orderDate = json['orderDate'];
    iV = json['__v'];
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    if (shippingAddress != null) {
      data['shippingAddress'] = shippingAddress!.toJson();
    }
    if (orderTotal != null) {
      data['orderTotal'] = orderTotal!.toJson();
    }
    data['_id'] = sId;
    if (userID != null) {
      data['userID'] = userID!.toJson();
    }
    data['orderStatus'] = orderStatus;
    data['paymentStatus'] = paymentStatus;
    if (paymentProof != null) {
      data['paymentProof'] = paymentProof!.toJson();
    }
    if (items != null) {
      data['items'] = items!.map((v) => v.toJson()).toList();
    }
    data['totalPrice'] = totalPrice;
    data['paymentMethod'] = paymentMethod;
    if (couponCode != null) {
      data['couponCode'] = couponCode!.toJson();
    }
    data['trackingUrl'] = trackingUrl;
    data['orderDate'] = orderDate;
    data['__v'] = iV;
    return data;
  }
}

class ShippingAddress {
  String? phone;
  String? street;
  String? city;
  String? state;
  String? postalCode;
  String? country;

  ShippingAddress({
    this.phone,
    this.street,
    this.city,
    this.state,
    this.postalCode,
    this.country,
  });

  ShippingAddress.fromJson(Map<String, dynamic> json) {
    phone = json['phone'];
    street = json['street'];
    city = json['city'];
    state = json['state'];
    postalCode = json['postalCode'];
    country = json['country'];
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['phone'] = phone;
    data['street'] = street;
    data['city'] = city;
    data['state'] = state;
    data['postalCode'] = postalCode;
    data['country'] = country;
    return data;
  }
}

class OrderTotal {
  double? subtotal;
  double? discount;
  double? total;

  OrderTotal({this.subtotal, this.discount, this.total});

  OrderTotal.fromJson(Map<String, dynamic> json) {
    subtotal = json['subtotal']?.toDouble();
    discount = json['discount']?.toDouble();
    total = json['total']?.toDouble();
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['subtotal'] = subtotal;
    data['discount'] = discount;
    data['total'] = total;
    return data;
  }
}

class UserID {
  String? sId;
  String? name;

  UserID({this.sId, this.name});

  UserID.fromJson(Map<String, dynamic> json) {
    sId = json['_id'];
    name = json['name'];
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['_id'] = sId;
    data['name'] = name;
    return data;
  }
}

class Items {
  String? productID;
  String? productName;
  int? quantity;
  double? price;
  String? variant;
  String? sId;

  Items({
    this.productID,
    this.productName,
    this.quantity,
    this.price,
    this.variant,
    this.sId,
  });

  Items.fromJson(Map<String, dynamic> json) {
    productID = json['productID'];
    productName = json['productName'];
    quantity = json['quantity'];
    price = json['price']?.toDouble();
    variant = json['variant'];
    sId = json['_id'];
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['productID'] = productID;
    data['productName'] = productName;
    data['quantity'] = quantity;
    data['price'] = price;
    data['variant'] = variant;
    data['_id'] = sId;
    return data;
  }
}

class CouponCode {
  String? sId;
  String? couponCode;
  String? discountType;
  int? discountAmount;

  CouponCode({
    this.sId,
    this.couponCode,
    this.discountType,
    this.discountAmount,
  });

  CouponCode.fromJson(Map<String, dynamic> json) {
    sId = json['_id'];
    couponCode = json['couponCode'];
    discountType = json['discountType'];
    discountAmount = json['discountAmount'];
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['_id'] = sId;
    data['couponCode'] = couponCode;
    data['discountType'] = discountType;
    data['discountAmount'] = discountAmount;
    return data;
  }
}

class PaymentProof {
  String? imageUrl;
  String? uploadedAt;
  bool? verified;
  String? verifiedAt;

  PaymentProof({
    this.imageUrl,
    this.uploadedAt,
    this.verified,
    this.verifiedAt,
  });

  PaymentProof.fromJson(Map<String, dynamic> json) {
    imageUrl = json['imageUrl'];
    uploadedAt = json['uploadedAt'];
    verified = json['verified'];
    verifiedAt = json['verifiedAt'];
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['imageUrl'] = imageUrl;
    data['uploadedAt'] = uploadedAt;
    data['verified'] = verified;
    data['verifiedAt'] = verifiedAt;
    return data;
  }
}

========== FILE: lib/models/poster.dart ==========

class Poster {
  String? sId;
  String? posterName;
  String? imageUrl;
  String? createdBy; // Add this field
  String? createdAt;
  String? updatedAt;
  int? iV;

  Poster({
    this.sId,
    this.posterName,
    this.imageUrl,
    this.createdBy, // Add this
    this.createdAt,
    this.updatedAt,
    this.iV,
  });

  Poster.fromJson(Map<String, dynamic> json) {
    sId = json['_id'];
    posterName = json['posterName'];
    imageUrl = json['imageUrl'];
    createdBy = json['createdBy']; // Add this
    createdAt = json['createdAt'];
    updatedAt = json['updatedAt'];
    iV = json['__v'];
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = Map<String, dynamic>();
    data['_id'] = this.sId;
    data['posterName'] = this.posterName;
    data['imageUrl'] = this.imageUrl;
    data['createdBy'] = this.createdBy; // Add this
    data['createdAt'] = this.createdAt;
    data['updatedAt'] = this.updatedAt;
    data['__v'] = this.iV;
    return data;
  }
}

========== FILE: lib/models/product.dart ==========

import 'package:flutter/foundation.dart';

class Product {
  String? sId;
  String? name;
  String? description;
  int? quantity;
  double? price;
  double? offerPrice;
  ProRef? proCategoryId;
  ProRef? proSubCategoryId;
  ProRef? proBrandId;
  ProTypeRef? proVariantTypeId;
  List<String>? proVariantId;
  List<Images>? images;
  dynamic createdBy; // Changed from String? to dynamic
  String? createdAt;
  String? updatedAt;
  int? iV;

  Product(
      {this.sId,
      this.name,
      this.description,
      this.quantity,
      this.price,
      this.offerPrice,
      this.proCategoryId,
      this.proSubCategoryId,
      this.proBrandId,
      this.proVariantTypeId,
      this.proVariantId,
      this.images,
      this.createdBy, // Changed from String? to dynamic
      this.createdAt,
      this.updatedAt,
      this.iV});

  Product.fromJson(Map<String, dynamic> json) {
    try {
      sId = json['_id']?.toString();
      name = json['name']?.toString();
      description = json['description']?.toString();
      quantity = _parseInt(json['quantity']);
      price = _parseDouble(json['price']);
      offerPrice = _parseDouble(json['offerPrice']);

      // Handle category with null safety
      if (json['proCategoryId'] != null) {
        if (json['proCategoryId'] is Map) {
          proCategoryId = ProRef.fromJson(_convertMap(json['proCategoryId']));
        } else if (json['proCategoryId'] is String) {
          proCategoryId = ProRef(sId: json['proCategoryId']);
        }
      }

      // Handle subcategory with null safety
      if (json['proSubCategoryId'] != null) {
        if (json['proSubCategoryId'] is Map) {
          proSubCategoryId =
              ProRef.fromJson(_convertMap(json['proSubCategoryId']));
        } else if (json['proSubCategoryId'] is String) {
          proSubCategoryId = ProRef(sId: json['proSubCategoryId']);
        }
      }

      // Handle brand with null safety
      if (json['proBrandId'] != null) {
        if (json['proBrandId'] is Map) {
          proBrandId = ProRef.fromJson(_convertMap(json['proBrandId']));
        } else if (json['proBrandId'] is String) {
          proBrandId = ProRef(sId: json['proBrandId']);
        }
      }

      // Handle variant type with null safety
      if (json['proVariantTypeId'] != null) {
        if (json['proVariantTypeId'] is Map) {
          proVariantTypeId =
              ProTypeRef.fromJson(_convertMap(json['proVariantTypeId']));
        } else if (json['proVariantTypeId'] is String) {
          proVariantTypeId = ProTypeRef(sId: json['proVariantTypeId']);
        }
      }

      // Handle variant IDs
      if (json['proVariantId'] != null) {
        if (json['proVariantId'] is List) {
          proVariantId = (json['proVariantId'] as List)
              .map((item) => item.toString())
              .toList();
        } else if (json['proVariantId'] is String) {
          proVariantId = [json['proVariantId']];
        }
      }

      // Handle createdBy - it can be a Map or String
      if (json['createdBy'] != null) {
        if (json['createdBy'] is Map) {
          createdBy = _convertMap(json['createdBy']);
        } else if (json['createdBy'] is String) {
          createdBy = json['createdBy'];
        }
      }

      createdAt = json['createdAt']?.toString();
      updatedAt = json['updatedAt']?.toString();
      iV = _parseInt(json['__v']);

      // Handle images
      if (json['images'] != null && json['images'] is List) {
        images = <Images>[];
        for (var image in json['images']) {
          if (image is Map) {
            images!.add(Images.fromJson(_convertMap(image)));
          }
        }
      }
    } catch (e) {
      if (kDebugMode) {
        print('Error parsing Product: $e');
        print('Problematic JSON: $json');
      }
    }
  }

  // Convert Map<dynamic, dynamic> to Map<String, dynamic>
  Map<String, dynamic> _convertMap(dynamic map) {
    if (map == null) return {};

    if (map is Map<String, dynamic>) {
      return map;
    }

    if (map is Map<dynamic, dynamic>) {
      return map.cast<String, dynamic>();
    }

    return {};
  }

  // Helper methods for safe parsing
  int _parseInt(dynamic value) {
    if (value == null) return 0;
    if (value is int) return value;
    if (value is String) return int.tryParse(value) ?? 0;
    if (value is double) return value.toInt();
    return 0;
  }

  double _parseDouble(dynamic value) {
    if (value == null) return 0.0;
    if (value is double) return value;
    if (value is int) return value.toDouble();
    if (value is String) return double.tryParse(value) ?? 0.0;
    return 0.0;
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['_id'] = sId;
    data['name'] = name;
    data['description'] = description;
    data['quantity'] = quantity;
    data['price'] = price;
    data['offerPrice'] = offerPrice;
    if (proCategoryId != null) {
      data['proCategoryId'] = proCategoryId!.toJson();
    }
    if (proSubCategoryId != null) {
      data['proSubCategoryId'] = proSubCategoryId!.toJson();
    }
    if (proBrandId != null) {
      data['proBrandId'] = proBrandId!.toJson();
    }
    if (proVariantTypeId != null) {
      data['proVariantTypeId'] = proVariantTypeId!.toJson();
    }
    data['proVariantId'] = proVariantId;

    // Handle createdBy for serialization
    if (createdBy != null) {
      if (createdBy is Map<String, dynamic>) {
        data['createdBy'] = createdBy;
      } else if (createdBy is String) {
        data['createdBy'] = createdBy;
      }
    }

    if (images != null) {
      data['images'] = images!.map((v) => v.toJson()).toList();
    }
    data['createdAt'] = createdAt;
    data['updatedAt'] = updatedAt;
    data['__v'] = iV;
    return data;
  }

  // Helper method to get createdBy as string (username or name)
  String? get createdByName {
    if (createdBy == null) return null;
    if (createdBy is String) return createdBy as String;
    if (createdBy is Map<String, dynamic>) {
      return createdBy['name']?.toString() ?? createdBy['username']?.toString();
    }
    return null;
  }

  // Helper method to get createdBy user ID
  String? get createdById {
    if (createdBy == null) return null;
    if (createdBy is Map<String, dynamic>) {
      return createdBy['_id']?.toString();
    }
    return null;
  }
}

class ProRef {
  String? sId;
  String? name;
  String? createdBy;

  ProRef({this.sId, this.name, this.createdBy});

  ProRef.fromJson(Map<String, dynamic> json) {
    try {
      sId = json['_id']?.toString();
      name = json['name']?.toString();
      createdBy = json['createdBy']?.toString();
    } catch (e) {
      if (kDebugMode) {
        print('Error parsing ProRef: $e');
      }
    }
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['_id'] = sId;
    data['name'] = name;
    data['createdBy'] = createdBy;
    return data;
  }
}

class ProTypeRef {
  String? sId;
  String? type;
  String? createdBy;

  ProTypeRef({this.sId, this.type, this.createdBy});

  ProTypeRef.fromJson(Map<String, dynamic> json) {
    try {
      sId = json['_id']?.toString();
      type = json['type']?.toString();
      createdBy = json['createdBy']?.toString();
    } catch (e) {
      if (kDebugMode) {
        print('Error parsing ProTypeRef: $e');
      }
    }
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['_id'] = sId;
    data['type'] = type;
    data['createdBy'] = createdBy;
    return data;
  }
}

class Images {
  int? image;
  String? url;
  String? sId;

  Images({this.image, this.url, this.sId});

  Images.fromJson(Map<String, dynamic> json) {
    try {
      image = _parseInt(json['image']);
      url = json['url']?.toString();
      sId = json['_id']?.toString();
    } catch (e) {
      if (kDebugMode) {
        print('Error parsing Images: $e');
      }
    }
  }

  int _parseInt(dynamic value) {
    if (value == null) return 0;
    if (value is int) return value;
    if (value is String) return int.tryParse(value) ?? 0;
    if (value is double) return value.toInt();
    return 0;
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['image'] = image;
    data['url'] = url;
    data['_id'] = sId;
    return data;
  }
}

========== FILE: lib/models/product_summery_info.dart ==========

import 'dart:ui';

class ProductSummeryInfo {
  final String? svgSrc, title;
  final int? productsCount;
  final double? percentage;
  final Color? color;

  ProductSummeryInfo({
    this.svgSrc,
    this.title,
    this.productsCount,
    this.percentage,
    this.color,
  });
}
========== FILE: lib/models/rating.dart ==========

class Rating {
  String? sId;
  String? productId;
  String? userId;
  String? userName;
  int? rating;
  String? review;
  bool? verifiedPurchase;
  String? createdAt;
  String? updatedAt;

  Rating({
    this.sId,
    this.productId,
    this.userId,
    this.userName,
    this.rating,
    this.review,
    this.verifiedPurchase,
    this.createdAt,
    this.updatedAt,
  });

  Rating.fromJson(Map<String, dynamic> json) {
    sId = json['_id'];
    productId = json['productId'];
    userId = json['userId'];
    userName = json['userName'];
    rating = json['rating'];
    review = json['review'];
    verifiedPurchase = json['verifiedPurchase'];
    createdAt = json['createdAt'];
    updatedAt = json['updatedAt'];
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['_id'] = sId;
    data['productId'] = productId;
    data['userId'] = userId;
    data['userName'] = userName;
    data['rating'] = rating;
    data['review'] = review;
    data['verifiedPurchase'] = verifiedPurchase;
    data['createdAt'] = createdAt;
    data['updatedAt'] = updatedAt;
    return data;
  }
}

class RatingStats {
  double? averageRating;
  int? ratingCount;
  Map<String, int>? distribution;

  RatingStats({
    this.averageRating,
    this.ratingCount,
    this.distribution,
  });

  RatingStats.fromJson(Map<String, dynamic> json) {
    averageRating = json['averageRating']?.toDouble();
    ratingCount = json['ratingCount'];
    distribution = json['distribution'] != null
        ? Map<String, int>.from(json['distribution'])
        : null;
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = <String, dynamic>{};
    data['averageRating'] = averageRating;
    data['ratingCount'] = ratingCount;
    data['distribution'] = distribution;
    return data;
  }
}

========== FILE: lib/models/sub_category.dart ==========

class SubCategory {
  String? sId;
  String? name;
  CategoryId? categoryId;
  String? createdBy; // Add this field
  String? createdAt;
  String? updatedAt;

  SubCategory(
      {this.sId,
      this.name,
      this.categoryId,
      this.createdBy, // Add this
      this.createdAt,
      this.updatedAt});

  SubCategory.fromJson(Map<String, dynamic> json) {
    sId = json['_id'];
    name = json['name'];
    categoryId = json['categoryId'] != null
        ? CategoryId.fromJson(json['categoryId'])
        : null;
    createdBy = json['createdBy']; // Add this
    createdAt = json['createdAt'];
    updatedAt = json['updatedAt'];
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = Map<String, dynamic>();
    data['_id'] = sId;
    data['name'] = name;
    if (categoryId != null) {
      data['categoryId'] = categoryId!.toJson();
    }
    data['createdBy'] = createdBy; // Add this
    data['createdAt'] = createdAt;
    data['updatedAt'] = updatedAt;
    return data;
  }
}

class CategoryId {
  String? sId;
  String? name;
  String? createdBy; // Add this field

  CategoryId({this.sId, this.name, this.createdBy}); // Add this

  CategoryId.fromJson(Map<String, dynamic> json) {
    sId = json['_id'];
    name = json['name'];
    createdBy = json['createdBy']; // Add this
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = Map<String, dynamic>();
    data['_id'] = sId;
    data['name'] = name;
    data['createdBy'] = createdBy; // Add this
    return data;
  }
}

========== FILE: lib/models/variant.dart ==========

class Variant {
  String? sId;
  String? name;
  VariantTypeId? variantTypeId;
  String? createdBy; // Add this field
  String? createdAt;
  String? updatedAt;

  Variant(
      {this.sId,
      this.name,
      this.variantTypeId,
      this.createdBy, // Add this
      this.createdAt,
      this.updatedAt});

  Variant.fromJson(Map<String, dynamic> json) {
    sId = json['_id'];
    name = json['name'];
    variantTypeId = json['variantTypeId'] != null
        ? VariantTypeId.fromJson(json['variantTypeId'])
        : null;
    createdBy = json['createdBy']; // Add this
    createdAt = json['createdAt'];
    updatedAt = json['updatedAt'];
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = Map<String, dynamic>();
    data['_id'] = this.sId;
    data['name'] = this.name;
    if (this.variantTypeId != null) {
      data['variantTypeId'] = this.variantTypeId!.toJson();
    }
    data['createdBy'] = this.createdBy; // Add this
    data['createdAt'] = this.createdAt;
    data['updatedAt'] = this.updatedAt;
    return data;
  }
}

class VariantTypeId {
  String? sId;
  String? name;
  String? type;
  String? createdBy; // Add this field
  String? createdAt;
  String? updatedAt;

  VariantTypeId(
      {this.sId,
      this.name,
      this.type,
      this.createdBy, // Add this
      this.createdAt,
      this.updatedAt});

  VariantTypeId.fromJson(Map<String, dynamic> json) {
    sId = json['_id'];
    name = json['name'];
    type = json['type'];
    createdBy = json['createdBy']; // Add this
    createdAt = json['createdAt'];
    updatedAt = json['updatedAt'];
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = Map<String, dynamic>();
    data['_id'] = this.sId;
    data['name'] = this.name;
    data['type'] = this.type;
    data['createdBy'] = this.createdBy; // Add this
    data['createdAt'] = this.createdAt;
    data['updatedAt'] = this.updatedAt;
    return data;
  }
}

========== FILE: lib/models/variant_type.dart ==========

class VariantType {
  String? name;
  String? type;
  String? sId;
  String? createdBy; // Add this field
  String? createdAt;
  String? updatedAt;

  VariantType({
    this.name,
    this.type,
    this.sId,
    this.createdBy, // Add this
    this.createdAt,
    this.updatedAt,
  });

  VariantType.fromJson(Map<String, dynamic> json) {
    name = json['name'];
    type = json['type'];
    sId = json['_id'];
    createdBy = json['createdBy']; // Add this
    createdAt = json['createdAt'];
    updatedAt = json['updatedAt'];
  }

  Map<String, dynamic> toJson() {
    final Map<String, dynamic> data = Map<String, dynamic>();
    data['name'] = this.name;
    data['type'] = this.type;
    data['_id'] = this.sId;
    data['createdBy'] = this.createdBy; // Add this
    data['createdAt'] = this.createdAt;
    data['updatedAt'] = this.updatedAt;
    return data;
  }
}

========== FILE: lib/res/assets_res.dart ==========

class AssetsRes {
  AssetsRes._();

  static const String PROJECT_NAME = 'admin';
  static const String PROJECT_VERSION = '1.0.0+1';
}

========== FILE: lib/screens/auth/login_screen.dart ==========

import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:provider/provider.dart';
import '../../../services/admin_auth_service.dart';
import '../../../utility/constants.dart';
import '../../../widgets/custom_text_field.dart';

class LoginScreen extends StatelessWidget {
  final TextEditingController usernameCtrl = TextEditingController();
  final TextEditingController passwordCtrl = TextEditingController();
  final RxBool isLoading = false.obs;

  @override
  Widget build(BuildContext context) {
    final adminAuthService = Get.find<AdminAuthService>();

    return Scaffold(
      backgroundColor: bgColor,
      body: Center(
        child: Container(
          width: 400,
          padding: EdgeInsets.all(defaultPadding * 2),
          decoration: BoxDecoration(
            color: secondaryColor,
            borderRadius: BorderRadius.circular(15),
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Logo
              Container(
                width: 80,
                height: 80,
                decoration: const BoxDecoration(
                  color: primaryColor,
                  shape: BoxShape.circle,
                ),
                child: const Icon(Icons.admin_panel_settings,
                    color: Colors.white, size: 40),
              ),
              const SizedBox(height: defaultPadding * 2),

              // Title
              Text(
                'Admin Panel',
                style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                    ),
              ),
              SizedBox(height: defaultPadding),
              Text(
                'Sign in to continue',
                style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                      color: Colors.white70,
                    ),
              ),
              SizedBox(height: defaultPadding * 2),

              // Login Form
              Form(
                child: Column(
                  children: [
                    CustomTextField(
                      controller: usernameCtrl,
                      labelText: 'Username',
                      prefixIcon: Icon(Icons.person),
                      validator: (value) {
                        if (value == null || value.isEmpty) {
                          return 'Please enter username';
                        }
                        return null;
                      },
                    ),
                    SizedBox(height: defaultPadding),
                    CustomTextField(
                      controller: passwordCtrl,
                      labelText: 'Password',
                      prefixIcon: Icon(Icons.lock),
                      obscureText: true,
                      validator: (value) {
                        if (value == null || value.isEmpty) {
                          return 'Please enter password';
                        }
                        return null;
                      },
                    ),
                    const SizedBox(height: defaultPadding * 2),

                    // Login Button
                    Obx(() => ElevatedButton(
                          onPressed: isLoading.value
                              ? null
                              : () => _login(adminAuthService),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: primaryColor,
                            foregroundColor: Colors.white,
                            minimumSize: Size(double.infinity, 50),
                          ),
                          child: isLoading.value
                              ? const SizedBox(
                                  width: 20,
                                  height: 20,
                                  child: CircularProgressIndicator(
                                    strokeWidth: 2,
                                    valueColor: AlwaysStoppedAnimation<Color>(
                                        Colors.white),
                                  ),
                                )
                              : Text('Sign In'),
                        )),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Future<void> _login(AdminAuthService adminAuthService) async {
    if (usernameCtrl.text.isEmpty || passwordCtrl.text.isEmpty) {
      Get.snackbar(
        'Error',
        'Please enter both username and password',
        backgroundColor: Colors.red,
        colorText: Colors.white,
      );
      return;
    }

    isLoading.value = true;

    try {
      final result = await adminAuthService.login(
        usernameCtrl.text.trim(),
        passwordCtrl.text,
      );

      if (result.success) {
        Get.offAllNamed('/main');
        Get.snackbar(
          'Success',
          'Login successful',
          backgroundColor: Colors.green,
          colorText: Colors.white,
        );
      } else {
        Get.snackbar(
          'Error',
          result.message,
          backgroundColor: Colors.red,
          colorText: Colors.white,
        );
      }
    } catch (e) {
      Get.snackbar(
        'Error',
        'Login failed: $e',
        backgroundColor: Colors.red,
        colorText: Colors.white,
      );
    } finally {
      isLoading.value = false;
    }
  }
}

========== FILE: lib/screens/brands/brand_screen.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import '../../utility/constants.dart';
import 'components/add_brand_form.dart';
import 'components/brand_header.dart';
import 'components/brand_list_section.dart';

class BrandScreen extends StatefulWidget {
  @override
  State<BrandScreen> createState() => _BrandScreenState();
}

class _BrandScreenState extends State<BrandScreen> {
  @override
  void initState() {
    super.initState();
    // Auto-load brands when screen is created
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.dataProvider.getAllBrands();
    });
  }

  @override
  Widget build(BuildContext context) {
    return SafeArea(
      child: SingleChildScrollView(
        primary: false,
        padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
        child: Column(
          children: [
            BrandHeader(),
            Gap(defaultPadding),
            Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Expanded(
                  flex: 5,
                  child: Column(
                    children: [
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Expanded(
                            child: Text(
                              "My Brands",
                              style: Theme.of(context).textTheme.titleMedium,
                            ),
                          ),
                          ElevatedButton.icon(
                            style: TextButton.styleFrom(
                              padding: EdgeInsets.symmetric(
                                horizontal: ResponsiveUtils.isMobile(context)
                                    ? defaultPadding
                                    : defaultPadding * 1.5,
                                vertical: ResponsiveUtils.isMobile(context)
                                    ? defaultPadding / 2
                                    : defaultPadding,
                              ),
                            ),
                            onPressed: () {
                              showBrandForm(context, null);
                            },
                            icon: Icon(Icons.add),
                            label: Text("Add New"),
                          ),
                          Gap(ResponsiveUtils.isMobile(context) ? 8 : 20),
                          IconButton(
                            onPressed: () {
                              context.dataProvider
                                  .getAllBrands(showSnack: true);
                            },
                            icon: Icon(Icons.refresh),
                          ),
                        ],
                      ),
                      Gap(defaultPadding),
                      BrandListSection(),
                    ],
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}

========== FILE: lib/screens/brands/components/add_brand_form.dart ==========

import '../../../models/sub_category.dart';
import '../../../utility/responsive_utils.dart';
import '../../../widgets/compact_form_dialog.dart';
import '../provider/brand_provider.dart';
import '../../../utility/extensions.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import 'package:provider/provider.dart';
import '../../../models/brand.dart';
import '../../../utility/constants.dart';
import '../../../widgets/custom_dropdown.dart';
import '../../../widgets/custom_text_field.dart';

class BrandSubmitForm extends StatelessWidget {
  final Brand? brand;

  const BrandSubmitForm({super.key, this.brand});

  @override
  Widget build(BuildContext context) {
    context.brandProvider.setDataForUpdateBrand(brand);
    return SingleChildScrollView(
      child: Form(
        key: context.brandProvider.addBrandFormKey,
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Gap(ResponsiveUtils.getPadding(context)),
            _buildFormFields(context),
            Gap(ResponsiveUtils.getPadding(context) * 2),
            _buildActionButtons(context),
          ],
        ),
      ),
    );
  }

  Widget _buildFormFields(BuildContext context) {
    if (ResponsiveUtils.isMobile(context)) {
      return Column(
        children: [
          _buildSubCategoryDropdown(context),
          Gap(8),
          _buildNameField(context),
        ],
      );
    } else {
      return Row(
        children: [
          Expanded(child: _buildSubCategoryDropdown(context)),
          Gap(8),
          Expanded(child: _buildNameField(context)),
        ],
      );
    }
  }

  Widget _buildSubCategoryDropdown(BuildContext context) {
    return Consumer<BrandProvider>(
      builder: (context, brandProvider, child) {
        return CustomDropdown(
          initialValue: brandProvider.selectedSubCategory,
          items: context.dataProvider.subCategories,
          hintText:
              brandProvider.selectedSubCategory?.name ?? 'Select Sub Category',
          displayItem: (SubCategory? subCategory) => subCategory?.name ?? '',
          onChanged: (newValue) {
            brandProvider.selectedSubCategory = newValue;
            brandProvider.updateUI();
          },
          validator: (value) {
            if (value == null) {
              return 'Please select a Sub Category';
            }
            return null;
          },
        );
      },
    );
  }

  Widget _buildNameField(BuildContext context) {
    return CustomTextField(
      controller: context.brandProvider.brandNameCtrl,
      labelText: 'Brand Name',
      onSave: (val) {},
      validator: (value) {
        if (value == null || value.isEmpty) {
          return 'Please enter a brand name';
        }
        return null;
      },
    );
  }

  Widget _buildActionButtons(BuildContext context) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        ElevatedButton(
          style: ElevatedButton.styleFrom(
            foregroundColor: Colors.white,
            backgroundColor: secondaryColor,
          ),
          onPressed: () {
            Navigator.of(context).pop();
          },
          child: Text('Cancel'),
        ),
        Gap(ResponsiveUtils.getPadding(context)),
        ElevatedButton(
          style: ElevatedButton.styleFrom(
            foregroundColor: Colors.white,
            backgroundColor: primaryColor,
          ),
          onPressed: () {
            if (context.brandProvider.addBrandFormKey.currentState!
                .validate()) {
              context.brandProvider.addBrandFormKey.currentState!.save();
              context.brandProvider.submiteBrand();
              Navigator.of(context).pop();
            }
          },
          child: Text('Submit'),
        ),
      ],
    );
  }
}

void showBrandForm(BuildContext context, Brand? brand) {
  showDialog(
    context: context,
    builder: (BuildContext context) {
      return CompactFormDialog(
        title: 'Add Brand',
        child: BrandSubmitForm(brand: brand),
      );
    },
  );
}

========== FILE: lib/screens/brands/components/brand_header.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';
import 'package:flutter/material.dart';
import '../../../widgets/responsive_header.dart';

class BrandHeader extends StatelessWidget {
  const BrandHeader({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return ResponsiveHeader(
      title: "Brands",
      onSearch: (val) => context.dataProvider.filteredBrands(val),
    );
  }
}

========== FILE: lib/screens/brands/components/brand_list_section.dart ==========

import 'package:admin_panal_start/services/admin_auth_service.dart';
import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:admin_panal_start/widgets/responsive_data_table.dart';
import 'package:get/get.dart';
import 'package:get/get_core/src/get_main.dart';
import '../../../core/data/data_provider.dart';
import 'add_brand_form.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../../utility/color_list.dart';
import '../../../utility/constants.dart';
import '../../../models/brand.dart';

class BrandListSection extends StatelessWidget {
  const BrandListSection({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
      decoration: const BoxDecoration(
        color: secondaryColor,
        borderRadius: BorderRadius.all(Radius.circular(10)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text("All Brands", style: Theme.of(context).textTheme.titleMedium),
          const SizedBox(height: defaultPadding),
          Consumer<DataProvider>(
            builder: (context, dataProvider, child) {
              return ResponsiveDataTable(
                columns: const [
                  DataColumn(label: Text("Brand")),
                  DataColumn(label: Text("Sub Category")),
                  DataColumn(label: Text("Added Date")),
                  DataColumn(label: Text("Edit")),
                  DataColumn(label: Text("Delete")),
                ],
                rows: List.generate(
                  dataProvider.brands.length,
                  (index) => brandDataRow(
                    context, // Add context
                    dataProvider.brands[index],
                    index + 1,
                    edit: () {
                      showBrandForm(context, dataProvider.brands[index]);
                    },
                    delete: () {
                      context.brandProvider
                          .deleteBrand(dataProvider.brands[index]);
                    },
                  ),
                ),
              );
            },
          ),
        ],
      ),
    );
  }
}

DataRow brandDataRow(BuildContext context, Brand brandInfo, int index,
    {Function? edit, Function? delete}) {
  return DataRow(
    cells: [
      DataCell(
        Row(
          children: [
            Container(
              width: 36,
              height: 36,
              decoration: BoxDecoration(
                color: colors[index % colors.length],
                shape: BoxShape.circle,
              ),
              child: Center(
                child: Text(
                  '${index}',
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 14,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Text(
                    brandInfo.name ?? 'No Name',
                    style: const TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.w500,
                      fontSize: 14,
                    ),
                    overflow: TextOverflow.ellipsis,
                    maxLines: 1,
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
      DataCell(
        Column(
          mainAxisAlignment: MainAxisAlignment.center,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              brandInfo.subcategoryId?.name ?? 'N/A',
              style: const TextStyle(color: Colors.white70),
              overflow: TextOverflow.ellipsis,
              maxLines: 1,
            ),
          ],
        ),
      ),
      DataCell(
        Column(
          mainAxisAlignment: MainAxisAlignment.center,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              _formatDate(brandInfo.createdAt),
              style: const TextStyle(color: Colors.white70),
              overflow: TextOverflow.ellipsis,
              maxLines: 1,
            ),
          ],
        ),
      ),
      DataCell(
        IconButton(
          onPressed: Get.find<AdminAuthService>().canEditItem(brandInfo)
              ? () {
                  if (edit != null) edit();
                }
              : null,
          icon: Get.find<AdminAuthService>().canEditItem(brandInfo)
              ? const Icon(Icons.edit, color: Colors.blue, size: 20)
              : const Icon(Icons.lock, color: Colors.grey, size: 20),
          tooltip: Get.find<AdminAuthService>().canEditItem(brandInfo)
              ? 'Edit Brand'
              : 'No permission',
        ),
      ),
      DataCell(
        IconButton(
          onPressed: Get.find<AdminAuthService>().canDeleteItem(brandInfo)
              ? () {
                  if (delete != null) delete();
                }
              : null,
          icon: Get.find<AdminAuthService>().canDeleteItem(brandInfo)
              ? const Icon(Icons.delete, color: Colors.red, size: 20)
              : const Icon(Icons.lock, color: Colors.grey, size: 20),
          tooltip: Get.find<AdminAuthService>().canDeleteItem(brandInfo)
              ? 'Delete Brand'
              : 'No permission',
        ),
      ),
    ],
  );
}

String _formatDate(String? dateString) {
  if (dateString == null) return 'N/A';
  try {
    final date = DateTime.parse(dateString);
    return '${date.day}/${date.month}/${date.year}';
  } catch (e) {
    return dateString;
  }
}

========== FILE: lib/screens/brands/provider/brand_provider.dart ==========

import 'package:flutter/cupertino.dart';
import 'package:get/get.dart';
import '../../../core/data/data_provider.dart';
import '../../../models/brand.dart';
import '../../../models/sub_category.dart';
import '../../../services/admin_auth_service.dart';
import '../../../services/http_services.dart';
import 'package:admin_panal_start/models/api_response.dart';
import 'package:admin_panal_start/utility/snack_bar_helper.dart';
import 'package:admin_panal_start/utility/error_utils.dart';

class BrandProvider extends ChangeNotifier {
  HttpService service = HttpService();
  final DataProvider _dataProvider;
  final AdminAuthService _authService = Get.find<AdminAuthService>();

  final addBrandFormKey = GlobalKey<FormState>();
  TextEditingController brandNameCtrl = TextEditingController();
  SubCategory? selectedSubCategory;
  Brand? brandForUpdate;

  BrandProvider(this._dataProvider);

  addBrand() async {
    try {
      final currentUserId = _authService.getUserId();

      Map<String, dynamic> brand = {
        'name': brandNameCtrl.text,
        'subcategoryId': selectedSubCategory?.sId,
        'createdBy': currentUserId, // Add this
      };

      final response = await service.addItem(
        endpointUrl: 'brands',
        itemData: brand,
      );

      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          clearFields();
          SnackBarHelper.showSuccessSnackBar('Brand added successfully');
          _dataProvider.getAllBrands();
        } else {
          SnackBarHelper.showOperationErrorSnackBar('add', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar('add', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('add', e);
      rethrow;
    }
  }

  updateBrand() async {
    try {
      // Check permission
      if (!_authService.canEditItem(brandForUpdate)) {
        SnackBarHelper.showErrorSnackBar(
            'You do not have permission to edit this brand');
        return;
      }

      Map<String, dynamic> brand = {
        'name': brandNameCtrl.text,
        'subcategoryId': selectedSubCategory?.sId,
      };

      final response = await service.updateItem(
        endpointUrl: 'brands',
        itemId: brandForUpdate?.sId ?? '',
        itemData: brand,
      );

      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          clearFields();
          SnackBarHelper.showSuccessSnackBar('Brand updated successfully');
          _dataProvider.getAllBrands();
        } else {
          SnackBarHelper.showOperationErrorSnackBar(
              'update', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar(
            'update', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('update', e);
      rethrow;
    }
  }

  submiteBrand() {
    if (brandForUpdate != null) {
      updateBrand();
    } else {
      addBrand();
    }
  }

  deleteBrand(Brand brand) async {
    try {
      // Check permission
      if (!_authService.canDeleteItem(brand)) {
        SnackBarHelper.showErrorSnackBar(
            'You do not have permission to delete this brand');
        return;
      }

      Response response = await service.deleteItem(
        endpointUrl: 'brands',
        itemId: brand.sId ?? '',
      );

      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          SnackBarHelper.showSuccessSnackBar("Brand deleted successfully");
          _dataProvider.getAllBrands();
        } else {
          SnackBarHelper.showOperationErrorSnackBar(
              'delete', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar(
            'delete', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('delete', e);
      rethrow;
    }
  }

  setDataForUpdateBrand(Brand? brand) {
    if (brand != null) {
      brandForUpdate = brand;
      brandNameCtrl.text = brand.name ?? '';
      selectedSubCategory = _dataProvider.subCategories.firstWhereOrNull(
        (element) => element.sId == brand.subcategoryId?.sId,
      );
    } else {
      clearFields();
    }
  }

  clearFields() {
    brandNameCtrl.clear();
    selectedSubCategory = null;
    brandForUpdate = null;
  }

  updateUI() {
    notifyListeners();
  }
}

========== FILE: lib/screens/category/category_screen.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import '../../utility/constants.dart';
import 'components/add_category_form.dart';
import 'components/category_header.dart';
import 'components/category_list_section.dart';

class CategoryScreen extends StatefulWidget {
  @override
  State<CategoryScreen> createState() => _CategoryScreenState();
}

class _CategoryScreenState extends State<CategoryScreen> {
  @override
  void initState() {
    super.initState();
    // Auto-load categories when screen is created
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.dataProvider.getAllCategory();
    });
  }

  @override
  Widget build(BuildContext context) {
    return SafeArea(
      child: SingleChildScrollView(
        primary: false,
        padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
        child: Column(
          children: [
            CategoryHeader(),
            SizedBox(height: defaultPadding),
            Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Expanded(
                  flex: 5,
                  child: Column(
                    children: [
                      Row(
                        mainAxisAlignment: MainAxisAlignment.end,
                        children: [
                          Expanded(
                            child: Text(
                              "My Categories",
                              style: Theme.of(context).textTheme.titleMedium,
                            ),
                          ),
                          ElevatedButton.icon(
                            style: TextButton.styleFrom(
                              padding: EdgeInsets.symmetric(
                                horizontal: ResponsiveUtils.isMobile(context)
                                    ? defaultPadding
                                    : defaultPadding * 1.5,
                                vertical: ResponsiveUtils.isMobile(context)
                                    ? defaultPadding / 2
                                    : defaultPadding,
                              ),
                            ),
                            onPressed: () {
                              showAddCategoryForm(context, null);
                            },
                            icon: Icon(Icons.add),
                            label: Text("Add New"),
                          ),
                          Gap(ResponsiveUtils.isMobile(context) ? 8 : 20),
                          IconButton(
                            onPressed: () {
                              context.dataProvider
                                  .getAllCategory(showSnack: true);
                            },
                            icon: Icon(Icons.refresh),
                          ),
                        ],
                      ),
                      Gap(defaultPadding),
                      CategoryListSection(),
                    ],
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}

========== FILE: lib/screens/category/components/add_category_form.dart ==========

import '../../../models/category.dart';
import '../../../utility/responsive_utils.dart';
import '../../../widgets/compact_form_dialog.dart';
import '../provider/category_provider.dart';
import '../../../utility/extensions.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import 'package:provider/provider.dart';
import '../../../utility/constants.dart';
import '../../../widgets/category_image_card.dart';
import '../../../widgets/custom_text_field.dart';

class CategorySubmitForm extends StatelessWidget {
  final Category? category;

  const CategorySubmitForm({super.key, this.category});

  @override
  Widget build(BuildContext context) {
    context.categoryProvider.setDataForUpdateCategory(category);
    return Form(
      key: context.categoryProvider.addCategoryFormKey,
      child: SingleChildScrollView(
        padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            _buildImageSection(context),
            Gap(ResponsiveUtils.getPadding(context)),
            CustomTextField(
              controller: context.categoryProvider.categoryNameCtrl,
              labelText: 'Category Name',
              onSave: (val) {},
              validator: (value) {
                if (value == null || value.isEmpty) {
                  return 'Please enter a category name';
                }
                return null;
              },
            ),
            Gap(ResponsiveUtils.getPadding(context)),
            _buildActionButtons(context),
            SizedBox(height: 8), // Small bottom padding
          ],
        ),
      ),
    );
  }

  Widget _buildImageSection(BuildContext context) {
    return Consumer<CategoryProvider>(
      builder: (context, catProvider, child) {
        return Column(
          children: [
            SizedBox(
              width: ResponsiveUtils.isMobile(context) ? 120 : 150,
              child: CategoryImageCard(
                labelText: "Category",
                imageFile: catProvider.selectedImage,
                imageUrlForUpdateImage: category?.image,
                onTap: () {
                  catProvider.pickImage(context);
                },
                onRemoveImage: () {
                  catProvider.selectedImage = null;
                  catProvider.imgXFile = null;
                },
              ),
            ),
            SizedBox(height: 8),
            Text(
              'Tap to add category image',
              style: TextStyle(
                color: Colors.white70,
                fontSize: 12,
              ),
            ),
          ],
        );
      },
    );
  }

  Widget _buildActionButtons(BuildContext context) {
    return Container(
      padding: EdgeInsets.only(top: 16, bottom: 8),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          ElevatedButton(
            style: ElevatedButton.styleFrom(
              foregroundColor: Colors.white,
              backgroundColor: secondaryColor,
              padding: EdgeInsets.symmetric(horizontal: 20, vertical: 12),
            ),
            onPressed: () {
              Navigator.of(context).pop();
            },
            child: Text('Cancel'),
          ),
          Gap(ResponsiveUtils.getPadding(context)),
          ElevatedButton(
            style: ElevatedButton.styleFrom(
              foregroundColor: Colors.white,
              backgroundColor: primaryColor,
              padding: EdgeInsets.symmetric(horizontal: 20, vertical: 12),
            ),
            onPressed: () {
              if (context.categoryProvider.addCategoryFormKey.currentState!
                  .validate()) {
                context.categoryProvider.addCategoryFormKey.currentState!
                    .save();
                context.categoryProvider.submitCategory();
                Navigator.of(context).pop();
              }
            },
            child: Text('Submit'),
          ),
        ],
      ),
    );
  }
}

void showAddCategoryForm(BuildContext context, Category? category) {
  showDialog(
    context: context,
    builder: (BuildContext context) {
      return CompactFormDialog(
        title: 'Add Category',
        child: CategorySubmitForm(category: category),
      );
    },
  );
}

========== FILE: lib/screens/category/components/category_header.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';
import 'package:flutter/material.dart';
import '../../../widgets/responsive_header.dart';

class CategoryHeader extends StatelessWidget {
  const CategoryHeader({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return ResponsiveHeader(
      title: "Category",
      onSearch: (val) => context.dataProvider.filterCategories(val),
    );
  }
}

========== FILE: lib/screens/category/components/category_list_section.dart ==========

import 'package:admin_panal_start/services/admin_auth_service.dart';
import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:admin_panal_start/widgets/responsive_data_table.dart';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:get/get.dart';
import 'package:get/get_core/src/get_main.dart';
import '../../../core/data/data_provider.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../../utility/constants.dart';
import '../../../models/category.dart';
import 'add_category_form.dart';

class CategoryListSection extends StatelessWidget {
  const CategoryListSection({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
      decoration: const BoxDecoration(
        color: secondaryColor,
        borderRadius: BorderRadius.all(Radius.circular(10)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            "All Categories",
            style: Theme.of(context).textTheme.titleMedium,
          ),
          const SizedBox(height: defaultPadding),
          Consumer<DataProvider>(
            builder: (context, dataProvider, child) {
              return ResponsiveDataTable(
                dataRowMinHeight: 70,
                dataRowMaxHeight: 90,
                columns: const [
                  DataColumn(label: Text("Category")),
                  DataColumn(label: Text("Image")),
                  DataColumn(label: Text("Added Date")),
                  DataColumn(label: Text("Edit")),
                  DataColumn(label: Text("Delete")),
                ],
                rows: List.generate(
                  dataProvider.categories.length,
                  (index) => categoryDataRow(
                    context, // Add context here
                    dataProvider.categories[index],
                    edit: () {
                      showAddCategoryForm(
                          context, dataProvider.categories[index]);
                    },
                    delete: () {
                      context.categoryProvider
                          .deleteCategory(dataProvider.categories[index]);
                    },
                  ),
                ),
              );
            },
          ),
        ],
      ),
    );
  }
}

DataRow categoryDataRow(BuildContext context, Category catInfo,
    {Function? edit, Function? delete}) {
  return DataRow(
    cells: [
      DataCell(
        Container(
          constraints: const BoxConstraints(minHeight: 60),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                catInfo.name ?? 'No Name',
                style: const TextStyle(
                  color: Colors.white,
                  fontWeight: FontWeight.w500,
                  fontSize: 14,
                ),
                overflow: TextOverflow.ellipsis,
                maxLines: 2,
              ),
            ],
          ),
        ),
      ),
      DataCell(
        Container(
          constraints: const BoxConstraints(minHeight: 60),
          child: Center(
            child: _buildCategoryImage(catInfo.image),
          ),
        ),
      ),
      DataCell(
        Container(
          constraints: const BoxConstraints(minHeight: 60),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                _formatDate(catInfo.createdAt),
                style: const TextStyle(color: Colors.white70),
                overflow: TextOverflow.ellipsis,
                maxLines: 2,
              ),
            ],
          ),
        ),
      ),
      DataCell(
        Container(
          constraints: const BoxConstraints(minHeight: 60),
          child: Center(
            child: Get.find<AdminAuthService>().canEditItem(catInfo)
                ? IconButton(
                    onPressed: () {
                      if (edit != null) edit();
                    },
                    icon: const Icon(Icons.edit, color: Colors.blue, size: 20),
                    tooltip: 'Edit Category',
                  )
                : const Icon(Icons.lock, color: Colors.grey, size: 20),
          ),
        ),
      ),
      DataCell(
        Container(
          constraints: const BoxConstraints(minHeight: 60),
          child: Center(
            child: Get.find<AdminAuthService>().canDeleteItem(catInfo)
                ? IconButton(
                    onPressed: () {
                      if (delete != null) delete();
                    },
                    icon: const Icon(Icons.delete, color: Colors.red, size: 20),
                    tooltip: 'Delete Category',
                  )
                : const Icon(Icons.lock, color: Colors.grey, size: 20),
          ),
        ),
      ),
    ],
  );
}

Widget _buildCategoryImage(String? imageUrl) {
  if (imageUrl == null || imageUrl.isEmpty || imageUrl == 'no_url') {
    return Container(
      width: 50,
      height: 50,
      decoration: BoxDecoration(
        color: Colors.grey[800],
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: Colors.grey.shade600),
      ),
      child: Icon(Icons.category, color: Colors.grey[400], size: 24),
    );
  }

  return Container(
    width: 50,
    height: 50,
    child: ClipRRect(
      borderRadius: BorderRadius.circular(8),
      child: CachedNetworkImage(
        imageUrl: imageUrl,
        width: 50,
        height: 50,
        fit: BoxFit.cover,
        placeholder: (context, url) => Container(
          width: 50,
          height: 50,
          decoration: BoxDecoration(
            color: Colors.grey[800],
            borderRadius: BorderRadius.circular(8),
          ),
          child: Center(
            child: SizedBox(
              width: 20,
              height: 20,
              child: CircularProgressIndicator(
                strokeWidth: 2,
                valueColor: const AlwaysStoppedAnimation<Color>(Colors.white),
              ),
            ),
          ),
        ),
        errorWidget: (context, url, error) => Container(
          width: 50,
          height: 50,
          decoration: BoxDecoration(
            color: Colors.grey[800],
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: Colors.red),
          ),
          child: const Icon(Icons.error, color: Colors.red, size: 20),
        ),
      ),
    ),
  );
}

String _formatDate(String? dateString) {
  if (dateString == null) return 'N/A';
  try {
    final date = DateTime.parse(dateString);
    return '${date.day}/${date.month}/${date.year}';
  } catch (e) {
    return dateString;
  }
}

========== FILE: lib/screens/category/provider/category_provider.dart ==========

import 'dart:io';
import 'dart:developer' show log;
import 'package:admin_panal_start/models/api_response.dart';
import 'package:admin_panal_start/utility/snack_bar_helper.dart';
import 'package:admin_panal_start/widgets/camera_picker_dialog.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/foundation.dart' hide Category;
import 'package:get/get.dart';
import 'package:image_picker/image_picker.dart';
import '../../../core/data/data_provider.dart';
import '../../../models/category.dart';
import '../../../services/admin_auth_service.dart';
import '../../../services/http_services.dart';

class CategoryProvider extends ChangeNotifier {
  HttpService service = HttpService();
  final DataProvider _dataProvider;
  final AdminAuthService _authService = Get.find<AdminAuthService>();

  final addCategoryFormKey = GlobalKey<FormState>();
  TextEditingController categoryNameCtrl = TextEditingController();
  Category? categoryForUpdate;

  File? selectedImage;
  XFile? imgXFile;

  CategoryProvider(this._dataProvider);

  addCategory() async {
    try {
      if (selectedImage == null) {
        SnackBarHelper.showWarningSnackBar('Please select a category image');
        return;
      }

      Map<String, dynamic> formDataMap = {
        'name': categoryNameCtrl.text,
        'Image': 'no_image',
        'createdBy': _authService.getUserId(), // Add createdBy
      };

      final FormData form = await createFormData(
        imgXFile: imgXFile,
        formData: formDataMap,
      );

      final response = await service.addItem(
        endpointUrl: 'categories',
        itemData: form,
      );

      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          clearFields();
          SnackBarHelper.showSuccessSnackBar('Category added successfully');
          _dataProvider.getAllCategory();
        } else {
          SnackBarHelper.showOperationErrorSnackBar('add', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar('add', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('add', e);
      rethrow;
    }
  }

  updateCategory() async {
    try {
      // Check permission
      if (!_authService.canEditItem(categoryForUpdate)) {
        SnackBarHelper.showErrorSnackBar(
            'You do not have permission to edit this category');
        return;
      }

      Map<String, dynamic> formDataMap = {
        'name': categoryNameCtrl.text,
        'image': categoryForUpdate?.image ?? '',
      };

      final FormData form = await createFormData(
        imgXFile: imgXFile,
        formData: formDataMap,
      );

      final response = await service.updateItem(
        endpointUrl: 'categories',
        itemId: categoryForUpdate?.sId ?? '',
        itemData: form,
      );

      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          clearFields();
          SnackBarHelper.showSuccessSnackBar('${apiResponse.message}');
          log('update category');
          _dataProvider.getAllCategory();
        } else {
          SnackBarHelper.showErrorSnackBar(
            "Failed to update category: ${apiResponse.message}",
          );
        }
      } else {
        SnackBarHelper.showErrorSnackBar(
          "Error ${response.body?["message"] ?? response.status}",
        );
      }
    } catch (e) {
      print(e);
      SnackBarHelper.showErrorSnackBar("An error occurred: $e");
      rethrow;
    }
  }

  submitCategory() {
    if (categoryForUpdate != null) {
      updateCategory();
    } else {
      addCategory();
    }
  }

  deleteCategory(Category category) async {
    try {
      // Check permission
      if (!_authService.canDeleteItem(category)) {
        SnackBarHelper.showErrorSnackBar(
            'You do not have permission to delete this category');
        return;
      }

      Response response = await service.deleteItem(
        endpointUrl: 'categories',
        itemId: category.sId ?? '',
      );

      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          SnackBarHelper.showSuccessSnackBar("Category deleted successfully");
          _dataProvider.getAllCategory();
        } else {
          SnackBarHelper.showErrorSnackBar(
            "Error ${response.body?["message"] ?? response.status}",
          );
        }
      }
    } catch (e) {
      print(e);
      rethrow;
    }
  }

  void pickImage(BuildContext context) async {
    showCameraPickerDialog(context, (XFile? image) async {
      if (image != null) {
        selectedImage = File(image.path);
        imgXFile = image;
        notifyListeners();
      }
    });
  }

  //? to create form data for sending image with body
  Future<FormData> createFormData({
    required XFile? imgXFile,
    required Map<String, dynamic> formData,
  }) async {
    if (imgXFile != null) {
      MultipartFile multipartFile;
      if (kIsWeb) {
        String fileName = imgXFile.name;
        Uint8List byteImg = await imgXFile.readAsBytes();
        multipartFile = MultipartFile(byteImg, filename: fileName);
      } else {
        String fileName = imgXFile.path.split('/').last;
        multipartFile = MultipartFile(imgXFile.path, filename: fileName);
      }
      formData['img'] = multipartFile;
    }
    final FormData form = FormData(formData);
    return form;
  }

  //? set data for update on editing
  setDataForUpdateCategory(Category? category) {
    if (category != null) {
      clearFields();
      categoryForUpdate = category;
      categoryNameCtrl.text = category.name ?? '';
    } else {
      clearFields();
    }
  }

  //? to clear text field and images after adding or update category
  clearFields() {
    categoryNameCtrl.clear();
    selectedImage = null;
    imgXFile = null;
    categoryForUpdate = null;
  }
}

========== FILE: lib/screens/coupon_code/components/add_coupon_form.dart ==========

import '../../../utility/responsive_utils.dart';
import '../../../models/product.dart';
import '../../../models/sub_category.dart';
import '../provider/coupon_code_provider.dart';
import '../../../widgets/compact_form_dialog.dart';
import '../../../utility/extensions.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import 'package:provider/provider.dart';
import '../../../models/category.dart';
import '../../../models/coupon.dart';
import '../../../utility/constants.dart';
import '../../../widgets/custom_date_picker.dart';
import '../../../widgets/custom_dropdown.dart';
import '../../../widgets/custom_text_field.dart';

class CouponSubmitForm extends StatelessWidget {
  final Coupon? coupon;

  const CouponSubmitForm({Key? key, this.coupon}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    context.couponCodeProvider.setDataForUpdateCoupon(coupon);
    return SingleChildScrollView(
      child: Form(
        key: context.couponCodeProvider.addCouponFormKey,
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Gap(ResponsiveUtils.getPadding(context)),
            _buildBasicInfoSection(context),
            Gap(ResponsiveUtils.getPadding(context)),
            _buildAmountSection(context),
            Gap(ResponsiveUtils.getPadding(context)),
            _buildDateStatusSection(context),
            Gap(ResponsiveUtils.getPadding(context)),
            _buildApplicableSection(context),
            Gap(ResponsiveUtils.getPadding(context)),
            _buildActionButtons(context),
          ],
        ),
      ),
    );
  }

  Widget _buildBasicInfoSection(BuildContext context) {
    if (ResponsiveUtils.isMobile(context)) {
      return Column(
        children: [
          _buildCouponCodeField(context),
          Gap(8),
          _buildDiscountTypeDropdown(context),
        ],
      );
    } else {
      return Row(
        children: [
          Expanded(child: _buildCouponCodeField(context)),
          Gap(8),
          Expanded(child: _buildDiscountTypeDropdown(context)),
        ],
      );
    }
  }

  Widget _buildCouponCodeField(BuildContext context) {
    return CustomTextField(
      controller: context.couponCodeProvider.couponCodeCtrl,
      labelText: 'Coupon Code',
      onSave: (val) {},
      validator: (value) {
        if (value == null || value.isEmpty) {
          return 'Please enter coupon code';
        }
        return null;
      },
    );
  }

  Widget _buildDiscountTypeDropdown(BuildContext context) {
    return CustomDropdown(
      key: GlobalKey(),
      hintText: 'Discount Type',
      items: ['fixed', 'percentage'],
      initialValue: context.couponCodeProvider.selectedDiscountType,
      onChanged: (newValue) {
        context.couponCodeProvider.selectedDiscountType = newValue ?? 'fixed';
      },
      validator: (value) {
        if (value == null || value.isEmpty) {
          return 'Please select a discount type';
        }
        return null;
      },
      displayItem: (val) => val,
    );
  }

  Widget _buildAmountSection(BuildContext context) {
    if (ResponsiveUtils.isMobile(context)) {
      return Column(
        children: [
          _buildDiscountAmountField(context),
          Gap(8),
          _buildMinimumAmountField(context),
        ],
      );
    } else {
      return Row(
        children: [
          Expanded(child: _buildDiscountAmountField(context)),
          Gap(8),
          Expanded(child: _buildMinimumAmountField(context)),
        ],
      );
    }
  }

  Widget _buildDiscountAmountField(BuildContext context) {
    return CustomTextField(
      controller: context.couponCodeProvider.discountAmountCtrl,
      labelText: 'Discount Amount',
      inputType: TextInputType.number,
      onSave: (val) {},
      validator: (value) {
        if (value == null || value.isEmpty) {
          return 'Please enter discount amount';
        }
        return null;
      },
    );
  }

  Widget _buildMinimumAmountField(BuildContext context) {
    return CustomTextField(
      controller: context.couponCodeProvider.minimumPurchaseAmountCtrl,
      labelText: 'Minimum Purchase Amount',
      inputType: TextInputType.number,
      onSave: (val) {},
      validator: (value) {
        if (value == null || value.isEmpty) {
          return 'Please enter minimum amount';
        }
        return null;
      },
    );
  }

  Widget _buildDateStatusSection(BuildContext context) {
    if (ResponsiveUtils.isMobile(context)) {
      return Column(
        children: [
          _buildDatePicker(context),
          Gap(8),
          _buildStatusDropdown(context),
        ],
      );
    } else {
      return Row(
        children: [
          Expanded(child: _buildDatePicker(context)),
          Gap(8),
          Expanded(child: _buildStatusDropdown(context)),
        ],
      );
    }
  }

  Widget _buildDatePicker(BuildContext context) {
    return CustomDatePicker(
      labelText: 'Select Date',
      controller: context.couponCodeProvider.endDateCtrl,
      initialDate: DateTime.now(),
      firstDate: DateTime(2000),
      lastDate: DateTime(2100),
      onDateSelected: (DateTime date) {
        print('Selected Date: $date');
      },
    );
  }

  Widget _buildStatusDropdown(BuildContext context) {
    return CustomDropdown(
      key: GlobalKey(),
      hintText: 'Status',
      initialValue: context.couponCodeProvider.selectedCouponStatus,
      items: ['active', 'inactive'],
      displayItem: (val) => val,
      onChanged: (newValue) {
        context.couponCodeProvider.selectedCouponStatus = newValue ?? 'active';
      },
      validator: (value) {
        if (value == null || value.isEmpty) {
          return 'Please select status';
        }
        return null;
      },
    );
  }

  Widget _buildApplicableSection(BuildContext context) {
    if (ResponsiveUtils.isMobile(context)) {
      return Column(
        children: [
          _buildCategoryDropdown(context),
          Gap(8),
          _buildSubCategoryDropdown(context),
          Gap(8),
          _buildProductDropdown(context),
        ],
      );
    } else {
      return Row(
        children: [
          Expanded(child: _buildCategoryDropdown(context)),
          Gap(8),
          Expanded(child: _buildSubCategoryDropdown(context)),
          Gap(8),
          Expanded(child: _buildProductDropdown(context)),
        ],
      );
    }
  }

  Widget _buildCategoryDropdown(BuildContext context) {
    return Consumer<CouponCodeProvider>(
      builder: (context, couponProvider, child) {
        return CustomDropdown(
          initialValue: couponProvider.selectedCategory,
          hintText: couponProvider.selectedCategory?.name ?? 'Select category',
          items: context.dataProvider.categories,
          displayItem: (Category? category) => category?.name ?? '',
          onChanged: (newValue) {
            if (newValue != null) {
              couponProvider.selectedSubCategory = null;
              couponProvider.selectedProduct = null;
              couponProvider.selectedCategory = newValue;
              couponProvider.updateUi();
            }
          },
        );
      },
    );
  }

  Widget _buildSubCategoryDropdown(BuildContext context) {
    return Consumer<CouponCodeProvider>(
      builder: (context, couponProvider, child) {
        return CustomDropdown(
          initialValue: couponProvider.selectedSubCategory,
          hintText:
              couponProvider.selectedSubCategory?.name ?? 'Select sub category',
          items: context.dataProvider.subCategories,
          displayItem: (SubCategory? subCategory) => subCategory?.name ?? '',
          onChanged: (newValue) {
            if (newValue != null) {
              couponProvider.selectedCategory = null;
              couponProvider.selectedProduct = null;
              couponProvider.selectedSubCategory = newValue;
              couponProvider.updateUi();
            }
          },
        );
      },
    );
  }

  Widget _buildProductDropdown(BuildContext context) {
    return Consumer<CouponCodeProvider>(
      builder: (context, couponProvider, child) {
        return CustomDropdown(
          initialValue: couponProvider.selectedProduct,
          hintText: couponProvider.selectedProduct?.name ?? 'Select product',
          items: context.dataProvider.products,
          displayItem: (Product? product) => product?.name ?? '',
          onChanged: (newValue) {
            if (newValue != null) {
              couponProvider.selectedCategory = null;
              couponProvider.selectedSubCategory = null;
              couponProvider.selectedProduct = newValue;
              couponProvider.updateUi();
            }
          },
        );
      },
    );
  }

  Widget _buildActionButtons(BuildContext context) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        ElevatedButton(
          style: ElevatedButton.styleFrom(
            foregroundColor: Colors.white,
            backgroundColor: secondaryColor,
          ),
          onPressed: () {
            Navigator.of(context).pop();
          },
          child: Text('Cancel'),
        ),
        SizedBox(width: ResponsiveUtils.getPadding(context)),
        ElevatedButton(
          style: ElevatedButton.styleFrom(
            foregroundColor: Colors.white,
            backgroundColor: primaryColor,
          ),
          onPressed: () {
            if (context.couponCodeProvider.addCouponFormKey.currentState!
                .validate()) {
              context.couponCodeProvider.addCouponFormKey.currentState!.save();
              context.couponCodeProvider.submitCoupon();
              Navigator.of(context).pop();
            }
          },
          child: Text('Submit'),
        ),
      ],
    );
  }
}

void showAddCouponForm(BuildContext context, Coupon? coupon) {
  showDialog(
    context: context,
    builder: (BuildContext context) {
      return CompactFormDialog(
        title: 'Add Coupon',
        maxWidth: ResponsiveUtils.isMobile(context) ? double.infinity : 700,
        child: CouponSubmitForm(coupon: coupon),
      );
    },
  );
}

========== FILE: lib/screens/coupon_code/components/coupon_code_header.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';
import 'package:flutter/material.dart';
import '../../../widgets/responsive_header.dart';

class CouponCodeHeader extends StatelessWidget {
  const CouponCodeHeader({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return ResponsiveHeader(
      title: "Coupon Codes",
      onSearch: (val) => context.dataProvider.filterCoupons(val),
    );
  }
}

========== FILE: lib/screens/coupon_code/components/coupon_list_section.dart ==========

import 'package:admin_panal_start/services/admin_auth_service.dart';
import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:admin_panal_start/widgets/responsive_data_table.dart';
import 'package:get/get.dart';
import 'package:get/get_core/src/get_main.dart';
import '../../../core/data/data_provider.dart';
import '../../../models/coupon.dart';
import 'add_coupon_form.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../../utility/color_list.dart';
import '../../../utility/constants.dart';

class CouponListSection extends StatelessWidget {
  const CouponListSection({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
      decoration: const BoxDecoration(
        color: secondaryColor,
        borderRadius: BorderRadius.all(Radius.circular(10)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text("All Coupons", style: Theme.of(context).textTheme.titleMedium),
          SizedBox(
            width: double.infinity,
            child: Consumer<DataProvider>(
              builder: (context, dataProvider, child) {
                return ResponsiveDataTable(
                  columns: const [
                    DataColumn(label: Text("Coupon Name")),
                    DataColumn(label: Text("Status")),
                    DataColumn(label: Text("Type")),
                    DataColumn(label: Text("Amount")),
                    DataColumn(label: Text("Edit")),
                    DataColumn(label: Text("Delete")),
                  ],
                  rows: List.generate(
                    dataProvider.coupons.length,
                    (index) => couponDataRow(
                      context, // Add context
                      dataProvider.coupons[index],
                      index + 1,
                      edit: () {
                        showAddCouponForm(context, dataProvider.coupons[index]);
                      },
                      delete: () {
                        context.couponCodeProvider
                            .deleteCoupon(dataProvider.coupons[index]);
                      },
                    ),
                  ),
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}

DataRow couponDataRow(BuildContext context, coupon, int index,
    {Function? edit, Function? delete}) {
  return DataRow(
    cells: [
      DataCell(
        Row(
          children: [
            Container(
              height: 24,
              width: 24,
              decoration: BoxDecoration(
                color: colors[index % colors.length],
                shape: BoxShape.circle,
              ),
              child: Text(index.toString(), textAlign: TextAlign.center),
            ),
            const Padding(
              padding: EdgeInsets.symmetric(horizontal: 8),
              child: Text(
                'Coupon Code',
                overflow: TextOverflow.ellipsis,
                maxLines: 1,
              ),
            ),
          ],
        ),
      ),
      const DataCell(Text(
        'Status',
        overflow: TextOverflow.ellipsis,
        maxLines: 1,
      )),
      const DataCell(Text(
        'Type',
        overflow: TextOverflow.ellipsis,
        maxLines: 1,
      )),
      const DataCell(Text(
        'Amount',
        overflow: TextOverflow.ellipsis,
        maxLines: 1,
      )),
      DataCell(
        IconButton(
          onPressed: Get.find<AdminAuthService>().canEditItem(coupon)
              ? () {
                  if (edit != null) edit();
                }
              : null,
          icon: Get.find<AdminAuthService>().canEditItem(coupon)
              ? const Icon(Icons.edit, color: Colors.white)
              : const Icon(Icons.lock, color: Colors.grey),
        ),
      ),
      DataCell(
        IconButton(
          onPressed: Get.find<AdminAuthService>().canDeleteItem(coupon)
              ? () {
                  if (delete != null) delete();
                }
              : null,
          icon: Get.find<AdminAuthService>().canDeleteItem(coupon)
              ? const Icon(Icons.delete, color: Colors.red)
              : const Icon(Icons.lock, color: Colors.grey),
        ),
      ),
    ],
  );
}

========== FILE: lib/screens/coupon_code/coupon_code_screen.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'components/coupon_code_header.dart';
import 'components/coupon_list_section.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import '../../utility/constants.dart';
import 'components/add_coupon_form.dart';

class CouponCodeScreen extends StatefulWidget {
  @override
  State<CouponCodeScreen> createState() => _CouponCodeScreenState();
}

class _CouponCodeScreenState extends State<CouponCodeScreen> {
  @override
  void initState() {
    super.initState();
    // Auto-load coupons when screen is created
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.dataProvider.getAllCoupons();
    });
  }

  @override
  Widget build(BuildContext context) {
    return SafeArea(
      child: SingleChildScrollView(
        primary: false,
        padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
        child: Column(
          children: [
            CouponCodeHeader(),
            Gap(defaultPadding),
            Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Expanded(
                  flex: 5,
                  child: Column(
                    children: [
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Expanded(
                            child: Text(
                              "My Coupons",
                              style: Theme.of(context).textTheme.titleMedium,
                            ),
                          ),
                          ElevatedButton.icon(
                            style: TextButton.styleFrom(
                              padding: EdgeInsets.symmetric(
                                horizontal: ResponsiveUtils.isMobile(context)
                                    ? defaultPadding
                                    : defaultPadding * 1.5,
                                vertical: ResponsiveUtils.isMobile(context)
                                    ? defaultPadding / 2
                                    : defaultPadding,
                              ),
                            ),
                            onPressed: () {
                              showAddCouponForm(context, null);
                            },
                            icon: Icon(Icons.add),
                            label: Text("Add New"),
                          ),
                          Gap(ResponsiveUtils.isMobile(context) ? 8 : 20),
                          IconButton(
                            onPressed: () {
                              context.dataProvider
                                  .getAllCoupons(showSnack: true);
                            },
                            icon: Icon(Icons.refresh),
                          ),
                        ],
                      ),
                      Gap(defaultPadding),
                      CouponListSection(),
                    ],
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}

========== FILE: lib/screens/coupon_code/provider/coupon_code_provider.dart ==========

import '../../../models/coupon.dart';
import '../../../models/product.dart';
import 'package:flutter/cupertino.dart';
import 'package:get/get.dart';
import '../../../core/data/data_provider.dart';
import '../../../models/category.dart';
import '../../../models/sub_category.dart';
import '../../../services/http_services.dart';
import 'package:admin_panal_start/utility/snack_bar_helper.dart';
import 'package:admin_panal_start/utility/error_utils.dart';
import 'package:admin_panal_start/models/api_response.dart';

class CouponCodeProvider extends ChangeNotifier {
  HttpService service = HttpService();
  final DataProvider _dataProvider;
  Coupon? couponForUpdate;

  final addCouponFormKey = GlobalKey<FormState>();
  TextEditingController couponCodeCtrl = TextEditingController();
  TextEditingController discountAmountCtrl = TextEditingController();
  TextEditingController minimumPurchaseAmountCtrl = TextEditingController();
  TextEditingController endDateCtrl = TextEditingController();
  String selectedDiscountType = 'fixed';
  String selectedCouponStatus = 'active';
  Category? selectedCategory;
  SubCategory? selectedSubCategory;
  Product? selectedProduct;

  CouponCodeProvider(this._dataProvider);

  addCoupon() async {
    try {
      if (endDateCtrl.text.isEmpty) {
        SnackBarHelper.showWarningSnackBar("Please select an end date");
        return;
      }
      Map<String, dynamic> coupon = {
        'couponCode': couponCodeCtrl.text,
        'discountType': selectedDiscountType,
        'discountAmount': discountAmountCtrl.text,
        'minimumPurchaseAmount': minimumPurchaseAmountCtrl.text,
        'endDate': endDateCtrl.text,
        'status': selectedCouponStatus,
        'applicableCategory': selectedCategory?.sId,
        'applicableSubCategory': selectedSubCategory?.sId,
        'applicableProduct': selectedProduct?.sId,
      };
      final response = await service.addItem(
        endpointUrl: 'couponCodes',
        itemData: coupon,
      );
      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          clearFields();
          SnackBarHelper.showSuccessSnackBar("Coupon added successfully");
          _dataProvider.getAllCoupons();
        } else {
          SnackBarHelper.showOperationErrorSnackBar('add', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar('add', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('add', e);
      rethrow;
    }
  }

  updateCoupon() async {
    try {
      if (couponForUpdate != null) {
        Map<String, dynamic> coupon = {
          'couponCode': couponCodeCtrl.text,
          'discountType': selectedDiscountType,
          'discountAmount': discountAmountCtrl.text,
          'minimumPurchaseAmount': minimumPurchaseAmountCtrl.text,
          'endDate': endDateCtrl.text,
          'status': selectedCouponStatus,
          'applicableCategory': selectedCategory?.sId,
          'applicableSubCategory': selectedSubCategory?.sId,
          'applicableProduct': selectedProduct?.sId,
        };
        final response = await service.updateItem(
          endpointUrl: 'couponCodes',
          itemId: couponForUpdate?.sId ?? '',
          itemData: coupon,
        );
        if (response.isOk) {
          ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
          if (apiResponse.success) {
            clearFields();
            SnackBarHelper.showSuccessSnackBar('Coupon updated successfully');
            _dataProvider.getAllCoupons();
          } else {
            SnackBarHelper.showOperationErrorSnackBar(
                'update', apiResponse.message);
          }
        } else {
          SnackBarHelper.showOperationErrorSnackBar(
              'update', response.statusText);
        }
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('update', e);
      rethrow;
    }
  }

  submitCoupon() {
    if (couponForUpdate != null) {
      updateCoupon();
    } else {
      addCoupon();
    }
  }

  deleteCoupon(Coupon coupon) async {
    try {
      Response response = await service.deleteItem(
        endpointUrl: 'couponCodes',
        itemId: coupon.sId ?? '',
      );
      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          SnackBarHelper.showSuccessSnackBar("Coupon deleted successfully");
          _dataProvider.getAllCoupons();
        } else {
          SnackBarHelper.showOperationErrorSnackBar(
              'delete', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar(
            'delete', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('delete', e);
      rethrow;
    }
  }

  setDataForUpdateCoupon(Coupon? coupon) {
    if (coupon != null) {
      couponForUpdate = coupon;
      couponCodeCtrl.text = coupon.couponCode ?? '';
      selectedDiscountType = coupon.discountType ?? 'fixed';
      discountAmountCtrl.text = '${coupon.discountAmount}';
      minimumPurchaseAmountCtrl.text = '${coupon.minimumPurchaseAmount}';
      endDateCtrl.text = '${coupon.endDate}';
      selectedCouponStatus = coupon.status ?? 'active';
      selectedCategory = _dataProvider.categories.firstWhereOrNull(
        (element) => element.sId == coupon.applicableCategory?.sId,
      );
      selectedSubCategory = _dataProvider.subCategories.firstWhereOrNull(
        (element) => element.sId == coupon.applicableSubCategory?.sId,
      );
      selectedProduct = _dataProvider.products.firstWhereOrNull(
        (element) => element.sId == coupon.applicableProduct?.sId,
      );
    } else {
      clearFields();
    }
  }

  clearFields() {
    couponForUpdate = null;
    selectedCategory = null;
    selectedSubCategory = null;
    selectedProduct = null;

    couponCodeCtrl.text = '';
    discountAmountCtrl.text = '';
    minimumPurchaseAmountCtrl.text = '';
    endDateCtrl.text = '';
  }

  updateUi() {
    notifyListeners();
  }
}

========== FILE: lib/screens/dashboard/components/add_product_form.dart ==========

import 'dart:io';

import '../../../models/brand.dart';
import '../../../models/category.dart';
import '../../../models/product.dart';
import '../../../models/sub_category.dart';
import '../../../models/variant_type.dart';
import '../../../utility/responsive_utils.dart';
import '../../../widgets/compact_form_dialog.dart';
import '../provider/dash_board_provider.dart';
import '../../../utility/extensions.dart';
import '../../../widgets/multi_select_drop_down.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../../utility/constants.dart';
import '../../../widgets/custom_dropdown.dart';
import '../../../widgets/custom_text_field.dart';
import '../../../widgets/product_image_card.dart';

class ProductSubmitForm extends StatelessWidget {
  final Product? product;

  const ProductSubmitForm({super.key, this.product});

  @override
  Widget build(BuildContext context) {
    context.dashBoardProvider.setDataForUpdateProduct(product);
    return Form(
      key: context.dashBoardProvider.addProductFormKey,
      child: SingleChildScrollView(
        padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            _buildImageSection(context),
            SizedBox(height: ResponsiveUtils.getPadding(context)),
            CustomTextField(
              controller: context.dashBoardProvider.productNameCtrl,
              labelText: 'Product Name',
              onSave: (val) {},
              validator: (value) {
                if (value == null || value.isEmpty) {
                  return 'Please enter name';
                }
                return null;
              },
            ),
            SizedBox(height: ResponsiveUtils.getPadding(context)),
            CustomTextField(
              controller: context.dashBoardProvider.productDescCtrl,
              labelText: 'Product Description',
              lineNumber: 3,
              onSave: (val) {},
            ),
            SizedBox(height: ResponsiveUtils.getPadding(context)),
            _buildCategorySection(context),
            SizedBox(height: ResponsiveUtils.getPadding(context)),
            _buildPriceSection(context),
            SizedBox(height: ResponsiveUtils.getPadding(context)),
            _buildVariantSection(context),
            SizedBox(height: ResponsiveUtils.getPadding(context)),
            _buildActionButtons(context),
            SizedBox(height: 8), // Small bottom padding
          ],
        ),
      ),
    );
  }

  Widget _buildImageSection(BuildContext context) {
    final images = [
      _ImageCardData('Main', 1, product?.images.safeElementAt(0)?.url),
      _ImageCardData('Second', 2, product?.images.safeElementAt(1)?.url),
      _ImageCardData('Third', 3, product?.images.safeElementAt(2)?.url),
      _ImageCardData('Fourth', 4, product?.images.safeElementAt(3)?.url),
      _ImageCardData('Fifth', 5, product?.images.safeElementAt(4)?.url),
    ];

    return Container(
      padding: EdgeInsets.symmetric(vertical: 8),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Product Images',
            style: TextStyle(
              fontSize: 14,
              fontWeight: FontWeight.w500,
              color: Colors.white,
            ),
          ),
          SizedBox(height: 8),
          Wrap(
            spacing: 8,
            runSpacing: 8,
            alignment: WrapAlignment.start,
            children: images.map((imageData) {
              return Consumer<DashBoardProvider>(
                builder: (context, dashProvider, child) {
                  File? selectedImage;
                  switch (imageData.number) {
                    case 1:
                      selectedImage = dashProvider.selectedMainImage;
                      break;
                    case 2:
                      selectedImage = dashProvider.selectedSecondImage;
                      break;
                    case 3:
                      selectedImage = dashProvider.selectedThirdImage;
                      break;
                    case 4:
                      selectedImage = dashProvider.selectedFourthImage;
                      break;
                    case 5:
                      selectedImage = dashProvider.selectedFifthImage;
                      break;
                  }

                  return ProductImageCard(
                    labelText: imageData.label,
                    imageFile: selectedImage,
                    imageUrlForUpdateImage: imageData.imageUrl,
                    onTap: () {
                      dashProvider.pickImage(
                          imageCardNumber: imageData.number, context: context);
                    },
                    onRemoveImage: () {
                      switch (imageData.number) {
                        case 1:
                          dashProvider.selectedMainImage = null;
                          dashProvider.mainImgXFile = null;
                          break;
                        case 2:
                          dashProvider.selectedSecondImage = null;
                          dashProvider.secondImgXFile = null;
                          break;
                        case 3:
                          dashProvider.selectedThirdImage = null;
                          dashProvider.thirdImgXFile = null;
                          break;
                        case 4:
                          dashProvider.selectedFourthImage = null;
                          dashProvider.fourthImgXFile = null;
                          break;
                        case 5:
                          dashProvider.selectedFifthImage = null;
                          dashProvider.fifthImgXFile = null;
                          break;
                      }
                      dashProvider.updateUI();
                    },
                  );
                },
              );
            }).toList(),
          ),
        ],
      ),
    );
  }

  Widget _buildCategorySection(BuildContext context) {
    return ResponsiveUtils.isMobile(context)
        ? Column(
            children: [
              _buildCategoryDropdown(context),
              SizedBox(height: 8),
              _buildSubCategoryDropdown(context),
              SizedBox(height: 8),
              _buildBrandDropdown(context),
            ],
          )
        : Row(
            children: [
              Expanded(child: _buildCategoryDropdown(context)),
              SizedBox(width: 8),
              Expanded(child: _buildSubCategoryDropdown(context)),
              SizedBox(width: 8),
              Expanded(child: _buildBrandDropdown(context)),
            ],
          );
  }

  Widget _buildCategoryDropdown(BuildContext context) {
    return Consumer<DashBoardProvider>(
      builder: (context, dashProvider, child) {
        return CustomDropdown(
          key: ValueKey(dashProvider.selectedCategory?.sId),
          initialValue: dashProvider.selectedCategory,
          hintText: dashProvider.selectedCategory?.name ?? 'Select category',
          items: context.dataProvider.categories,
          displayItem: (Category? category) => category?.name ?? '',
          onChanged: (newValue) {
            if (newValue != null) {
              context.dashBoardProvider.filterSubcategory(newValue);
            }
          },
          validator: (value) {
            if (value == null) {
              return 'Please select a category';
            }
            return null;
          },
        );
      },
    );
  }

  Widget _buildSubCategoryDropdown(BuildContext context) {
    return Consumer<DashBoardProvider>(
      builder: (context, dashProvider, child) {
        return CustomDropdown(
          key: ValueKey(dashProvider.selectedSubCategory?.sId),
          hintText: dashProvider.selectedSubCategory?.name ?? 'Sub category',
          items: dashProvider.subCategoriesByCategory,
          initialValue: dashProvider.selectedSubCategory,
          displayItem: (SubCategory? subCategory) => subCategory?.name ?? '',
          onChanged: (newValue) {
            if (newValue != null) {
              context.dashBoardProvider.filterBrand(newValue);
            }
          },
          validator: (value) {
            if (value == null) {
              return 'Please select sub category';
            }
            return null;
          },
        );
      },
    );
  }

  Widget _buildBrandDropdown(BuildContext context) {
    return Consumer<DashBoardProvider>(
      builder: (context, dashProvider, child) {
        return CustomDropdown(
          key: ValueKey(dashProvider.selectedBrand?.sId),
          initialValue: dashProvider.selectedBrand,
          items: dashProvider.brandsBySubCategory,
          hintText: dashProvider.selectedBrand?.name ?? 'Select Brand',
          displayItem: (Brand? brand) => brand?.name ?? '',
          onChanged: (newValue) {
            if (newValue != null) {
              dashProvider.selectedBrand = newValue;
              dashProvider.updateUI();
            }
          },
          validator: (value) {
            if (value == null) {
              return 'Please brand';
            }
            return null;
          },
        );
      },
    );
  }

  Widget _buildPriceSection(BuildContext context) {
    return ResponsiveUtils.isMobile(context)
        ? Column(
            children: [
              CustomTextField(
                controller: context.dashBoardProvider.productPriceCtrl,
                labelText: 'Price',
                inputType: TextInputType.number,
                onSave: (val) {},
                validator: (value) {
                  if (value == null) {
                    return 'Please enter price';
                  }
                  return null;
                },
              ),
              SizedBox(height: 8),
              CustomTextField(
                controller: context.dashBoardProvider.productOffPriceCtrl,
                labelText: 'Offer price',
                inputType: TextInputType.number,
                onSave: (val) {},
              ),
              SizedBox(height: 8),
              CustomTextField(
                controller: context.dashBoardProvider.productQntCtrl,
                labelText: 'Quantity',
                inputType: TextInputType.number,
                onSave: (val) {},
                validator: (value) {
                  if (value == null) {
                    return 'Please enter quantity';
                  }
                  return null;
                },
              ),
            ],
          )
        : Row(
            children: [
              Expanded(
                child: CustomTextField(
                  controller: context.dashBoardProvider.productPriceCtrl,
                  labelText: 'Price',
                  inputType: TextInputType.number,
                  onSave: (val) {},
                  validator: (value) {
                    if (value == null) {
                      return 'Please enter price';
                    }
                    return null;
                  },
                ),
              ),
              SizedBox(width: 8),
              Expanded(
                child: CustomTextField(
                  controller: context.dashBoardProvider.productOffPriceCtrl,
                  labelText: 'Offer price',
                  inputType: TextInputType.number,
                  onSave: (val) {},
                ),
              ),
              SizedBox(width: 8),
              Expanded(
                child: CustomTextField(
                  controller: context.dashBoardProvider.productQntCtrl,
                  labelText: 'Quantity',
                  inputType: TextInputType.number,
                  onSave: (val) {},
                  validator: (value) {
                    if (value == null) {
                      return 'Please enter quantity';
                    }
                    return null;
                  },
                ),
              ),
            ],
          );
  }

  Widget _buildVariantSection(BuildContext context) {
    return ResponsiveUtils.isMobile(context)
        ? Column(
            children: [
              _buildVariantTypeDropdown(context),
              SizedBox(height: 8),
              _buildVariantMultiSelect(context),
            ],
          )
        : Row(
            children: [
              Expanded(child: _buildVariantTypeDropdown(context)),
              SizedBox(width: 8),
              Expanded(child: _buildVariantMultiSelect(context)),
            ],
          );
  }

  Widget _buildVariantTypeDropdown(BuildContext context) {
    return Consumer<DashBoardProvider>(
      builder: (context, dashProvider, child) {
        return CustomDropdown(
          key: ValueKey(dashProvider.selectedVariantType?.sId),
          initialValue: dashProvider.selectedVariantType,
          items: context.dataProvider.variantTypes,
          displayItem: (VariantType? variantType) => variantType?.name ?? '',
          onChanged: (newValue) {
            if (newValue != null) {
              context.dashBoardProvider.filterVariant(newValue);
            }
          },
          hintText: 'Select Variant type',
        );
      },
    );
  }

  Widget _buildVariantMultiSelect(BuildContext context) {
    return Consumer<DashBoardProvider>(
      builder: (context, dashProvider, child) {
        final filteredSelectedItems = dashProvider.selectedVariants
            .where((item) => dashProvider.variantsByVariantType.contains(item))
            .toList();
        return MultiSelectDropDown(
          items: dashProvider.variantsByVariantType,
          onSelectionChanged: (newValue) {
            dashProvider.selectedVariants = newValue;
            dashProvider.updateUI();
          },
          displayItem: (String item) => item,
          selectedItems: filteredSelectedItems,
        );
      },
    );
  }

  Widget _buildActionButtons(BuildContext context) {
    return Container(
      padding: EdgeInsets.only(top: 16, bottom: 8),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          ElevatedButton(
            style: ElevatedButton.styleFrom(
              foregroundColor: Colors.white,
              backgroundColor: secondaryColor,
              padding: EdgeInsets.symmetric(horizontal: 20, vertical: 12),
            ),
            onPressed: () {
              Navigator.of(context).pop();
            },
            child: Text('Cancel'),
          ),
          SizedBox(width: ResponsiveUtils.getPadding(context)),
          ElevatedButton(
            style: ElevatedButton.styleFrom(
              foregroundColor: Colors.white,
              backgroundColor: primaryColor,
              padding: EdgeInsets.symmetric(horizontal: 20, vertical: 12),
            ),
            onPressed: () {
              if (context.dashBoardProvider.addProductFormKey.currentState!
                  .validate()) {
                context.dashBoardProvider.addProductFormKey.currentState!
                    .save();
                context.dashBoardProvider.submitProduct();
                Navigator.of(context).pop();
              }
            },
            child: Text('Submit'),
          ),
        ],
      ),
    );
  }
}

class _ImageCardData {
  final String label;
  final int number;
  final String? imageUrl;

  _ImageCardData(this.label, this.number, this.imageUrl);
}

extension SafeList<T> on List<T>? {
  T? safeElementAt(int index) {
    if (this == null || index < 0 || index >= this!.length) {
      return null;
    }
    return this![index];
  }
}

void showAddProductForm(BuildContext context, Product? product) {
  showDialog(
    context: context,
    builder: (BuildContext context) {
      return CompactFormDialog(
        title: 'Add Product',
        child: ProductSubmitForm(product: product),
      );
    },
  );
}

========== FILE: lib/screens/dashboard/components/chart.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';

import '../../../core/data/data_provider.dart';
import 'package:fl_chart/fl_chart.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../../utility/constants.dart';

class Chart extends StatelessWidget {
  const Chart({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return SizedBox(
      height: 200,
      child: Stack(
        children: [
          PieChart(
            PieChartData(
              sectionsSpace: 0,
              centerSpaceRadius: 70,
              startDegreeOffset: -90,
              sections: _buildPieChartSelectionData(context),
            ),
          ),
          Positioned.fill(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                SizedBox(height: defaultPadding),
                Consumer<DataProvider>(
                  builder: (context, dataProvider, child) {
                    return Text(
                      '${context.dataProvider.calculateOrdersWithStatus(null)}',
                      style:
                          Theme.of(context).textTheme.headlineMedium!.copyWith(
                                color: Colors.white,
                                fontWeight: FontWeight.w600,
                                height: 0.5,
                              ),
                    );
                  },
                ),
                SizedBox(height: defaultPadding),
                Text("Order"),
              ],
            ),
          ),
        ],
      ),
    );
  }

  List<PieChartSectionData> _buildPieChartSelectionData(BuildContext context) {
    Provider.of<DataProvider>(context);
    context.dataProvider.calculateOrdersWithStatus(null);
    int pendingOrder = context.dataProvider.calculateOrdersWithStatus(
      'pending',
    );
    int processingOrder = context.dataProvider.calculateOrdersWithStatus(
      'processing',
    );
    int cancelledOrder = context.dataProvider.calculateOrdersWithStatus(
      'cancelled',
    );
    int shippedOrder = context.dataProvider.calculateOrdersWithStatus(
      'shipped',
    );
    int deliveredOrder = context.dataProvider.calculateOrdersWithStatus(
      'delivered',
    );

    List<PieChartSectionData> pieChartSelectionData = [
      PieChartSectionData(
        color: Color(0xFFFFCF26),
        value: pendingOrder.toDouble(),
        showTitle: false,
        radius: 20,
      ),
      PieChartSectionData(
        color: Color(0xFFEE2727),
        value: cancelledOrder.toDouble(),
        showTitle: false,
        radius: 20,
      ),
      PieChartSectionData(
        color: Color(0xFF2697FF),
        value: shippedOrder.toDouble(),
        showTitle: false,
        radius: 20,
      ),
      PieChartSectionData(
        color: Color(0xFF26FF31),
        value: deliveredOrder.toDouble(),
        showTitle: false,
        radius: 20,
      ),
      PieChartSectionData(
        color: Colors.white,
        value: processingOrder.toDouble(),
        showTitle: false,
        radius: 20,
      ),
    ];

    return pieChartSelectionData;
  }
}

========== FILE: lib/screens/dashboard/components/dash_board_header.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';
import 'package:flutter/material.dart';
import '../../../widgets/responsive_header.dart';

class DashBoardHeader extends StatelessWidget {
  const DashBoardHeader({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return ResponsiveHeader(
      title: "Dashboard",
      onSearch: (val) => context.dataProvider.filterProducts(val),
    );
  }
}

========== FILE: lib/screens/dashboard/components/order_details_section.dart ==========

import '../../../core/data/data_provider.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../../utility/constants.dart';
import 'chart.dart';
import 'order_info_card.dart';

class OrderDetailsSection extends StatelessWidget {
  const OrderDetailsSection({super.key});

  @override
  Widget build(BuildContext context) {
    return Consumer<DataProvider>(
      builder: (context, dataProvider, child) {
        int totalOrder = dataProvider.calculateOrdersWithStatus(null);
        int pendingOrder = dataProvider.calculateOrdersWithStatus('pending');
        int processingOrder = dataProvider.calculateOrdersWithStatus(
          'processing',
        );
        int cancelledOrder = dataProvider.calculateOrdersWithStatus(
          'cancelled',
        );
        int shippedOrder = dataProvider.calculateOrdersWithStatus('shipped');
        int deliveredOrder = dataProvider.calculateOrdersWithStatus(
          'delivered',
        );
        return Container(
          padding: EdgeInsets.all(defaultPadding),
          decoration: BoxDecoration(
            color: secondaryColor,
            borderRadius: const BorderRadius.all(Radius.circular(10)),
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                "Orders Details",
                style: TextStyle(fontSize: 18, fontWeight: FontWeight.w500),
              ),
              SizedBox(height: defaultPadding),
              Chart(),
              OrderInfoCard(
                svgSrc: "assets/icons/delivery1.svg",
                title: "All Orders",
                totalOrder: totalOrder,
              ),
              OrderInfoCard(
                svgSrc: "assets/icons/delivery5.svg",
                title: "Pending Orders",
                totalOrder: pendingOrder,
              ),
              OrderInfoCard(
                svgSrc: "assets/icons/delivery6.svg",
                title: "Processed Orders",
                totalOrder: processingOrder,
              ),
              OrderInfoCard(
                svgSrc: "assets/icons/delivery2.svg",
                title: "Cancelled Orders",
                totalOrder: cancelledOrder,
              ),
              OrderInfoCard(
                svgSrc: "assets/icons/delivery4.svg",
                title: "Shipped Orders",
                totalOrder: shippedOrder,
              ),
              OrderInfoCard(
                svgSrc: "assets/icons/delivery3.svg",
                title: "Delivered Orders",
                totalOrder: deliveredOrder,
              ),
            ],
          ),
        );
      },
    );
  }
}

========== FILE: lib/screens/dashboard/components/order_info_card.dart ==========

import 'package:flutter/material.dart';
import 'package:flutter_svg/flutter_svg.dart';
import '../../../utility/constants.dart';

class OrderInfoCard extends StatelessWidget {
  const OrderInfoCard({
    Key? key,
    required this.title,
    required this.svgSrc,
    required this.totalOrder,
  }) : super(key: key);

  final String title, svgSrc;
  final int totalOrder;

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: EdgeInsets.only(top: defaultPadding),
      padding: EdgeInsets.all(defaultPadding),
      decoration: BoxDecoration(
        border: Border.all(width: 2, color: primaryColor.withOpacity(0.15)),
        borderRadius: const BorderRadius.all(
          Radius.circular(defaultPadding),
        ),
      ),
      child: Row(
        children: [
          SizedBox(
            height: 20,
            width: 20,
            child: SvgPicture.asset(svgSrc),
          ),
          Expanded(
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal: defaultPadding),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                  ),
                  Text(
                    "$totalOrder Files",
                    style: Theme.of(context)
                        .textTheme
                        .bodySmall!
                        .copyWith(color: Colors.white70),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }
}

========== FILE: lib/screens/dashboard/components/product_list_section.dart ==========

import 'package:admin_panal_start/services/admin_auth_service.dart';
import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:admin_panal_start/widgets/responsive_data_table.dart';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:get/get.dart';
import 'package:get/get_core/src/get_main.dart';
import '../../../core/data/data_provider.dart';
import '../../../models/product.dart';
import 'add_product_form.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../../utility/constants.dart';

class ProductListSection extends StatelessWidget {
  const ProductListSection({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
      decoration: const BoxDecoration(
        color: secondaryColor,
        borderRadius: BorderRadius.all(Radius.circular(10)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text("All Products", style: Theme.of(context).textTheme.titleMedium),
          const SizedBox(height: defaultPadding),
          Consumer<DataProvider>(
            builder: (context, dataProvider, child) {
              return ResponsiveDataTable(
                dataRowMinHeight: 70,
                dataRowMaxHeight: 90,
                columns: const [
                  DataColumn(label: Text("Product")),
                  DataColumn(label: Text("Category")),
                  DataColumn(label: Text("Sub Category")),
                  DataColumn(label: Text("Price")),
                  DataColumn(label: Text("Edit")),
                  DataColumn(label: Text("Delete")),
                ],
                rows: List.generate(
                  dataProvider.products.length,
                  (index) => productDataRow(
                    context, // Add context
                    dataProvider.products[index],
                    index + 1,
                    edit: () {
                      showAddProductForm(context, dataProvider.products[index]);
                    },
                    delete: () {
                      context.dashBoardProvider
                          .deleteProduct(dataProvider.products[index]);
                    },
                  ),
                ),
              );
            },
          ),
        ],
      ),
    );
  }
}

DataRow productDataRow(BuildContext context, productInfo, int index,
    {Function? edit, Function? delete}) {
  return DataRow(
    cells: [
      DataCell(
        Container(
          constraints: const BoxConstraints(minHeight: 60),
          child: Row(
            children: [
              Container(
                width: 40,
                height: 40,
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(6),
                  color: Colors.grey[800],
                ),
                child: _buildProductImage(productInfo),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      productInfo.name ?? 'No Name',
                      style: const TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.w500,
                        fontSize: 14,
                      ),
                      overflow: TextOverflow.ellipsis,
                      maxLines: 2,
                    ),
                    if (productInfo.description != null &&
                        productInfo.description!.isNotEmpty)
                      Text(
                        productInfo.description!,
                        style: const TextStyle(
                          color: Colors.white70,
                          fontSize: 12,
                        ),
                        overflow: TextOverflow.ellipsis,
                        maxLines: 1,
                      ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
      DataCell(
        Container(
          constraints: const BoxConstraints(minHeight: 60),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                productInfo.proCategoryId?.name ?? 'N/A',
                style: const TextStyle(color: Colors.white70),
                overflow: TextOverflow.ellipsis,
                maxLines: 2,
              ),
            ],
          ),
        ),
      ),
      DataCell(
        Container(
          constraints: const BoxConstraints(minHeight: 60),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                productInfo.proSubCategoryId?.name ?? 'N/A',
                style: const TextStyle(color: Colors.white70),
                overflow: TextOverflow.ellipsis,
                maxLines: 2,
              ),
            ],
          ),
        ),
      ),
      DataCell(
        Container(
          constraints: const BoxConstraints(minHeight: 60),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                '\$${productInfo.price?.toStringAsFixed(2) ?? '0.00'}',
                style: const TextStyle(
                  color: Colors.white,
                  fontWeight: FontWeight.w600,
                ),
              ),
              if (productInfo.offerPrice != null && productInfo.offerPrice! > 0)
                Text(
                  '\$${productInfo.offerPrice?.toStringAsFixed(2)}',
                  style: const TextStyle(
                    color: Colors.green,
                    fontSize: 12,
                    decoration: TextDecoration.lineThrough,
                  ),
                ),
            ],
          ),
        ),
      ),
      DataCell(
        Container(
          constraints: const BoxConstraints(minHeight: 60),
          child: Center(
            child: Get.find<AdminAuthService>().canEditItem(productInfo)
                ? IconButton(
                    onPressed: () {
                      if (edit != null) edit();
                    },
                    icon: const Icon(Icons.edit, color: Colors.blue, size: 20),
                    tooltip: 'Edit Product',
                  )
                : const Icon(Icons.lock, color: Colors.grey, size: 20),
          ),
        ),
      ),
      DataCell(
        Container(
          constraints: const BoxConstraints(minHeight: 60),
          child: Center(
            child: Get.find<AdminAuthService>().canDeleteItem(productInfo)
                ? IconButton(
                    onPressed: () {
                      if (delete != null) delete();
                    },
                    icon: const Icon(Icons.delete, color: Colors.red, size: 20),
                    tooltip: 'Delete Product',
                  )
                : const Icon(Icons.lock, color: Colors.grey, size: 20),
          ),
        ),
      ),
    ],
  );
}

Widget _buildProductImage(Product product) {
  final hasImages = product.images != null &&
      product.images!.isNotEmpty &&
      product.images![0].url != null &&
      product.images![0].url!.isNotEmpty;

  if (!hasImages) {
    return Icon(Icons.image, color: Colors.grey[400], size: 20);
  }

  return ClipRRect(
    borderRadius: BorderRadius.circular(6),
    child: CachedNetworkImage(
      imageUrl: product.images![0].url!,
      width: 40,
      height: 40,
      fit: BoxFit.cover,
      placeholder: (context, url) => Center(
        child: SizedBox(
          width: 16,
          height: 16,
          child: CircularProgressIndicator(
            strokeWidth: 2,
            valueColor: const AlwaysStoppedAnimation<Color>(Colors.white),
          ),
        ),
      ),
      errorWidget: (context, url, error) => const Icon(
        Icons.error,
        color: Colors.red,
        size: 20,
      ),
    ),
  );
}

========== FILE: lib/screens/dashboard/components/product_summery_card.dart ==========

import 'package:flutter/material.dart';
import 'package:flutter_svg/flutter_svg.dart';
import '../../../utility/constants.dart';
import '../../../models/product_summery_info.dart';


class ProductSummeryCard extends StatelessWidget {
  const ProductSummeryCard({
    Key? key,
    required this.info, required this.onTap,
  }) : super(key: key);

  final ProductSummeryInfo info;
  final Function(String?) onTap;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: (){
        onTap(info.title);
      },
      child: Container(
        padding: EdgeInsets.all(defaultPadding),
        decoration: BoxDecoration(
          color: secondaryColor,
          borderRadius: const BorderRadius.all(Radius.circular(10)),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Container(
                  padding: EdgeInsets.all(defaultPadding * 0.75),
                  height: 40,
                  width: 40,
                  decoration: BoxDecoration(
                    color: info.color!.withOpacity(0.1),
                    borderRadius: const BorderRadius.all(Radius.circular(10)),
                  ),
                  child: SvgPicture.asset(
                    info.svgSrc!,
                    colorFilter: ColorFilter.mode(
                        info.color ?? Colors.black, BlendMode.srcIn),
                  ),
                ),
                Icon(Icons.more_vert, color: Colors.white54)
              ],
            ),
            Text(
              info.title!,
              maxLines: 1,
              overflow: TextOverflow.ellipsis,
            ),
            ProgressLine(
              color: info.color,
              percentage: info.percentage,
            ),
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(
                  "${info.productsCount} Product",
                  style: Theme.of(context)
                      .textTheme
                      .bodySmall!
                      .copyWith(color: Colors.white70),
                ),
              ],
            )
          ],
        ),
      ),
    );
  }
}

class ProgressLine extends StatelessWidget {
  const ProgressLine({
    Key? key,
    this.color = primaryColor,
    required this.percentage,
  }) : super(key: key);

  final Color? color;
  final double? percentage;

  @override
  Widget build(BuildContext context) {
    return Stack(
      children: [
        Container(
          width: double.infinity,
          height: 5,
          decoration: BoxDecoration(
            color: color!.withOpacity(0.1),
            borderRadius: BorderRadius.all(Radius.circular(10)),
          ),
        ),
        LayoutBuilder(
          builder: (context, constraints) => Container(
            width: constraints.maxWidth * (percentage! / 100),
            height: 5,
            decoration: BoxDecoration(
              color: color,
              borderRadius: BorderRadius.all(Radius.circular(10)),
            ),
          ),
        ),
      ],
    );
  }
}

========== FILE: lib/screens/dashboard/components/product_summery_section.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../../core/data/data_provider.dart';
import '../../../models/product_summery_info.dart';
import '../../../utility/constants.dart';
import 'product_summery_card.dart';

class ProductSummerySection extends StatelessWidget {
  const ProductSummerySection({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Consumer<DataProvider>(
      builder: (context, dataProvider, _) {
        int totalProduct =
            context.dataProvider.calculateProductWithQuantity(null);
        int outOfStockProduct =
            context.dataProvider.calculateProductWithQuantity(0);
        int limitedStockProduct =
            context.dataProvider.calculateProductWithQuantity(1);
        int otherStockProduct =
            totalProduct - outOfStockProduct - limitedStockProduct;

        List<ProductSummeryInfo> productSummeryItems = [
          ProductSummeryInfo(
            title: "All Product",
            productsCount: totalProduct,
            svgSrc: "assets/icons/Product.svg",
            color: primaryColor,
            percentage: 100,
          ),
          ProductSummeryInfo(
            title: "Out of Stock",
            productsCount: outOfStockProduct,
            svgSrc: "assets/icons/Product2.svg",
            color: Color(0xFFEA3829),
            percentage: totalProduct != 0
                ? (outOfStockProduct / totalProduct) * 100
                : 0,
          ),
          ProductSummeryInfo(
            title: "Limited Stock",
            productsCount: limitedStockProduct,
            svgSrc: "assets/icons/Product3.svg",
            color: Color(0xFFECBE23),
            percentage: totalProduct != 0
                ? (limitedStockProduct / totalProduct) * 100
                : 0,
          ),
          ProductSummeryInfo(
            title: "Other Stock",
            productsCount: otherStockProduct,
            svgSrc: "assets/icons/Product4.svg",
            color: Color(0xFF47e228),
            percentage: totalProduct != 0
                ? (otherStockProduct / totalProduct) * 100
                : 0,
          ),
        ];

        return GridView.builder(
          physics: NeverScrollableScrollPhysics(),
          shrinkWrap: true,
          itemCount: productSummeryItems.length,
          gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
            crossAxisCount: ResponsiveUtils.getGridCrossAxisCount(context),
            crossAxisSpacing: defaultPadding,
            mainAxisSpacing: defaultPadding,
            childAspectRatio: _getAspectRatio(context),
          ),
          itemBuilder: (context, index) => ProductSummeryCard(
            info: productSummeryItems[index],
            onTap: (productType) {
              context.dataProvider.filterProductsByQuantity(productType ?? '');
            },
          ),
        );
      },
    );
  }

  double _getAspectRatio(BuildContext context) {
    if (ResponsiveUtils.isMobile(context)) return 1.2;
    if (ResponsiveUtils.isTablet(context)) return 1.3;
    return 1.4;
  }
}

========== FILE: lib/screens/dashboard/dashboard_screen.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'components/dash_board_header.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import '../../utility/constants.dart';
import 'components/add_product_form.dart';
import 'components/order_details_section.dart';
import 'components/product_list_section.dart';
import 'components/product_summery_section.dart';

class DashboardScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return SafeArea(
      child: SingleChildScrollView(
        primary: false,
        padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
        child: Column(
          children: [
            DashBoardHeader(),
            Gap(defaultPadding),
            ResponsiveUtils.isMobile(context)
                ? _buildMobileLayout(context)
                : _buildDesktopLayout(context),
          ],
        ),
      ),
    );
  }

  Widget _buildMobileLayout(BuildContext context) {
    return Column(
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Expanded(
              child: Text(
                "My Products",
                style: Theme.of(context).textTheme.titleMedium,
              ),
            ),
            ElevatedButton.icon(
              style: TextButton.styleFrom(
                padding: EdgeInsets.symmetric(
                  horizontal: defaultPadding,
                  vertical: defaultPadding / 2,
                ),
              ),
              onPressed: () {
                showAddProductForm(context, null);
              },
              icon: Icon(Icons.add),
              label: Text("Add New"),
            ),
            Gap(8),
            IconButton(
              onPressed: () {
                context.dataProvider.getAllProduct(showSnack: true);
              },
              icon: Icon(Icons.refresh),
            ),
          ],
        ),
        Gap(defaultPadding),
        ProductSummerySection(),
        Gap(defaultPadding),
        ProductListSection(),
        Gap(defaultPadding),
        OrderDetailsSection(),
      ],
    );
  }

  Widget _buildDesktopLayout(BuildContext context) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Expanded(
          flex: 5,
          child: Column(
            children: [
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Expanded(
                    child: Text(
                      "My Products",
                      style: Theme.of(context).textTheme.titleMedium,
                    ),
                  ),
                  ElevatedButton.icon(
                    style: TextButton.styleFrom(
                      padding: EdgeInsets.symmetric(
                        horizontal: defaultPadding * 1.5,
                        vertical: defaultPadding,
                      ),
                    ),
                    onPressed: () {
                      showAddProductForm(context, null);
                    },
                    icon: Icon(Icons.add),
                    label: Text("Add New"),
                  ),
                  Gap(20),
                  IconButton(
                    onPressed: () {
                      context.dataProvider.getAllProduct(showSnack: true);
                    },
                    icon: Icon(Icons.refresh),
                  ),
                ],
              ),
              Gap(defaultPadding),
              ProductSummerySection(),
              Gap(defaultPadding),
              ProductListSection(),
            ],
          ),
        ),
        if (!ResponsiveUtils.isMobile(context)) ...[
          SizedBox(width: defaultPadding),
          Expanded(flex: 2, child: OrderDetailsSection()),
        ],
      ],
    );
  }
}

========== FILE: lib/screens/dashboard/provider/dash_board_provider.dart ==========

import 'dart:io';
import 'package:admin_panal_start/services/admin_auth_service.dart';
import 'package:admin_panal_start/utility/snack_bar_helper.dart';
import 'package:admin_panal_start/widgets/camera_picker_dialog.dart';
import '../../../models/brand.dart';
import '../../../models/sub_category.dart';
import '../../../models/variant_type.dart';
import 'package:flutter/foundation.dart' hide Category;
import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:image_picker/image_picker.dart';
import '../../../core/data/data_provider.dart';
import '../../../models/category.dart';
import '../../../services/http_services.dart';
import '../../../models/product.dart';
import 'package:admin_panal_start/models/api_response.dart';

class DashBoardProvider extends ChangeNotifier {
  HttpService service = HttpService();
  final DataProvider _dataProvider;
  final addProductFormKey = GlobalKey<FormState>();

  //?text editing controllers in dashBoard screen
  TextEditingController productNameCtrl = TextEditingController();
  TextEditingController productDescCtrl = TextEditingController();
  TextEditingController productQntCtrl = TextEditingController();
  TextEditingController productPriceCtrl = TextEditingController();
  TextEditingController productOffPriceCtrl = TextEditingController();

  //? dropdown value
  Category? selectedCategory;
  SubCategory? selectedSubCategory;
  Brand? selectedBrand;
  VariantType? selectedVariantType;
  List<String> selectedVariants = [];

  Product? productForUpdate;
  File? selectedMainImage,
      selectedSecondImage,
      selectedThirdImage,
      selectedFourthImage,
      selectedFifthImage;
  XFile? mainImgXFile,
      secondImgXFile,
      thirdImgXFile,
      fourthImgXFile,
      fifthImgXFile;

  List<SubCategory> subCategoriesByCategory = [];
  List<Brand> brandsBySubCategory = [];
  List<String> variantsByVariantType = [];

  DashBoardProvider(this._dataProvider);

  addProduct() async {
    try {
      if (selectedMainImage == null) {
        SnackBarHelper.showErrorSnackBar("Select the main image");
        return;
      }

      final authService = Get.find<AdminAuthService>();
      final currentUserId = authService.getUserId();

      // ‚úÖ CORRECTED - Use current user ID
      Map<String, dynamic> formDataMap = {
        'name': productNameCtrl.text,
        'description': productDescCtrl.text,
        'quantity': productQntCtrl.text,
        'price': productPriceCtrl.text,
        'offerPrice': productOffPriceCtrl.text.isEmpty
            ? productPriceCtrl.text
            : productOffPriceCtrl.text,
        'proCategoryId': selectedCategory?.sId ?? '',
        'proSubCategoryId': selectedSubCategory?.sId ?? '',
        'proBrandId': selectedBrand?.sId ?? '',
        'proVariantTypeId': selectedVariantType?.sId ?? '',
        'proVariantId': selectedVariants,
        'createdBy': currentUserId // ‚úÖ Use current admin's ID
      };

      final FormData form = await createFormDataForMultipleImage(
        imgXFiles: [
          {'image1': mainImgXFile},
          {'image2': secondImgXFile},
          {'image3': thirdImgXFile},
          {'image4': fourthImgXFile},
          {'image5': fifthImgXFile},
        ],
        formData: formDataMap,
      );

      final response = await service.addItem(
        endpointUrl: 'products',
        itemData: form,
      );

      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          clearFields();
          SnackBarHelper.showSuccessSnackBar('Product added successfully');
          _dataProvider.getAllProduct();
        } else {
          SnackBarHelper.showErrorSnackBar(
            "Failed to add product: ${apiResponse.message}",
          );
        }
      } else {
        SnackBarHelper.showErrorSnackBar(
          "Error: ${response.body?["message"] ?? response.statusText}",
        );
      }
    } catch (e) {
      print("Add product error: $e");
      SnackBarHelper.showErrorSnackBar("An error occurred: $e");
    }
  }

  updateProduct() async {
    try {
      Map<String, dynamic> formDataMap = {
        'name': productNameCtrl.text,
        'description': productDescCtrl.text,
        'quantity': productQntCtrl.text,
        'price': productPriceCtrl.text,
        'offerPrice': productOffPriceCtrl.text.isEmpty
            ? productPriceCtrl.text
            : productOffPriceCtrl.text,
        'proCategoryId': selectedCategory?.sId ?? '',
        'proSubCategoryId': selectedSubCategory?.sId ?? '',
        'proBrandId': selectedBrand?.sId ?? '',
        'proVariantTypeId': selectedVariantType?.sId ?? '',
        'proVariantId': selectedVariants,
      };

      final FormData form = await createFormDataForMultipleImage(
        imgXFiles: [
          {'image1': mainImgXFile},
          {'image2': secondImgXFile},
          {'image3': thirdImgXFile},
          {'image4': fourthImgXFile},
          {'image5': fifthImgXFile},
        ],
        formData: formDataMap,
      );

      if (productForUpdate != null) {
        final response = await service.updateItem(
          endpointUrl: 'products',
          itemData: form,
          itemId: '${productForUpdate?.sId}',
        );

        if (response.isOk) {
          ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
          if (apiResponse.success) {
            clearFields();
            SnackBarHelper.showSuccessSnackBar('Product updated successfully');
            _dataProvider.getAllProduct();
          } else {
            SnackBarHelper.showErrorSnackBar(
              "Failed to update product: ${apiResponse.message}",
            );
          }
        } else {
          SnackBarHelper.showErrorSnackBar(
            "Error: ${response.body?["message"] ?? response.statusText}",
          );
        }
      }
    } catch (e) {
      print("Update product error: $e");
      SnackBarHelper.showErrorSnackBar("An error occurred: $e");
    }
  }

  submitProduct() {
    if (productForUpdate != null) {
      updateProduct();
    } else {
      addProduct();
    }
  }

  deleteProduct(Product product) async {
    try {
      Response response = await service.deleteItem(
        endpointUrl: 'products',
        itemId: product.sId ?? '',
      );
      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          SnackBarHelper.showSuccessSnackBar("product delted successfully");
          _dataProvider.getAllProduct();
        } else {
          SnackBarHelper.showErrorSnackBar(
            "Error ${response.body?["message"] ?? response.status}",
          );
        }
      }
    } catch (e) {
      print(e);
      rethrow;
    }
  }

  void pickImage(
      {required int imageCardNumber, required BuildContext context}) async {
    showCameraPickerDialog(context, (XFile? image) async {
      if (image != null) {
        if (imageCardNumber == 1) {
          selectedMainImage = File(image.path);
          mainImgXFile = image;
        } else if (imageCardNumber == 2) {
          selectedSecondImage = File(image.path);
          secondImgXFile = image;
        } else if (imageCardNumber == 3) {
          selectedThirdImage = File(image.path);
          thirdImgXFile = image;
        } else if (imageCardNumber == 4) {
          selectedFourthImage = File(image.path);
          fourthImgXFile = image;
        } else if (imageCardNumber == 5) {
          selectedFifthImage = File(image.path);
          fifthImgXFile = image;
        }
        notifyListeners();
      }
    });
  }

  Future<FormData> createFormDataForMultipleImage({
    required List<Map<String, XFile?>>? imgXFiles,
    required Map<String, dynamic> formData,
  }) async {
    formData.forEach((key, value) {});

    int imageCount = 0;

    // Loop over the provided image files and add them to the form data
    if (imgXFiles != null) {
      for (int i = 0; i < imgXFiles.length; i++) {
        String imageKey = 'image${i + 1}';
        XFile? imgXFile = imgXFiles[i][imageKey];

        if (imgXFile != null) {
          imageCount++;

          // Check if it's running on the web
          if (kIsWeb) {
            String fileName = imgXFile.name;
            Uint8List byteImg = await imgXFile.readAsBytes();
            formData[imageKey] = MultipartFile(
              byteImg,
              filename: fileName,
            );
          } else {
            String filePath = imgXFile.path;
            String fileName = filePath.split('/').last;
            File file = File(filePath);
            if (await file.exists()) {
              final fileSize = await file.length();
              formData[imageKey] = await MultipartFile(
                filePath,
                filename: fileName,
              );
            } else {}
          }
        } else {}
      }
    }

    // Create and return the FormData object
    final FormData form = FormData(formData);

    return form;
  }

  filterSubcategory(Category category) {
    selectedBrand = null;
    selectedCategory = category;
    selectedSubCategory = null;
    subCategoriesByCategory.clear();
    final newList = _dataProvider.subCategories
        .where((subcategory) => subcategory.categoryId?.sId == category.sId)
        .toList();
    subCategoriesByCategory = newList;
    notifyListeners();
  }

  filterBrand(SubCategory subCategory) {
    selectedBrand = null;
    selectedSubCategory = subCategory;
    brandsBySubCategory.clear();
    final newList = _dataProvider.brands
        .where((brand) => brand.subcategoryId?.sId == subCategory.sId)
        .toList();
    brandsBySubCategory = newList;
    notifyListeners();
  }

  filterVariant(VariantType variantType) {
    selectedVariants = [];
    selectedVariantType = variantType;
    variantsByVariantType.clear();
    final newList = _dataProvider.variants
        .where((variant) => variant.variantTypeId?.sId == variantType.sId)
        .toList();
    variantsByVariantType =
        newList.map((variant) => variant.name ?? '').toList();
    notifyListeners();
  }

  setDataForUpdateProduct(Product? product) {
    if (product != null) {
      productForUpdate = product;

      productNameCtrl.text = product.name ?? '';
      productDescCtrl.text = product.description ?? '';
      productPriceCtrl.text = product.price.toString();
      productOffPriceCtrl.text = '${product.offerPrice}';
      productQntCtrl.text = '${product.quantity}';

      selectedCategory = _dataProvider.categories.firstWhereOrNull(
        (element) => element.sId == product.proCategoryId?.sId,
      );

      final newListCategory = _dataProvider.subCategories
          .where(
            (subcategory) =>
                subcategory.categoryId?.sId == product.proCategoryId?.sId,
          )
          .toList();
      subCategoriesByCategory = newListCategory;
      selectedSubCategory = _dataProvider.subCategories.firstWhereOrNull(
        (element) => element.sId == product.proSubCategoryId?.sId,
      );

      final newListBrand = _dataProvider.brands
          .where(
            (brand) =>
                brand.subcategoryId?.sId == product.proSubCategoryId?.sId,
          )
          .toList();
      brandsBySubCategory = newListBrand;
      selectedBrand = _dataProvider.brands.firstWhereOrNull(
        (element) => element.sId == product.proBrandId?.sId,
      );

      selectedVariantType = _dataProvider.variantTypes.firstWhereOrNull(
        (element) => element.sId == product.proVariantTypeId?.sId,
      );

      final newListVariant = _dataProvider.variants
          .where(
            (variant) =>
                variant.variantTypeId?.sId == product.proVariantTypeId?.sId,
          )
          .toList();
      final List<String> variantNames =
          newListVariant.map((variant) => variant.name ?? '').toList();
      variantsByVariantType = variantNames;
      selectedVariants = product.proVariantId ?? [];
    } else {
      clearFields();
    }
  }

  clearFields() {
    productNameCtrl.clear();
    productDescCtrl.clear();
    productPriceCtrl.clear();
    productOffPriceCtrl.clear();
    productQntCtrl.clear();

    selectedMainImage = null;
    selectedSecondImage = null;
    selectedThirdImage = null;
    selectedFourthImage = null;
    selectedFifthImage = null;

    mainImgXFile = null;
    secondImgXFile = null;
    thirdImgXFile = null;
    fourthImgXFile = null;
    fifthImgXFile = null;

    selectedCategory = null;
    selectedSubCategory = null;
    selectedBrand = null;
    selectedVariantType = null;
    selectedVariants = [];

    productForUpdate = null;

    subCategoriesByCategory = [];
    brandsBySubCategory = [];
    variantsByVariantType = [];
  }

  updateUI() {
    notifyListeners();
  }
}

========== FILE: lib/screens/main/components/side_menu.dart ==========

import 'package:admin_panal_start/services/admin_auth_service.dart';
import 'package:admin_panal_start/utility/constants.dart';
import 'package:get/get.dart';
import '../../../utility/extensions.dart';
import 'package:flutter/material.dart';

class SideMenu extends StatelessWidget {
  final VoidCallback onItemSelected;
  final bool compact;

  const SideMenu({
    Key? key,
    required this.onItemSelected,
    this.compact = false,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final AdminAuthService adminAuthService = Get.find<AdminAuthService>();

    return Container(
      width: compact ? 80 : null,
      color: secondaryColor,
      child: ListView(
        shrinkWrap: true,
        physics: ClampingScrollPhysics(),
        children: [
          if (compact)
            Container(
              padding: EdgeInsets.all(defaultPadding / 2),
              child: Image.asset("assets/images/logo.png", height: 40),
            )
          else
            Container(
              padding: EdgeInsets.all(defaultPadding - 4),
              height: 110,
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                mainAxisSize: MainAxisSize.min,
                children: [
                  Container(
                    height: 45,
                    child: Image.asset(
                      "assets/images/logo.png",
                      fit: BoxFit.contain,
                    ),
                  ),
                  SizedBox(height: 4),
                ],
              ),
            ),
          _buildMenuItems(context),
          DrawerListTile(
            title: "Logout",
            icon: Icons.logout,
            compact: compact,
            press: () {
              _showLogoutDialog(context);
            },
          ),
        ],
      ),
    );
  }

  Widget _buildMenuItems(BuildContext context) {
    final authService = Get.find<AdminAuthService>();
    final menuItems = [
      {"title": "Dashboard", "icon": Icons.dashboard, "screen": "Dashboard"},
      {"title": "Category", "icon": Icons.category, "screen": "Category"},
      {
        "title": "Sub Category",
        "icon": Icons.subdirectory_arrow_right,
        "screen": "SubCategory"
      },
      {"title": "Brands", "icon": Icons.branding_watermark, "screen": "Brands"},
      {
        "title": "Variant Type",
        "icon": Icons.type_specimen,
        "screen": "VariantType"
      },
      {"title": "Variants", "icon": Icons.widgets, "screen": "Variants"},
      {"title": "Orders", "icon": Icons.shopping_cart, "screen": "Order"},
      {
        "title": "Payment Verification",
        "icon": Icons.verified,
        "screen": "PaymentVerification"
      },
      {"title": "Coupons", "icon": Icons.discount, "screen": "Coupon"},
      {"title": "Posters", "icon": Icons.photo, "screen": "Poster"},
      {"title": "Ratings & Reviews", "icon": Icons.star, "screen": "Ratings"},
      {
        "title": "Notifications",
        "icon": Icons.notifications,
        "screen": "Notifications"
      },
    ];

    if (authService.canManageUsers()) {
      menuItems.add({
        "title": "User Management",
        "icon": Icons.people,
        "screen": "Users"
      });
    }

    return Column(
      mainAxisSize: MainAxisSize.min,
      children: menuItems
          .map((item) => DrawerListTile(
                title: item["title"] as String,
                icon: item["icon"] as IconData,
                compact: compact,
                press: () {
                  context.mainScreenProvider
                      .navigateToScreen(item["screen"] as String);
                  onItemSelected();
                },
              ))
          .toList(),
    );
  }

  void _showLogoutDialog(BuildContext context) {
    final adminAuthService = Get.find<AdminAuthService>();

    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: secondaryColor,
        title: Text(
          "Logout",
          style: TextStyle(color: Colors.white),
        ),
        content: Text(
          "Are you sure you want to logout?",
          style: TextStyle(color: Colors.white70),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: Text("Cancel", style: TextStyle(color: Colors.white70)),
          ),
          ElevatedButton(
            onPressed: () async {
              Navigator.of(context).pop();
              await adminAuthService.logout();
              Get.offAllNamed('/login');
            },
            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
            child: Text("Logout"),
          ),
        ],
      ),
    );
  }
}

class DrawerListTile extends StatelessWidget {
  const DrawerListTile({
    Key? key,
    required this.title,
    required this.press,
    this.compact = false,
    required this.icon,
  }) : super(key: key);

  final String title;
  final VoidCallback press;
  final bool compact;
  final IconData icon;

  @override
  Widget build(BuildContext context) {
    return ListTile(
      dense: true,
      onTap: press,
      horizontalTitleGap: compact ? 0.0 : 16.0,
      leading: Icon(icon, color: Colors.white54, size: 16),
      title: compact
          ? null
          : Text(
              title,
              style: TextStyle(color: Colors.white54, fontSize: 13),
            ),
    );
  }
}

========== FILE: lib/screens/main/main_screen.dart ==========

import 'package:admin_panal_start/core/data/data_provider.dart';
import 'package:admin_panal_start/services/admin_auth_service.dart';
import 'package:admin_panal_start/utility/constants.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:provider/provider.dart';
import 'components/side_menu.dart';
import 'provider/main_screen_provider.dart';

class MainScreen extends StatefulWidget {
  @override
  State<MainScreen> createState() => _MainScreenState();
}

class _MainScreenState extends State<MainScreen> {
  final GlobalKey<ScaffoldState> _scaffoldKey = GlobalKey<ScaffoldState>();
  bool _dataInitialized = false;
  final AdminAuthService _authService = Get.find<AdminAuthService>();

  @override
  void initState() {
    super.initState();
    _checkAuthentication();
  }

  void _checkAuthentication() {
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (!_authService.isLoggedIn.value) {
        print('üîê User not authenticated, redirecting to login');
        Get.offAllNamed('/login');
        return;
      }
      _initializeData();
    });
  }

  void _initializeData() {
    if (!_dataInitialized) {
      final dataProvider = Provider.of<DataProvider>(context, listen: false);
      print('üöÄ Initializing app data from MainScreen...');
      dataProvider.testConnection();
      dataProvider.initializeAppData();
      _dataInitialized = true;
    }
  }

  @override
  Widget build(BuildContext context) {
    // Check authentication status
    if (!_authService.isLoggedIn.value) {
      return Scaffold(
        backgroundColor: bgColor,
        body: Center(
          child: CircularProgressIndicator(),
        ),
      );
    }

    return Scaffold(
      key: _scaffoldKey,
      backgroundColor: bgColor,
      appBar: ResponsiveUtils.isMobile(context)
          ? AppBar(
              title: Text('Admin Panel'),
              backgroundColor: secondaryColor,
              leading: IconButton(
                icon: Icon(Icons.menu),
                onPressed: () => _scaffoldKey.currentState?.openDrawer(),
              ),
            )
          : null,
      drawer: ResponsiveUtils.isMobile(context)
          ? _buildMobileDrawer(context)
          : null,
      body: SafeArea(
        child: Row(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            if (!ResponsiveUtils.isMobile(context))
              _buildDesktopSidebar(context),
            Expanded(
              flex: 5,
              child: Consumer<MainScreenProvider>(
                builder: (context, provider, child) {
                  return provider.selectedScreen;
                },
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildMobileDrawer(BuildContext context) {
    return Drawer(
      backgroundColor: secondaryColor,
      width: MediaQuery.of(context).size.width * 0.8,
      child: SideMenu(
        onItemSelected: () {
          if (_scaffoldKey.currentState?.isDrawerOpen ?? false) {
            Navigator.of(context).pop();
          }
        },
      ),
    );
  }

  Widget _buildDesktopSidebar(BuildContext context) {
    return Container(
      width: ResponsiveUtils.isTablet(context) ? 80 : 250,
      child: SideMenu(
        onItemSelected: () {},
        compact: ResponsiveUtils.isTablet(context),
      ),
    );
  }
}

========== FILE: lib/screens/main/provider/main_screen_provider.dart ==========

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import '../../brands/brand_screen.dart';
import '../../category/category_screen.dart';
import '../../coupon_code/coupon_code_screen.dart';
import '../../dashboard/dashboard_screen.dart';
import '../../notification/notification_screen.dart';
import '../../order/order_screen.dart';
import '../../payment_verification/payment_verification_screen.dart';
import '../../posters/poster_screen.dart';
import '../../ratings/ratings_screen.dart';
import '../../sub_category/sub_category_screen.dart';
import '../../users/users_screen.dart';
import '../../variants/variants_screen.dart';
import '../../variants_type/variants_type_screen.dart';

class MainScreenProvider extends ChangeNotifier {
  Widget _selectedScreen = DashboardScreen();
  String _currentScreenName = 'Dashboard';

  Widget get selectedScreen => _selectedScreen;
  String get currentScreenName => _currentScreenName;

  void navigateToScreen(String screenName) {
    Widget newScreen;

    switch (screenName) {
      case 'Dashboard':
        newScreen = DashboardScreen();
        break;
      case 'Category':
        newScreen = CategoryScreen();
        break;
      case 'SubCategory':
        newScreen = SubCategoryScreen();
        break;
      case 'Brands':
        newScreen = BrandScreen();
        break;
      case 'VariantType':
        newScreen = VariantsTypeScreen();
        break;
      case 'Variants':
        newScreen = VariantsScreen();
        break;
      case 'Coupon':
        newScreen = CouponCodeScreen();
        break;
      case 'Poster':
        newScreen = PosterScreen();
        break;
      case 'Order':
        newScreen = OrderScreen();
        break;
      case 'PaymentVerification':
        newScreen = PaymentVerificationScreen();
        break;
      case 'Ratings':
        newScreen = RatingsScreen();
        break;
      case 'Notifications':
        newScreen = NotificationScreen();
        break;
      case 'Users':
        newScreen = UsersScreen();
        break;
      default:
        newScreen = DashboardScreen();
    }

    if (_selectedScreen.runtimeType != newScreen.runtimeType) {
      _selectedScreen = newScreen;
      _currentScreenName = screenName;
      notifyListeners();
    }
  }
}

========== FILE: lib/screens/notification/components/notification_header.dart ==========

import 'package:flutter/material.dart';
import '../../../widgets/responsive_header.dart';

class NotificationHeader extends StatelessWidget {
  const NotificationHeader({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return ResponsiveHeader(
      title: "Notification",
      onSearch: (val) {
        // TODO: Implement notification search when needed
      },
    );
  }
}

========== FILE: lib/screens/notification/components/notification_list_section.dart ==========

import '../../../core/data/data_provider.dart';
import '../../../models/my_notification.dart';
import 'view_notification_form.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../../utility/color_list.dart';
import '../../../utility/constants.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:admin_panal_start/widgets/responsive_data_table.dart';

class NotificationListSection extends StatelessWidget {
  const NotificationListSection({
    Key? key,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
      decoration: BoxDecoration(
        color: secondaryColor,
        borderRadius: const BorderRadius.all(Radius.circular(10)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            "All Notification",
            style: Theme.of(context).textTheme.titleMedium,
          ),
          SizedBox(
            width: double.infinity,
            child: Consumer<DataProvider>(
              builder: (context, dataProvider, child) {
                return ResponsiveDataTable(
                  columns: [
                    DataColumn(label: Text("Title")),
                    DataColumn(label: Text("Description")),
                    DataColumn(label: Text("Send Date")),
                    DataColumn(label: Text("View")),
                    DataColumn(label: Text("Delete")),
                  ],
                  rows: List.generate(
                    dataProvider.notifications.length,
                    (index) => notificationDataRow(
                        dataProvider.notifications[index], index + 1, edit: () {
                      viewNotificationStatics(
                          context, dataProvider.notifications[index]);
                    }, delete: () {
                      // TODO: should complete call deleteNotification
                    }),
                  ),
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}

DataRow notificationDataRow(MyNotification notificationInfo, int index,
    {Function? edit, Function? delete}) {
  return DataRow(
    cells: [
      DataCell(
        Row(
          children: [
            Container(
              height: 24,
              width: 24,
              decoration: BoxDecoration(
                color: colors[index % colors.length],
                shape: BoxShape.circle,
              ),
              child: Text(index.toString(), textAlign: TextAlign.center),
            ),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 8),
              child: Text(
                notificationInfo.title!,
                overflow: TextOverflow.ellipsis,
                maxLines: 1,
              ),
            ),
          ],
        ),
      ),
      DataCell(Text(
        notificationInfo.description ?? '',
        overflow: TextOverflow.ellipsis,
        maxLines: 1,
      )),
      DataCell(Text(
        notificationInfo.createdAt ?? '',
        overflow: TextOverflow.ellipsis,
        maxLines: 1,
      )),
      DataCell(IconButton(
          onPressed: () {
            if (edit != null) edit();
          },
          icon: Icon(
            Icons.remove_red_eye_sharp,
            color: Colors.white,
          ))),
      DataCell(IconButton(
          onPressed: () {
            if (delete != null) delete();
          },
          icon: Icon(
            Icons.delete,
            color: Colors.red,
          ))),
    ],
  );
}

========== FILE: lib/screens/notification/components/notification_statics_card.dart ==========

import 'package:flutter/material.dart';
import 'package:flutter_svg/flutter_svg.dart';
import 'package:gap/gap.dart';
import '../../../utility/constants.dart';

class NotificationCard extends StatelessWidget {
  final String text;
  final Color color;
  final int number;
  final double percentage;

  const NotificationCard({
    Key? key,
    required this.text,
    required this.color,
    required this.number,
    required this.percentage,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: EdgeInsets.symmetric(vertical: 5, horizontal: 8),
      decoration: BoxDecoration(
        color: secondaryColor,
        borderRadius: const BorderRadius.all(Radius.circular(10)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Container(
                padding: EdgeInsets.all(8),
                height: 32,
                width: 32,
                decoration: BoxDecoration(
                  color: color.withOpacity(0.1),
                  borderRadius: const BorderRadius.all(Radius.circular(10)),
                ),
                child: SvgPicture.asset(
                  'assets/icons/notification.svg',
                  colorFilter: ColorFilter.mode(color, BlendMode.srcIn),
                ),
              ),
            ],
          ),
          Text(
            "${number}",
            maxLines: 1,
            overflow: TextOverflow.ellipsis,
            style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
          ),
          ProgressLine(
            color: color,
            percentage: percentage,
          ),
          Gap(5),
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                "$text",
                style: Theme.of(context)
                    .textTheme
                    .bodySmall!
                    .copyWith(color: Colors.white70),
              ),
            ],
          )
        ],
      ),
    );
  }
}

class ProgressLine extends StatelessWidget {
  const ProgressLine({
    Key? key,
    this.color = primaryColor,
    required this.percentage,
  }) : super(key: key);

  final Color? color;
  final double? percentage;

  @override
  Widget build(BuildContext context) {
    return Stack(
      children: [
        Container(
          width: double.infinity,
          height: 5,
          decoration: BoxDecoration(
            color: color!.withOpacity(0.1),
            borderRadius: BorderRadius.all(Radius.circular(10)),
          ),
        ),
        LayoutBuilder(
          builder: (context, constraints) => Container(
            width: constraints.maxWidth * (percentage! / 100),
            height: 5,
            decoration: BoxDecoration(
              color: color,
              borderRadius: BorderRadius.all(Radius.circular(10)),
            ),
          ),
        ),
      ],
    );
  }
}

========== FILE: lib/screens/notification/components/send_notification_form.dart ==========

import '../../../utility/extensions.dart';
import '../../../utility/responsive_utils.dart';
import '../../../widgets/compact_form_dialog.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import '../../../utility/constants.dart';
import '../../../widgets/custom_text_field.dart';

class SendNotificationForm extends StatelessWidget {
  const SendNotificationForm({super.key});

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      child: Form(
        key: context.notificationProvider.sendNotificationFormKey,
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Gap(ResponsiveUtils.getPadding(context)),
            CustomTextField(
              controller: context.notificationProvider.titleCtrl,
              labelText: 'Enter Notification Title ....',
              onSave: (val) {},
              validator: (value) {
                if (value == null || value.isEmpty) {
                  return 'Please enter a Title name';
                }
                return null;
              },
            ),
            Gap(8),
            CustomTextField(
              controller: context.notificationProvider.descriptionCtrl,
              labelText: 'Enter Notification Description ....',
              lineNumber: 3,
              onSave: (val) {},
              validator: (value) {
                if (value == null || value.isEmpty) {
                  return 'Please enter a description ';
                }
                return null;
              },
            ),
            Gap(8),
            CustomTextField(
              controller: context.notificationProvider.imageUrlCtrl,
              labelText: 'Enter Notification Image Url ....',
              onSave: (val) {},
            ),
            Gap(ResponsiveUtils.getPadding(context) * 2),
            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                ElevatedButton(
                  style: ElevatedButton.styleFrom(
                    foregroundColor: Colors.white,
                    backgroundColor: secondaryColor,
                  ),
                  onPressed: () {
                    Navigator.of(context).pop();
                  },
                  child: Text('Cancel'),
                ),
                SizedBox(width: ResponsiveUtils.getPadding(context)),
                ElevatedButton(
                  style: ElevatedButton.styleFrom(
                    foregroundColor: Colors.white,
                    backgroundColor: primaryColor,
                  ),
                  onPressed: () {
                    if (context.notificationProvider.sendNotificationFormKey
                        .currentState!
                        .validate()) {
                      context.notificationProvider.sendNotificationFormKey
                          .currentState!
                          .save();
                      // TODO: should complete call sendNotification
                      Navigator.of(context).pop();
                    }
                  },
                  child: Text('Send'),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}

void sendNotificationFormForm(BuildContext context) {
  showDialog(
    context: context,
    builder: (BuildContext context) {
      return CompactFormDialog(
        title: 'Send Notification',
        child: SendNotificationForm(),
      );
    },
  );
}

========== FILE: lib/screens/notification/components/view_notification_form.dart ==========

import '../../../models/my_notification.dart';
import '../provider/notification_provider.dart';
import '../../../utility/constants.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import 'package:provider/provider.dart';
import 'notification_statics_card.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:admin_panal_start/widgets/compact_form_dialog.dart';

class ViewNotificationForm extends StatelessWidget {
  final MyNotification? notification;

  const ViewNotificationForm({Key? key, this.notification}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text(notification?.title ?? 'N/A',
                  style: TextStyle(fontSize: 16)),
            ],
          ),
          Gap(10),
          Container(
            margin: EdgeInsets.only(top: 20),
            padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
            decoration: BoxDecoration(
              color: secondaryColor,
              borderRadius: BorderRadius.circular(8.0),
              border: Border.all(color: Colors.blueAccent),
            ),
            child: Consumer<NotificationProvider>(
              builder: (context, notificationProvider, child) {
                int totalSend =
                    notificationProvider.notificationResult?.successDelivery ??
                        0;
                int totalOpened = notificationProvider
                        .notificationResult?.openedNotification ??
                    0;
                int totalFailed =
                    notificationProvider.notificationResult?.failedDelivery ??
                        0;
                int totalError =
                    notificationProvider.notificationResult?.erroredDelivery ??
                        0;
                double calculatePercentage(int notificationCount) {
                  if (totalSend == 0) {
                    return 0;
                  } else {
                    return (notificationCount / totalSend) * 100;
                  }
                }

                return Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    NotificationCard(
                      text: 'Total Send',
                      color: Colors.blue,
                      number: totalSend,
                      percentage: calculatePercentage(totalSend),
                    ),
                    Gap(8),
                    NotificationCard(
                      text: 'Total Opened',
                      color: Colors.green,
                      number: totalOpened,
                      percentage: calculatePercentage(totalOpened),
                    ),
                    Gap(8),
                    NotificationCard(
                      text: 'Total Failed',
                      color: Colors.red,
                      number: totalFailed,
                      percentage: calculatePercentage(totalFailed),
                    ),
                    Gap(8),
                    NotificationCard(
                      text: 'Total Error',
                      color: Colors.yellow,
                      number: totalError,
                      percentage: calculatePercentage(totalError),
                    ),
                  ],
                );
              },
            ),
          ),
          Gap(10),
          Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              ElevatedButton(
                style:
                    ElevatedButton.styleFrom(backgroundColor: secondaryColor),
                onPressed: () => Navigator.of(context).pop(),
                child: const Text('Cancel'),
              ),
            ],
          )
        ],
      ),
    );
  }
}

void viewNotificationStatics(
    BuildContext context, MyNotification? notification) {
  showDialog(
    context: context,
    builder: (BuildContext context) {
      return CompactFormDialog(
        title: 'Notification Statics',
        child: ViewNotificationForm(notification: notification),
      );
    },
  );
}

========== FILE: lib/screens/notification/notification_screen.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';

import 'components/notification_header.dart';
import 'components/notification_list_section.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import '../../utility/constants.dart';
import 'components/send_notification_form.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';

class NotificationScreen extends StatefulWidget {
  @override
  State<NotificationScreen> createState() => _NotificationScreenState();
}

class _NotificationScreenState extends State<NotificationScreen> {
  @override
  void initState() {
    super.initState();
    // Auto-load notifications when screen is created
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.dataProvider.getAllNotifications();
    });
  }

  @override
  Widget build(BuildContext context) {
    return SafeArea(
      child: SingleChildScrollView(
        primary: false,
        padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
        child: Column(
          children: [
            NotificationHeader(),
            Gap(defaultPadding),
            Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Expanded(
                  flex: 5,
                  child: Column(
                    children: [
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Expanded(
                            child: Text(
                              "My Notification",
                              style: Theme.of(context).textTheme.titleMedium,
                            ),
                          ),
                          ElevatedButton.icon(
                            style: TextButton.styleFrom(
                              padding: EdgeInsets.symmetric(
                                horizontal: ResponsiveUtils.isMobile(context)
                                    ? defaultPadding
                                    : defaultPadding * 1.5,
                                vertical: ResponsiveUtils.isMobile(context)
                                    ? defaultPadding / 2
                                    : defaultPadding,
                              ),
                            ),
                            onPressed: () {
                              sendNotificationFormForm(context);
                            },
                            icon: Icon(Icons.add),
                            label: Text("Send New"),
                          ),
                          Gap(ResponsiveUtils.isMobile(context) ? 8 : 20),
                          IconButton(
                              onPressed: () {
                                context.dataProvider
                                    .getAllNotifications(showSnack: true);
                              },
                              icon: Icon(Icons.refresh)),
                        ],
                      ),
                      Gap(defaultPadding),
                      NotificationListSection(),
                    ],
                  ),
                ),
              ],
            )
          ],
        ),
      ),
    );
  }
}

========== FILE: lib/screens/notification/provider/notification_provider.dart ==========

import '../../../models/notification_result.dart';
import 'package:flutter/cupertino.dart';
import '../../../core/data/data_provider.dart';
import '../../../services/http_services.dart';


class NotificationProvider extends ChangeNotifier {
  HttpService service = HttpService();
  final DataProvider _dataProvider;

  final sendNotificationFormKey = GlobalKey<FormState>();

  TextEditingController titleCtrl = TextEditingController();
  TextEditingController descriptionCtrl = TextEditingController();
  TextEditingController imageUrlCtrl = TextEditingController();

  NotificationResult? notificationResult;

  NotificationProvider(this._dataProvider);


  //TODO: should complete sendNotification


  //TODO: should complete deleteNotification

  //TODO: should complete getNotificationInfo

  clearFields() {
    titleCtrl.clear();
    descriptionCtrl.clear();
    imageUrlCtrl.clear();
  }

  updateUI() {
    notifyListeners();
  }
}

========== FILE: lib/screens/order/components/order_header.dart ==========

// lib/screens/order/components/order_header.dart
import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:flutter/material.dart';
import '../../../utility/constants.dart';
import '../../../widgets/responsive_header.dart';

class OrderHeader extends StatelessWidget {
  const OrderHeader({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return ResponsiveHeader(
      title: "Orders",
      onSearch: (val) {
        context.dataProvider.filterOrders(val);
      },
      actionButton: null,
    );
  }
}

========== FILE: lib/screens/order/components/order_list_section.dart ==========

// lib/screens/order/components/order_list_section.dart
import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:admin_panal_start/widgets/responsive_data_table.dart';
import '../../../core/data/data_provider.dart';
import 'view_order_form.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../../utility/color_list.dart';
import '../../../models/order.dart';
import '../../../utility/constants.dart';

class OrderListSection extends StatelessWidget {
  const OrderListSection({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
      decoration: BoxDecoration(
        color: secondaryColor,
        borderRadius: const BorderRadius.all(Radius.circular(10)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text("All Order", style: Theme.of(context).textTheme.titleMedium),
          SizedBox(
            width: double.infinity,
            child: Consumer<DataProvider>(
              builder: (context, dataProvider, child) {
                return ResponsiveDataTable(
                  columns: [
                    DataColumn(label: Text("Customer Name")),
                    DataColumn(label: Text("Order Amount")),
                    DataColumn(label: Text("Payment")),
                    DataColumn(label: Text("Status")),
                    DataColumn(label: Text("Date")),
                    DataColumn(label: Text("Edit")),
                    DataColumn(label: Text("Delete")),
                  ],
                  rows: List.generate(
                    dataProvider.orders.length,
                    (index) => orderDataRow(
                      dataProvider.orders[index],
                      index + 1,
                      delete: () {
                        context.orderProvider
                            .deleteOrder(dataProvider.orders[index]);
                      },
                      edit: () {
                        showOrderForm(context, dataProvider.orders[index]);
                      },
                    ),
                  ),
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}

DataRow orderDataRow(Order orderInfo, int index,
    {Function? edit, Function? delete}) {
  return DataRow(
    cells: [
      DataCell(
        Row(
          children: [
            Container(
              height: 24,
              width: 24,
              decoration: BoxDecoration(
                color: colors[index % colors.length],
                shape: BoxShape.circle,
              ),
              child: Text(index.toString(), textAlign: TextAlign.center),
            ),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 8),
              child: Text(
                orderInfo.userID?.name ?? '',
                overflow: TextOverflow.ellipsis,
                maxLines: 1,
              ),
            ),
          ],
        ),
      ),
      DataCell(Text(
        '${orderInfo.orderTotal?.total}',
        overflow: TextOverflow.ellipsis,
        maxLines: 1,
      )),
      DataCell(Text(
        orderInfo.paymentMethod ?? '',
        overflow: TextOverflow.ellipsis,
        maxLines: 1,
      )),
      DataCell(Text(
        orderInfo.orderStatus ?? '',
        overflow: TextOverflow.ellipsis,
        maxLines: 1,
      )),
      DataCell(Text(
        orderInfo.orderDate ?? '',
        overflow: TextOverflow.ellipsis,
        maxLines: 1,
      )),
      DataCell(
        IconButton(
          onPressed: () {
            if (edit != null) edit();
          },
          icon: Icon(Icons.edit, color: Colors.white),
        ),
      ),
      DataCell(
        IconButton(
          onPressed: () {
            if (delete != null) delete();
          },
          icon: Icon(Icons.delete, color: Colors.red),
        ),
      ),
    ],
  );
}

========== FILE: lib/screens/order/components/view_order_form.dart ==========

import '../../../models/order.dart';
import '../../../utility/constants.dart';
import '../../../utility/extensions.dart';
import '../../../utility/responsive_utils.dart';
import '../../../widgets/compact_form_dialog.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import 'package:provider/provider.dart';
import '../../../widgets/custom_dropdown.dart';
import '../../../widgets/custom_text_field.dart';
import '../provider/order_provider.dart';

class OrderSubmitForm extends StatelessWidget {
  final Order? order;

  const OrderSubmitForm({Key? key, this.order}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    context.orderProvider.trackingUrlCtrl.text = order?.trackingUrl ?? '';
    context.orderProvider.orderForUpdate = order;
    return SingleChildScrollView(
      child: Container(
        padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
        child: Form(
          key: Provider.of<OrderProvider>(context, listen: false).orderFormKey,
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              _buildBasicInfo(context),
              _buildItemsSection(context),
              _buildAddressSection(context),
              Gap(10),
              _buildPaymentDetailsSection(context),
              _buildStatusSection(context),
              _buildTrackingSection(context),
              Gap(ResponsiveUtils.getPadding(context) * 2),
              _buildActionButtons(context),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildBasicInfo(BuildContext context) {
    return Column(
      children: [
        _buildInfoRow('Name:', order?.userID?.name ?? 'N/A'),
        _buildInfoRow('Order Id:', order?.sId ?? 'N/A'),
      ],
    );
  }

  Widget _buildInfoRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            label,
            style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14),
          ),
          SizedBox(width: 8),
          Expanded(
            child: Text(
              value,
              style: TextStyle(fontSize: 14),
              overflow: TextOverflow.ellipsis,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildItemsSection(BuildContext context) {
    return Container(
      margin: EdgeInsets.only(top: 12),
      padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
      decoration: BoxDecoration(
        color: secondaryColor,
        border: Border.all(color: Colors.blueAccent),
        borderRadius: BorderRadius.circular(8.0),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Items',
            style: TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.bold,
              color: primaryColor,
            ),
          ),
          SizedBox(height: 8),
          _buildItemsList(),
          SizedBox(height: 8),
          _buildInfoRow('Total Price:',
              '\$${order?.totalPrice?.toStringAsFixed(2) ?? 'N/A'}'),
        ],
      ),
    );
  }

  Widget _buildItemsList() {
    if (order?.items == null || order!.items!.isEmpty) {
      return Text('No items', style: TextStyle(fontSize: 14));
    }
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: order!.items!.map((item) {
        return Padding(
          padding: EdgeInsets.only(bottom: 4.0),
          child: Text(
            '${item.productName}: ${item.quantity} x \$${item.price?.toStringAsFixed(2)}',
            style: TextStyle(fontSize: 14),
          ),
        );
      }).toList(),
    );
  }

  Widget _buildAddressSection(BuildContext context) {
    return Container(
      margin: EdgeInsets.only(top: 12),
      padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
      decoration: BoxDecoration(
        color: secondaryColor,
        border: Border.all(color: Colors.blueAccent),
        borderRadius: BorderRadius.circular(8.0),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Shipping Address',
            style: TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.bold,
              color: Colors.blueAccent,
            ),
          ),
          SizedBox(height: 8),
          _buildInfoRow('Phone:', order?.shippingAddress?.phone ?? 'N/A'),
          _buildInfoRow('Street:', order?.shippingAddress?.street ?? 'N/A'),
          _buildInfoRow('City:', order?.shippingAddress?.city ?? 'N/A'),
          _buildInfoRow(
              'Postal Code:', order?.shippingAddress?.postalCode ?? 'N/A'),
          _buildInfoRow('Country:', order?.shippingAddress?.country ?? 'N/A'),
        ],
      ),
    );
  }

  Widget _buildPaymentDetailsSection(BuildContext context) {
    return Container(
      margin: EdgeInsets.only(top: 12),
      padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
      decoration: BoxDecoration(
        color: secondaryColor,
        border: Border.all(color: Colors.blueAccent),
        borderRadius: BorderRadius.circular(8.0),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Payment Details',
            style: TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.bold,
              color: primaryColor,
            ),
          ),
          SizedBox(height: 8),
          _buildInfoRow(
              'Payment Method:', order?.paymentMethod?.toUpperCase() ?? 'N/A'),
          _buildInfoRow(
              'Payment Status:',
              order?.paymentStatus?.replaceAll('_', ' ').toUpperCase() ??
                  'N/A'),
          _buildInfoRow('Coupon Code:', order?.couponCode?.couponCode ?? 'N/A'),
          _buildInfoRow('Sub Total:',
              '\$${order?.orderTotal?.subtotal?.toStringAsFixed(2) ?? 'N/A'}'),
          _buildInfoRow('Discount:',
              '\$${order?.orderTotal?.discount?.toStringAsFixed(2) ?? 'N/A'}'),
          _buildInfoRow('Grand Total:',
              '\$${order?.orderTotal?.total?.toStringAsFixed(2) ?? 'N/A'}'),

          // Show payment proof if available
          if (order?.paymentProof?.imageUrl != null) ...[
            SizedBox(height: 8),
            Text(
              'Payment Proof:',
              style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14),
            ),
            SizedBox(height: 4),
            GestureDetector(
              onTap: () => _viewPaymentProof(context, order!),
              child: Container(
                width: 100,
                height: 100,
                decoration: BoxDecoration(
                  border: Border.all(color: Colors.blueAccent),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Image.network(
                  order!.paymentProof!.imageUrl!,
                  fit: BoxFit.cover,
                  errorBuilder: (context, error, stackTrace) {
                    return Icon(Icons.receipt,
                        size: 40, color: Colors.blueAccent);
                  },
                ),
              ),
            ),
            if (order!.paymentProof!.verified != null) ...[
              SizedBox(height: 4),
              Text(
                'Verified: ${order!.paymentProof!.verified! ? 'Yes' : 'No'}',
                style: TextStyle(
                  color: order!.paymentProof!.verified!
                      ? Colors.green
                      : Colors.orange,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ],
        ],
      ),
    );
  }

  Widget _buildStatusSection(BuildContext context) {
    return Container(
      margin: EdgeInsets.only(top: 12),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Order Status:',
            style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14),
          ),
          SizedBox(height: 4),
          Consumer<OrderProvider>(
            builder: (context, orderProvider, child) {
              // Set initial status based on current order status
              if (order?.orderStatus != null) {
                orderProvider.selectedOrderStatus = order!.orderStatus!;
              }

              return CustomDropdown(
                hintText: 'Status',
                initialValue: orderProvider.selectedOrderStatus,
                items: [
                  'pending',
                  'processing',
                  'shipped',
                  'delivered',
                  'cancelled',
                ],
                displayItem: (val) => val,
                onChanged: (newValue) {
                  orderProvider.selectedOrderStatus = newValue ?? 'pending';
                  orderProvider.updateUI();
                },
                validator: (value) {
                  if (value == null) {
                    return 'Please select status';
                  }
                  return null;
                },
              );
            },
          ),
        ],
      ),
    );
  }

  Widget _buildTrackingSection(BuildContext context) {
    return Container(
      margin: EdgeInsets.only(top: 12),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Tracking URL:',
            style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14),
          ),
          SizedBox(height: 4),
          CustomTextField(
            labelText: 'Tracking Url',
            onSave: (val) {},
            controller: context.orderProvider.trackingUrlCtrl,
          ),
        ],
      ),
    );
  }

  Widget _buildActionButtons(BuildContext context) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        ElevatedButton(
          style: ElevatedButton.styleFrom(backgroundColor: secondaryColor),
          onPressed: () => Navigator.of(context).pop(),
          child: const Text('Cancel'),
        ),
        Gap(ResponsiveUtils.getPadding(context)),
        ElevatedButton(
          style: ElevatedButton.styleFrom(backgroundColor: primaryColor),
          onPressed: () {
            if (Provider.of<OrderProvider>(context, listen: false)
                .orderFormKey
                .currentState!
                .validate()) {
              Provider.of<OrderProvider>(context, listen: false)
                  .orderFormKey
                  .currentState!
                  .save();
              context.orderProvider.updateOrder();
              Navigator.of(context).pop();
            }
          },
          child: const Text('Submit'),
        ),
      ],
    );
  }

  void _viewPaymentProof(BuildContext context, Order order) {
    if (order.paymentProof?.imageUrl != null) {
      showDialog(
        context: context,
        builder: (context) => Dialog(
          backgroundColor: Colors.transparent,
          child: Container(
            decoration: BoxDecoration(
              color: secondaryColor,
              borderRadius: BorderRadius.circular(10),
            ),
            padding: EdgeInsets.all(defaultPadding),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Text(
                  "Payment Proof",
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                Gap(defaultPadding),
                Image.network(
                  order.paymentProof!.imageUrl!,
                  width: 300,
                  height: 300,
                  fit: BoxFit.contain,
                  errorBuilder: (context, error, stackTrace) {
                    return Container(
                      width: 300,
                      height: 300,
                      color: Colors.grey[800],
                      child: Center(
                        child: Column(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Icon(Icons.error, color: Colors.red, size: 50),
                            Text(
                              "Failed to load image",
                              style: TextStyle(color: Colors.white),
                            ),
                          ],
                        ),
                      ),
                    );
                  },
                ),
                Gap(defaultPadding),
                ElevatedButton(
                  onPressed: () => Navigator.of(context).pop(),
                  child: Text("Close"),
                ),
              ],
            ),
          ),
        ),
      );
    }
  }
}

void showOrderForm(BuildContext context, Order? order) {
  showDialog(
    context: context,
    builder: (BuildContext context) {
      return CompactFormDialog(
        title: 'Order Details',
        maxWidth: ResponsiveUtils.isMobile(context) ? double.infinity : 600,
        child: OrderSubmitForm(order: order),
      );
    },
  );
}

========== FILE: lib/screens/order/order_screen.dart ==========

import 'package:admin_panal_start/models/order.dart';
import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:admin_panal_start/widgets/responsive_data_table.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import 'package:provider/provider.dart';
import '../../core/data/data_provider.dart';
import '../../utility/color_list.dart';
import '../../utility/constants.dart';
import '../../widgets/custom_dropdown.dart';
import '../../widgets/responsive_header.dart';
import 'components/view_order_form.dart';

class OrderScreen extends StatefulWidget {
  @override
  State<OrderScreen> createState() => _OrderScreenState();
}

class _OrderScreenState extends State<OrderScreen> {
  @override
  void initState() {
    super.initState();
    // Auto-load orders when screen is created
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.dataProvider.getAllOrders();
    });
  }

  @override
  Widget build(BuildContext context) {
    return SafeArea(
      child: SingleChildScrollView(
        primary: false,
        padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
        child: Column(
          children: [
            OrderHeader(),
            Gap(defaultPadding),
            Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Expanded(
                  flex: 5,
                  child: Column(
                    children: [
                      _buildOrderHeader(context),
                      Gap(defaultPadding),
                      OrderListSection(),
                    ],
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildOrderHeader(BuildContext context) {
    if (ResponsiveUtils.isMobile(context)) {
      return Column(
        children: [
          Row(
            children: [
              Expanded(
                child: Text(
                  "My Orders",
                  style: Theme.of(context).textTheme.titleMedium,
                ),
              ),
            ],
          ),
          Gap(8),
          Row(
            children: [
              Expanded(
                child: _buildFilterDropdown(context),
              ),
              Gap(8),
              IconButton(
                onPressed: () {
                  context.dataProvider.getAllOrders(showSnack: true);
                },
                icon: Icon(Icons.refresh),
              ),
            ],
          ),
        ],
      );
    } else {
      return Row(
        mainAxisAlignment: MainAxisAlignment.end,
        children: [
          Expanded(
            child: Text(
              "My Orders",
              style: Theme.of(context).textTheme.titleMedium,
            ),
          ),
          Gap(20),
          SizedBox(
            width: 280,
            child: _buildFilterDropdown(context),
          ),
          Gap(40),
          IconButton(
            onPressed: () {
              context.dataProvider.getAllOrders(showSnack: true);
            },
            icon: Icon(Icons.refresh),
          ),
        ],
      );
    }
  }

  Widget _buildFilterDropdown(BuildContext context) {
    return CustomDropdown(
      hintText: 'Filter Orders',
      initialValue: 'All orders',
      items: [
        'All orders',
        'pending',
        'processing',
        'shipped',
        'delivered',
        'cancelled',
        'payment_pending',
        'payment_verified',
      ],
      displayItem: (val) => val,
      onChanged: (newValue) {
        if (newValue?.toLowerCase() == 'all orders') {
          context.dataProvider.filterOrders('');
        } else {
          context.dataProvider.filterOrders(newValue?.toLowerCase() ?? '');
        }
      },
      validator: (value) {
        if (value == null) {
          return 'Please select status';
        }
        return null;
      },
    );
  }
}

class OrderHeader extends StatelessWidget {
  const OrderHeader({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return ResponsiveHeader(
      title: "Orders",
      onSearch: (val) {
        context.dataProvider.filterOrders(val);
      },
      actionButton: null,
    );
  }
}

class OrderListSection extends StatelessWidget {
  const OrderListSection({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
      decoration: BoxDecoration(
        color: secondaryColor,
        borderRadius: const BorderRadius.all(Radius.circular(10)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text("All Order", style: Theme.of(context).textTheme.titleMedium),
          SizedBox(
            width: double.infinity,
            child: Consumer<DataProvider>(
              builder: (context, dataProvider, child) {
                return ResponsiveDataTable(
                  columns: [
                    DataColumn(label: Text("Customer Name")),
                    DataColumn(label: Text("Order Amount")),
                    DataColumn(label: Text("Payment")),
                    DataColumn(label: Text("Payment Status")),
                    DataColumn(label: Text("Order Status")),
                    DataColumn(label: Text("Date")),
                    DataColumn(label: Text("Edit")),
                    DataColumn(label: Text("Delete")),
                  ],
                  rows: List.generate(
                    dataProvider.orders.length,
                    (index) => orderDataRow(
                      dataProvider.orders[index],
                      index + 1,
                      delete: () {
                        context.orderProvider
                            .deleteOrder(dataProvider.orders[index]);
                      },
                      edit: () {
                        showOrderForm(context, dataProvider.orders[index]);
                      },
                    ),
                  ),
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}

DataRow orderDataRow(Order orderInfo, int index,
    {Function? edit, Function? delete}) {
  return DataRow(
    cells: [
      DataCell(
        Row(
          children: [
            Container(
              height: 24,
              width: 24,
              decoration: BoxDecoration(
                color: colors[index % colors.length],
                shape: BoxShape.circle,
              ),
              child: Text(index.toString(), textAlign: TextAlign.center),
            ),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 8),
              child: Text(
                orderInfo.userID?.name ?? '',
                overflow: TextOverflow.ellipsis,
                maxLines: 1,
              ),
            ),
          ],
        ),
      ),
      DataCell(Text(
        '\$${orderInfo.totalPrice?.toStringAsFixed(2) ?? '0.00'}',
        overflow: TextOverflow.ellipsis,
        maxLines: 1,
      )),
      DataCell(Text(
        orderInfo.paymentMethod?.toUpperCase() ?? 'N/A',
        overflow: TextOverflow.ellipsis,
        maxLines: 1,
      )),
      DataCell(Text(
        orderInfo.paymentStatus?.replaceAll('_', ' ').toUpperCase() ?? 'N/A',
        overflow: TextOverflow.ellipsis,
        maxLines: 1,
      )),
      DataCell(Text(
        orderInfo.orderStatus?.replaceAll('_', ' ').toUpperCase() ?? '',
        overflow: TextOverflow.ellipsis,
        maxLines: 1,
      )),
      DataCell(Text(
        orderInfo.orderDate ?? '',
        overflow: TextOverflow.ellipsis,
        maxLines: 1,
      )),
      DataCell(
        IconButton(
          onPressed: () {
            if (edit != null) edit();
          },
          icon: Icon(Icons.edit, color: Colors.white),
        ),
      ),
      DataCell(
        IconButton(
          onPressed: () {
            if (delete != null) delete();
          },
          icon: Icon(Icons.delete, color: Colors.red),
        ),
      ),
    ],
  );
}

========== FILE: lib/screens/order/provider/order_provider.dart ==========

import 'package:admin_panal_start/models/api_response.dart';
import 'package:admin_panal_start/services/admin_auth_service.dart';
import 'package:admin_panal_start/utility/snack_bar_helper.dart';
import 'package:admin_panal_start/utility/error_utils.dart';
import 'package:get/get.dart';
import 'package:get/get_connect/http/src/response/response.dart';
import 'package:get/get_core/src/get_main.dart';
import '../../../models/order.dart';
import '../../../services/http_services.dart';
import 'package:flutter/cupertino.dart';
import '../../../core/data/data_provider.dart';

class OrderProvider extends ChangeNotifier {
  HttpService service = HttpService();
  final DataProvider _dataProvider;
  final orderFormKey = GlobalKey<FormState>();
  TextEditingController trackingUrlCtrl = TextEditingController();
  String selectedOrderStatus = 'pending';
  Order? orderForUpdate;

  OrderProvider(this._dataProvider);

  updateOrder() async {
    try {
      final authService = Get.find<AdminAuthService>();
      final currentUserId = authService.getUserId();

      if (orderForUpdate != null) {
        Map<String, dynamic> order = {
          'trackingUrl': trackingUrlCtrl.text,
          'orderStatus': selectedOrderStatus,
          'createdBy': currentUserId // ADD THIS
        };
        final response = await service.updateItem(
          endpointUrl: 'orders',
          itemId: orderForUpdate?.sId ?? '',
          itemData: order,
        );
        if (response.isOk) {
          ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
          if (apiResponse.success) {
            SnackBarHelper.showSuccessSnackBar('Order updated successfully');
            _dataProvider.getAllOrders();
          } else {
            SnackBarHelper.showOperationErrorSnackBar(
                'update', apiResponse.message);
          }
        } else {
          SnackBarHelper.showOperationErrorSnackBar(
              'update', response.statusText);
        }
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('update', e);
      rethrow;
    }
  }

  verifyPayment(Order order, bool verified) async {
    try {
      final authService = Get.find<AdminAuthService>();
      final currentUserId = authService.getUserId();

      final response = await service.updateItem(
        endpointUrl: 'orders',
        itemId: '${order.sId}/verify-payment',
        itemData: {
          'verified': verified,
          'createdBy': currentUserId // ADD THIS
        },
      );

      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          SnackBarHelper.showSuccessSnackBar(
              'Payment verification updated successfully');
          _dataProvider.getAllOrders();
        } else {
          SnackBarHelper.showOperationErrorSnackBar(
              'verify payment', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar(
            'verify payment', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('verify payment', e);
      rethrow;
    }
  }

  Future<List<Order>> getOrdersByPaymentStatus(String status) async {
    try {
      final response = await service.getItems(
        endpointUrl: 'orders/payment-status/$status',
      );

      if (response.isOk) {
        ApiResponse<List<Order>> apiResponse = ApiResponse.fromJson(
          response.body,
          (json) => (json as List).map((item) => Order.fromJson(item)).toList(),
        );
        return apiResponse.data ?? [];
      }
      return [];
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('fetch orders', e);
      return [];
    }
  }

  deleteOrder(Order order) async {
    try {
      Response response = await service.deleteItem(
        endpointUrl: 'orders',
        itemId: order.sId ?? '',
      );
      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          SnackBarHelper.showSuccessSnackBar("Order deleted successfully");
          _dataProvider.getAllOrders();
        } else {
          SnackBarHelper.showOperationErrorSnackBar(
              'delete', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar(
            'delete', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('delete', e);
      rethrow;
    }
  }

  updateUI() {
    notifyListeners();
  }
}

========== FILE: lib/screens/payment_verification/payment_verification_screen.dart ==========

import 'package:admin_panal_start/models/order.dart';
import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import 'package:provider/provider.dart';
import '../../core/data/data_provider.dart';
import '../../utility/constants.dart';
import '../../widgets/responsive_header.dart';

class PaymentVerificationScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return SafeArea(
      child: SingleChildScrollView(
        primary: false,
        padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
        child: Column(
          children: [
            _buildHeader(),
            Gap(defaultPadding),
            _buildPendingVerificationSection(context),
          ],
        ),
      ),
    );
  }

  Widget _buildHeader() {
    return ResponsiveHeader(
      title: "Payment Verification",
      onSearch: (val) {
        // Implement search if needed
      },
      actionButton: null,
    );
  }

  Widget _buildPendingVerificationSection(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
      decoration: BoxDecoration(
        color: secondaryColor,
        borderRadius: BorderRadius.all(Radius.circular(10)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                "Pending Payment Verification",
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w500,
                  color: Colors.white,
                ),
              ),
              IconButton(
                onPressed: () {
                  context.dataProvider.getAllOrders(showSnack: true);
                },
                icon: Icon(Icons.refresh, color: Colors.white),
              ),
            ],
          ),
          Gap(defaultPadding),
          Consumer<DataProvider>(
            builder: (context, dataProvider, child) {
              final pendingOrders = dataProvider.orders
                  .where((order) =>
                      order.paymentMethod != 'cod' &&
                      order.paymentStatus == 'pending' &&
                      order.paymentProof?.imageUrl != null)
                  .toList();

              if (pendingOrders.isEmpty) {
                return Center(
                  child: Text(
                    "No pending payment verifications",
                    style: TextStyle(color: Colors.white70),
                  ),
                );
              }

              return ListView.builder(
                shrinkWrap: true,
                physics: NeverScrollableScrollPhysics(),
                itemCount: pendingOrders.length,
                itemBuilder: (context, index) {
                  return _buildVerificationCard(context, pendingOrders[index]);
                },
              );
            },
          ),
        ],
      ),
    );
  }

  Widget _buildVerificationCard(BuildContext context, Order order) {
    return Card(
      margin: EdgeInsets.only(bottom: defaultPadding),
      color: Colors.grey[900],
      child: Padding(
        padding: EdgeInsets.all(defaultPadding),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        "Order #${order.sId?.substring(order.sId!.length - 6) ?? 'N/A'}",
                        style: TextStyle(
                          fontWeight: FontWeight.bold,
                          color: Colors.white,
                        ),
                      ),
                      Text(
                        "Customer: ${order.userID?.name ?? 'N/A'}",
                        style: TextStyle(color: Colors.white70),
                      ),
                      Text(
                        "Amount: \$${order.totalPrice?.toStringAsFixed(2) ?? '0.00'}",
                        style: TextStyle(color: Colors.white70),
                      ),
                      Text(
                        "Payment Method: ${order.paymentMethod?.toUpperCase() ?? 'N/A'}",
                        style: TextStyle(color: Colors.white70),
                      ),
                    ],
                  ),
                ),
                Column(
                  children: [
                    _buildActionButton(
                      context,
                      "View Proof",
                      Icons.remove_red_eye,
                      Colors.blue,
                      () => _viewPaymentProof(context, order),
                    ),
                    Gap(8),
                    _buildActionButton(
                      context,
                      "Verify",
                      Icons.verified,
                      Colors.green,
                      () => _verifyPayment(context, order, true),
                    ),
                    Gap(8),
                    _buildActionButton(
                      context,
                      "Reject",
                      Icons.cancel,
                      Colors.red,
                      () => _verifyPayment(context, order, false),
                    ),
                  ],
                ),
              ],
            ),
            if (order.paymentProof?.uploadedAt != null) ...[
              Gap(8),
              Text(
                "Uploaded: ${_formatDate(order.paymentProof!.uploadedAt)}",
                style: TextStyle(color: Colors.white60, fontSize: 12),
              ),
            ],
          ],
        ),
      ),
    );
  }

  Widget _buildActionButton(BuildContext context, String text, IconData icon,
      Color color, VoidCallback onPressed) {
    return SizedBox(
      width: 120,
      child: ElevatedButton.icon(
        onPressed: onPressed,
        icon: Icon(icon, size: 16),
        label: Text(text, style: TextStyle(fontSize: 12)),
        style: ElevatedButton.styleFrom(
          backgroundColor: color,
          foregroundColor: Colors.white,
          padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
        ),
      ),
    );
  }

  void _viewPaymentProof(BuildContext context, Order order) {
    if (order.paymentProof?.imageUrl != null) {
      showDialog(
        context: context,
        builder: (context) => Dialog(
          backgroundColor: Colors.transparent,
          child: Container(
            decoration: BoxDecoration(
              color: secondaryColor,
              borderRadius: BorderRadius.circular(10),
            ),
            padding: EdgeInsets.all(defaultPadding),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Text(
                  "Payment Proof",
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                Gap(defaultPadding),
                Image.network(
                  order.paymentProof!.imageUrl!,
                  width: 300,
                  height: 300,
                  fit: BoxFit.contain,
                  errorBuilder: (context, error, stackTrace) {
                    return Container(
                      width: 300,
                      height: 300,
                      color: Colors.grey[800],
                      child: Center(
                        child: Text(
                          "Failed to load image",
                          style: TextStyle(color: Colors.white),
                        ),
                      ),
                    );
                  },
                ),
                Gap(defaultPadding),
                ElevatedButton(
                  onPressed: () => Navigator.of(context).pop(),
                  child: Text("Close"),
                ),
              ],
            ),
          ),
        ),
      );
    }
  }

  void _verifyPayment(BuildContext context, Order order, bool verified) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: secondaryColor,
        title: Text(
          verified ? "Verify Payment" : "Reject Payment",
          style: TextStyle(color: Colors.white),
        ),
        content: Text(
          verified
              ? "Are you sure you want to verify this payment?"
              : "Are you sure you want to reject this payment?",
          style: TextStyle(color: Colors.white70),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: Text("Cancel", style: TextStyle(color: Colors.white70)),
          ),
          ElevatedButton(
            onPressed: () {
              context.orderProvider.verifyPayment(order, verified);
              Navigator.of(context).pop();
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: verified ? Colors.green : Colors.red,
            ),
            child: Text(verified ? "Verify" : "Reject"),
          ),
        ],
      ),
    );
  }

  String _formatDate(String? dateString) {
    if (dateString == null) return 'N/A';
    try {
      final date = DateTime.parse(dateString);
      return '${date.day}/${date.month}/${date.year} ${date.hour}:${date.minute}';
    } catch (e) {
      return dateString;
    }
  }
}

========== FILE: lib/screens/posters/components/add_poster_form.dart ==========

import '../../../utility/responsive_utils.dart';
import '../../../widgets/compact_form_dialog.dart';
import '../provider/poster_provider.dart';
import '../../../utility/extensions.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import 'package:provider/provider.dart';
import '../../../models/poster.dart';
import '../../../utility/constants.dart';
import '../../../widgets/category_image_card.dart';
import '../../../widgets/custom_text_field.dart';

class PosterSubmitForm extends StatelessWidget {
  final Poster? poster;

  const PosterSubmitForm({super.key, this.poster});

  @override
  Widget build(BuildContext context) {
    context.posterProvider.setDataForUpdatePoster(poster);
    return Padding(
      padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
      child: Form(
        key: context.posterProvider.addPosterFormKey,
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            _buildImageSection(context),
            Gap(ResponsiveUtils.getPadding(context)),
            _buildNameField(context),
            Gap(ResponsiveUtils.getPadding(context)),
            _buildActionButtons(context),
          ],
        ),
      ),
    );
  }

  Widget _buildImageSection(BuildContext context) {
    return Consumer<PosterProvider>(
      builder: (context, posterProvider, child) {
        return Column(
          children: [
            SizedBox(
              width: ResponsiveUtils.isMobile(context) ? 120 : 150,
              child: CategoryImageCard(
                labelText: "Poster",
                imageFile: posterProvider.selectedImage,
                imageUrlForUpdateImage: poster?.imageUrl,
                onTap: () {
                  posterProvider.pickImage(context);
                },
                onRemoveImage: () {
                  posterProvider.selectedImage = null;
                  posterProvider.imgXFile = null;
                  posterProvider.notifyListeners();
                },
              ),
            ),
            SizedBox(height: 8),
            Text(
              'Tap to add poster image',
              style: TextStyle(
                color: Colors.white70,
                fontSize: 12,
              ),
            ),
          ],
        );
      },
    );
  }

  Widget _buildNameField(BuildContext context) {
    return CustomTextField(
      controller: context.posterProvider.posterNameCtrl,
      labelText: 'Poster Name',
      onSave: (val) {},
      validator: (value) {
        if (value == null || value.isEmpty) {
          return 'Please enter a poster name';
        }
        return null;
      },
    );
  }

  Widget _buildActionButtons(BuildContext context) {
    return Container(
      padding: EdgeInsets.only(top: 16),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          ElevatedButton(
            style: ElevatedButton.styleFrom(
              foregroundColor: Colors.white,
              backgroundColor: secondaryColor,
              padding: EdgeInsets.symmetric(horizontal: 20, vertical: 12),
            ),
            onPressed: () {
              Navigator.of(context).pop();
            },
            child: Text('Cancel'),
          ),
          Gap(ResponsiveUtils.getPadding(context)),
          ElevatedButton(
            style: ElevatedButton.styleFrom(
              foregroundColor: Colors.white,
              backgroundColor: primaryColor,
              padding: EdgeInsets.symmetric(horizontal: 20, vertical: 12),
            ),
            onPressed: () {
              if (context.posterProvider.addPosterFormKey.currentState!
                  .validate()) {
                context.posterProvider.addPosterFormKey.currentState!.save();
                context.posterProvider.submitPoster();
                Navigator.of(context).pop();
              }
            },
            child: Text('Submit'),
          ),
        ],
      ),
    );
  }
}

void showAddPosterForm(BuildContext context, Poster? poster) {
  showDialog(
    context: context,
    builder: (BuildContext context) {
      return CompactFormDialog(
        title: 'Add Poster',
        child: PosterSubmitForm(poster: poster),
      );
    },
  );
}

========== FILE: lib/screens/posters/components/poster_header.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';
import 'package:flutter/material.dart';
import '../../../widgets/responsive_header.dart';

class PosterHeader extends StatelessWidget {
  const PosterHeader({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return ResponsiveHeader(
      title: "Posters",
      onSearch: (val) => context.dataProvider.filterPosters(val),
    );
  }
}

========== FILE: lib/screens/posters/components/poster_list_section.dart ==========

import 'package:admin_panal_start/services/admin_auth_service.dart';
import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:admin_panal_start/widgets/responsive_data_table.dart';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:get/get.dart';
import 'package:get/get_core/src/get_main.dart';
import '../../../core/data/data_provider.dart';
import 'add_poster_form.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../../models/poster.dart';
import '../../../utility/constants.dart';

class PosterListSection extends StatelessWidget {
  const PosterListSection({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
      decoration: const BoxDecoration(
        color: secondaryColor,
        borderRadius: BorderRadius.all(Radius.circular(10)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text("All Posters", style: Theme.of(context).textTheme.titleMedium),
          const SizedBox(height: defaultPadding),
          SizedBox(
            width: double.infinity,
            child: Consumer<DataProvider>(
              builder: (context, dataProvider, child) {
                if (dataProvider.posters.isEmpty) {
                  return const Center(
                    child: Text(
                      "No posters found",
                      style: TextStyle(color: Colors.white70),
                    ),
                  );
                }

                return ResponsiveDataTable(
                  dataRowMinHeight: 70,
                  dataRowMaxHeight: 90,
                  columns: const [
                    DataColumn(
                      label: Expanded(
                        child: Text(
                          "Image",
                          overflow: TextOverflow.ellipsis,
                        ),
                      ),
                    ),
                    DataColumn(
                      label: Expanded(
                        child: Text(
                          "Poster Name",
                          overflow: TextOverflow.ellipsis,
                        ),
                      ),
                    ),
                    DataColumn(label: Text("Edit")),
                    DataColumn(label: Text("Delete")),
                  ],
                  rows: List.generate(
                    dataProvider.posters.length,
                    (index) => posterDataRow(
                      context, // Add context
                      dataProvider.posters[index],
                      delete: () {
                        context.posterProvider
                            .deletePoster(dataProvider.posters[index]);
                      },
                      edit: () {
                        showAddPosterForm(context, dataProvider.posters[index]);
                      },
                    ),
                  ),
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}

DataRow posterDataRow(BuildContext context, poster,
    {Function? edit, Function? delete}) {
  return DataRow(
    cells: [
      DataCell(
        Container(
          constraints: const BoxConstraints(minHeight: 60),
          child: Center(
            child: _buildPosterImage(poster.imageUrl),
          ),
        ),
      ),
      DataCell(
        Container(
          constraints: const BoxConstraints(minHeight: 60),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                poster.posterName ?? 'No Name',
                style: const TextStyle(
                  color: Colors.white,
                  fontWeight: FontWeight.w500,
                ),
                overflow: TextOverflow.ellipsis,
                maxLines: 2,
              ),
            ],
          ),
        ),
      ),
      DataCell(
        Container(
          constraints: const BoxConstraints(minHeight: 60),
          child: Center(
            child: Get.find<AdminAuthService>().canEditItem(poster)
                ? IconButton(
                    onPressed: () {
                      if (edit != null) edit();
                    },
                    icon: const Icon(Icons.edit, color: Colors.blue, size: 20),
                  )
                : const Icon(Icons.lock, color: Colors.grey, size: 20),
          ),
        ),
      ),
      DataCell(
        Container(
          constraints: const BoxConstraints(minHeight: 60),
          child: Center(
            child: Get.find<AdminAuthService>().canDeleteItem(poster)
                ? IconButton(
                    onPressed: () {
                      if (delete != null) delete();
                    },
                    icon: const Icon(Icons.delete, color: Colors.red, size: 20),
                  )
                : const Icon(Icons.lock, color: Colors.grey, size: 20),
          ),
        ),
      ),
    ],
  );
}

Widget _buildPosterImage(String? imageUrl) {
  if (imageUrl == null || imageUrl.isEmpty || imageUrl == 'no_url') {
    return Container(
      width: 60,
      height: 40,
      decoration: BoxDecoration(
        color: Colors.grey[800],
        borderRadius: BorderRadius.circular(6),
        border: Border.all(color: Colors.grey.shade600),
      ),
      child: const Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Icons.image, color: Colors.grey, size: 16),
          SizedBox(height: 2),
          Text(
            'No Image',
            style: TextStyle(color: Colors.grey, fontSize: 8),
          ),
        ],
      ),
    );
  }

  return Container(
    width: 60,
    height: 40,
    child: ClipRRect(
      borderRadius: BorderRadius.circular(6),
      child: CachedNetworkImage(
        imageUrl: imageUrl,
        width: 60,
        height: 40,
        fit: BoxFit.cover,
        placeholder: (context, url) => Container(
          width: 60,
          height: 40,
          decoration: BoxDecoration(
            color: Colors.grey[800],
            borderRadius: BorderRadius.circular(6),
          ),
          child: Center(
            child: SizedBox(
              width: 16,
              height: 16,
              child: CircularProgressIndicator(
                strokeWidth: 2,
                valueColor: const AlwaysStoppedAnimation<Color>(Colors.white),
              ),
            ),
          ),
        ),
        errorWidget: (context, url, error) => Container(
          width: 60,
          height: 40,
          decoration: BoxDecoration(
            color: Colors.grey[800],
            borderRadius: BorderRadius.circular(6),
            border: Border.all(color: Colors.red),
          ),
          child: const Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(Icons.error, color: Colors.red, size: 16),
              SizedBox(height: 2),
              Text(
                'Error',
                style: TextStyle(color: Colors.red, fontSize: 8),
              ),
            ],
          ),
        ),
      ),
    ),
  );
}

========== FILE: lib/screens/posters/poster_screen.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'components/add_poster_form.dart';
import 'components/poster_header.dart';
import 'components/poster_list_section.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import '../../utility/constants.dart';

class PosterScreen extends StatefulWidget {
  @override
  State<PosterScreen> createState() => _PosterScreenState();
}

class _PosterScreenState extends State<PosterScreen> {
  @override
  void initState() {
    super.initState();
    // Auto-load posters when screen is created
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.dataProvider.getAllPosters();
    });
  }

  @override
  Widget build(BuildContext context) {
    return SafeArea(
      child: SingleChildScrollView(
        primary: false,
        padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
        child: Column(
          children: [
            PosterHeader(),
            SizedBox(height: defaultPadding),
            Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Expanded(
                  flex: 5,
                  child: Column(
                    children: [
                      Row(
                        mainAxisAlignment: MainAxisAlignment.end,
                        children: [
                          Expanded(
                            child: Text(
                              "My Posters",
                              style: Theme.of(context).textTheme.titleMedium,
                            ),
                          ),
                          ElevatedButton.icon(
                            style: TextButton.styleFrom(
                              padding: EdgeInsets.symmetric(
                                horizontal: ResponsiveUtils.isMobile(context)
                                    ? defaultPadding
                                    : defaultPadding * 1.5,
                                vertical: ResponsiveUtils.isMobile(context)
                                    ? defaultPadding / 2
                                    : defaultPadding,
                              ),
                            ),
                            onPressed: () {
                              showAddPosterForm(context, null);
                            },
                            icon: Icon(Icons.add),
                            label: Text("Add New"),
                          ),
                          Gap(ResponsiveUtils.isMobile(context) ? 8 : 20),
                          IconButton(
                            onPressed: () {
                              context.dataProvider
                                  .getAllPosters(showSnack: true);
                            },
                            icon: Icon(Icons.refresh),
                          ),
                        ],
                      ),
                      Gap(defaultPadding),
                      PosterListSection(),
                    ],
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}

========== FILE: lib/screens/posters/provider/poster_provider.dart ==========

import 'dart:io';
import 'package:admin_panal_start/utility/snack_bar_helper.dart';
import 'package:admin_panal_start/models/api_response.dart';
import 'package:admin_panal_start/widgets/camera_picker_dialog.dart';
import '../../../services/http_services.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/foundation.dart' hide Category;
import 'package:get/get.dart';
import 'package:image_picker/image_picker.dart';
import '../../../core/data/data_provider.dart';
import '../../../models/poster.dart';
import 'package:admin_panal_start/utility/error_utils.dart';

class PosterProvider extends ChangeNotifier {
  HttpService service = HttpService();
  final DataProvider _dataProvider;
  final addPosterFormKey = GlobalKey<FormState>();
  TextEditingController posterNameCtrl = TextEditingController();
  Poster? posterForUpdate;

  File? selectedImage;
  XFile? imgXFile;

  PosterProvider(this._dataProvider);

  addPoster() async {
    try {
      if (selectedImage == null) {
        SnackBarHelper.showWarningSnackBar("Please select a poster image");
        return;
      }

      Map<String, dynamic> formDataMap = {
        'posterName': posterNameCtrl.text,
        'image': 'no_data',
      };
      final FormData form = await createFormData(
        imgXFile: imgXFile,
        formData: formDataMap,
      );

      final response = await service.addItem(
        endpointUrl: 'posters',
        itemData: form,
      );
      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          clearFields();
          SnackBarHelper.showSuccessSnackBar('Poster added successfully');
          _dataProvider.getAllPosters();
        } else {
          SnackBarHelper.showOperationErrorSnackBar('add', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar('add', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('add', e);
      rethrow;
    }
  }

  updatePoster() async {
    try {
      Map<String, dynamic> formDataMap = {
        'postername': posterNameCtrl.text,
        'image': 'no_data',
      };

      final FormData form = await createFormData(
        imgXFile: imgXFile,
        formData: formDataMap,
      );
      final response = await service.updateItem(
        endpointUrl: 'posters',
        itemId: posterForUpdate?.sId ?? '',
        itemData: form,
      );
      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          clearFields();
          SnackBarHelper.showSuccessSnackBar('Poster updated successfully');
          _dataProvider.getAllPosters();
        } else {
          SnackBarHelper.showOperationErrorSnackBar(
              'update', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar(
            'update', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('update', e);
      rethrow;
    }
  }

  submitPoster() {
    if (posterForUpdate != null) {
      updatePoster();
    } else {
      addPoster();
    }
  }

  deletePoster(Poster poster) async {
    try {
      Response response = await service.deleteItem(
        endpointUrl: 'posters',
        itemId: poster.sId ?? '',
      );
      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          SnackBarHelper.showSuccessSnackBar("Poster deleted successfully");
          _dataProvider.getAllPosters();
        } else {
          SnackBarHelper.showOperationErrorSnackBar(
              'delete', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar(
            'delete', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('delete', e);
      rethrow;
    }
  }

  void pickImage(BuildContext context) async {
    showCameraPickerDialog(context, (XFile? image) async {
      if (image != null) {
        selectedImage = File(image.path);
        imgXFile = image;
        notifyListeners();
      }
    });
  }

  setDataForUpdatePoster(Poster? poster) {
    if (poster != null) {
      clearFields();
      posterForUpdate = poster;
      posterNameCtrl.text = poster.posterName ?? '';
    } else {
      clearFields();
    }
  }

  Future<FormData> createFormData({
    required XFile? imgXFile,
    required Map<String, dynamic> formData,
  }) async {
    if (imgXFile != null) {
      MultipartFile multipartFile;
      if (kIsWeb) {
        String fileName = imgXFile.name;
        Uint8List byteImg = await imgXFile.readAsBytes();
        multipartFile = MultipartFile(byteImg, filename: fileName);
      } else {
        String fileName = imgXFile.path.split('/').last;
        multipartFile = MultipartFile(imgXFile.path, filename: fileName);
      }
      formData['img'] = multipartFile;
    }
    final FormData form = FormData(formData);
    return form;
  }

  clearFields() {
    posterNameCtrl.clear();
    selectedImage = null;
    imgXFile = null;
    posterForUpdate = null;
  }
}

========== FILE: lib/screens/ratings/provider/rating_provider.dart ==========

import 'package:admin_panal_start/core/data/data_provider.dart';
import 'package:flutter/cupertino.dart';
import 'package:get/get.dart';
import '../../../models/api_response.dart';
import '../../../models/rating.dart';
import '../../../services/http_services.dart';
import '../../../utility/snack_bar_helper.dart';

class RatingProvider extends ChangeNotifier {
  HttpService service = HttpService();

  RatingProvider();

  // Get ratings for a product
  Future<List<Rating>> getProductRatings(String productId) async {
    try {
      final response = await service.getItems(
        endpointUrl: 'ratings/product/$productId',
      );

      print(
          "üü° [RATINGS] Raw response for product $productId: ${response.body}");

      if (response.isOk) {
        // Handle the actual API response structure
        if (response.body is Map<String, dynamic>) {
          final Map<String, dynamic> responseBody = response.body;

          // Check if the response has the expected structure
          if (responseBody['success'] == true && responseBody['data'] != null) {
            final data = responseBody['data'];

            // The data might be nested under 'ratings' or directly as a list
            if (data is Map<String, dynamic> && data['ratings'] is List) {
              // Structure: {success: true, data: {ratings: [], totalPages: 1, ...}}
              final List<dynamic> ratingsList = data['ratings'];
              final List<Rating> ratings =
                  ratingsList.map((item) => Rating.fromJson(item)).toList();
              print("üü¢ [RATINGS] Found ${ratings.length} ratings");
              return ratings;
            } else if (data is List) {
              // Structure: {success: true, data: []}
              final List<Rating> ratings =
                  data.map((item) => Rating.fromJson(item)).toList();
              print("üü¢ [RATINGS] Found ${ratings.length} ratings");
              return ratings;
            }
          }
        }

        print("üü° [RATINGS] No ratings found or unexpected format");
        return [];
      }

      print("üî¥ [RATINGS] API call failed with status: ${response.statusCode}");
      return [];
    } catch (e) {
      print("üî¥ [RATINGS] Error getting product ratings: $e");
      SnackBarHelper.showErrorSnackBar("Failed to load ratings: $e");
      return [];
    }
  }

  // Get rating stats for a product
  Future<Map<String, dynamic>?> getProductRatingStats(String productId) async {
    try {
      final response = await service.getItems(
        endpointUrl: 'ratings/product/$productId/stats',
      );

      print(
          "üü° [STATS] Raw stats response for product $productId: ${response.body}");

      if (response.isOk) {
        if (response.body is Map<String, dynamic>) {
          final Map<String, dynamic> responseBody = response.body;

          if (responseBody['success'] == true && responseBody['data'] != null) {
            final stats = responseBody['data'];
            print("üü¢ [STATS] Found stats: $stats");
            return stats;
          }
        }
      }

      print("üî¥ [STATS] No stats found or API call failed");
      return null;
    } catch (e) {
      print("üî¥ [STATS] Error getting rating stats: $e");
      return null;
    }
  }

  // Delete a rating
  deleteRating(String ratingId) async {
    try {
      Response response = await service.deleteItem(
        endpointUrl: 'ratings',
        itemId: ratingId,
      );

      if (response.isOk) {
        if (response.body is Map<String, dynamic>) {
          final responseBody = response.body as Map<String, dynamic>;
          if (responseBody['success'] == true) {
            SnackBarHelper.showSuccessSnackBar("Rating deleted successfully");
            updateUI();
          } else {
            SnackBarHelper.showErrorSnackBar(
              "Error: ${responseBody['message'] ?? 'Unknown error'}",
            );
          }
        }
      } else {
        SnackBarHelper.showErrorSnackBar(
          "Error: ${response.statusText}",
        );
      }
    } catch (e) {
      print("üî¥ [DELETE] Error deleting rating: $e");
      SnackBarHelper.showErrorSnackBar("Failed to delete rating: $e");
      rethrow;
    }
  }

  updateUI() {
    notifyListeners();
  }
}

========== FILE: lib/screens/ratings/ratings_screen.dart ==========

import 'package:admin_panal_start/models/product.dart';
import 'package:admin_panal_start/models/rating.dart';
import 'package:admin_panal_start/screens/ratings/provider/rating_provider.dart';
import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:admin_panal_start/widgets/responsive_data_table.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import 'package:provider/provider.dart';
import '../../core/data/data_provider.dart';
import '../../utility/color_list.dart';
import '../../utility/constants.dart';
import '../../widgets/responsive_header.dart';

class RatingsScreen extends StatefulWidget {
  @override
  State<RatingsScreen> createState() => _RatingsScreenState();
}

class _RatingsScreenState extends State<RatingsScreen> {
  @override
  void initState() {
    super.initState();
    // Auto-load products for ratings when screen is created
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.dataProvider.getAllProduct();
    });
  }

  @override
  Widget build(BuildContext context) {
    return SafeArea(
      child: SingleChildScrollView(
        primary: false,
        padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
        child: Column(
          children: [
            RatingsHeader(),
            Gap(defaultPadding),
            Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Expanded(
                  flex: 5,
                  child: Column(
                    children: [
                      _buildRatingsHeader(context),
                      Gap(defaultPadding),
                      RatingsListSection(),
                    ],
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildRatingsHeader(BuildContext context) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Expanded(
          child: Text(
            "Product Ratings & Reviews",
            style: Theme.of(context).textTheme.titleMedium,
          ),
        ),
        IconButton(
          onPressed: () {
            context.dataProvider.getAllProduct(showSnack: true);
          },
          icon: Icon(Icons.refresh),
        ),
      ],
    );
  }
}

class RatingsHeader extends StatelessWidget {
  const RatingsHeader({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return ResponsiveHeader(
      title: "Ratings & Reviews",
      onSearch: (val) {
        // Implement rating search when needed
      },
      actionButton: null,
    );
  }
}

class RatingsListSection extends StatelessWidget {
  const RatingsListSection({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
      decoration: BoxDecoration(
        color: secondaryColor,
        borderRadius: const BorderRadius.all(Radius.circular(10)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text("Product Ratings",
              style: Theme.of(context).textTheme.titleMedium),
          SizedBox(height: defaultPadding),
          Consumer<DataProvider>(
            builder: (context, dataProvider, child) {
              if (dataProvider.products.isEmpty) {
                return Center(
                  child: Text(
                    "No products available",
                    style: TextStyle(color: Colors.white70),
                  ),
                );
              }

              return ResponsiveDataTable(
                columns: [
                  DataColumn(label: Text("Product")),
                  DataColumn(label: Text("Actions")),
                ],
                rows: List.generate(
                  dataProvider.products.length,
                  (index) => ratingDataRow(
                    dataProvider.products[index],
                    index + 1,
                    viewReviews: () {
                      _viewProductReviews(
                          context, dataProvider.products[index]);
                    },
                  ),
                ),
              );
            },
          ),
        ],
      ),
    );
  }
}

DataRow ratingDataRow(Product productInfo, int index, {Function? viewReviews}) {
  return DataRow(
    cells: [
      DataCell(
        Row(
          children: [
            Container(
              height: 24,
              width: 24,
              decoration: BoxDecoration(
                color: colors[index % colors.length],
                shape: BoxShape.circle,
              ),
              child: Text(index.toString(), textAlign: TextAlign.center),
            ),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 8),
              child: Text(
                productInfo.name ?? 'No Name',
                overflow: TextOverflow.ellipsis,
                maxLines: 1,
              ),
            ),
          ],
        ),
      ),
      DataCell(
        IconButton(
          onPressed: () {
            if (viewReviews != null) viewReviews();
          },
          icon: Icon(Icons.remove_red_eye, color: Colors.blue, size: 20),
          tooltip: 'View Reviews',
        ),
      ),
    ],
  );
}

void _viewProductReviews(BuildContext context, Product product) {
  showDialog(
    context: context,
    builder: (BuildContext context) {
      return Consumer<RatingProvider>(
        builder: (context, ratingProvider, child) {
          return Dialog(
            backgroundColor: secondaryColor,
            child: Container(
              width: ResponsiveUtils.isMobile(context) ? double.infinity : 800,
              height: 600,
              padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Expanded(
                        child: Text(
                          "Reviews for ${product.name}",
                          style: TextStyle(
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                            color: Colors.white,
                          ),
                        ),
                      ),
                      IconButton(
                        onPressed: () => Navigator.of(context).pop(),
                        icon: Icon(Icons.close, color: Colors.white),
                      ),
                    ],
                  ),
                  Gap(defaultPadding),
                  Expanded(
                    child: FutureBuilder<List<Rating>>(
                      future: ratingProvider.getProductRatings(product.sId!),
                      builder: (context, snapshot) {
                        if (snapshot.connectionState ==
                            ConnectionState.waiting) {
                          return Center(child: CircularProgressIndicator());
                        }

                        if (snapshot.hasError) {
                          return Center(
                            child: Text(
                              "Error loading reviews",
                              style: TextStyle(color: Colors.red),
                            ),
                          );
                        }

                        final ratings = snapshot.data ?? [];

                        if (ratings.isEmpty) {
                          return Column(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              Icon(Icons.reviews, size: 64, color: Colors.grey),
                              Gap(16),
                              Text(
                                "No reviews yet",
                                style: TextStyle(
                                    color: Colors.white70, fontSize: 18),
                              ),
                            ],
                          );
                        }

                        return ListView.builder(
                          itemCount: ratings.length,
                          itemBuilder: (context, index) {
                            final rating = ratings[index];
                            return Card(
                              margin: EdgeInsets.symmetric(vertical: 8),
                              color: Colors.grey[800],
                              child: ListTile(
                                leading: CircleAvatar(
                                  child: Text(rating.userName?[0] ?? 'U'),
                                ),
                                title: Text(
                                  rating.userName ?? 'Unknown User',
                                  style: TextStyle(color: Colors.white),
                                ),
                                subtitle: Text(
                                  rating.review ?? 'No review text',
                                  style: TextStyle(color: Colors.white70),
                                ),
                                trailing: Row(
                                  mainAxisSize: MainAxisSize.min,
                                  children: [
                                    Text(
                                      '${rating.rating ?? 0}/5',
                                      style: TextStyle(color: Colors.amber),
                                    ),
                                    Icon(Icons.star, color: Colors.amber),
                                  ],
                                ),
                              ),
                            );
                          },
                        );
                      },
                    ),
                  ),
                ],
              ),
            ),
          );
        },
      );
    },
  );
}

========== FILE: lib/screens/sub_category/components/add_sub_category_form.dart ==========

import '../../../models/sub_category.dart';
import '../../../utility/responsive_utils.dart';
import '../../../widgets/compact_form_dialog.dart';
import '../provider/sub_category_provider.dart';
import '../../../utility/extensions.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import 'package:provider/provider.dart';
import '../../../models/category.dart';
import '../../../utility/constants.dart';
import '../../../widgets/custom_dropdown.dart';
import '../../../widgets/custom_text_field.dart';

class SubCategorySubmitForm extends StatelessWidget {
  final SubCategory? subCategory;

  const SubCategorySubmitForm({super.key, this.subCategory});

  @override
  Widget build(BuildContext context) {
    context.subCategoryProvider.setDataForUpdateSubCategory(subCategory);
    return Padding(
      padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
      child: Form(
        key: context.subCategoryProvider.addSubCategoryFormKey,
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            _buildFormFields(context),
            Gap(ResponsiveUtils.getPadding(context)),
            _buildActionButtons(context),
          ],
        ),
      ),
    );
  }

  Widget _buildFormFields(BuildContext context) {
    if (ResponsiveUtils.isMobile(context)) {
      return Column(
        children: [
          _buildCategoryDropdown(context),
          Gap(8),
          _buildNameField(context),
        ],
      );
    } else {
      return Row(
        children: [
          Expanded(child: _buildCategoryDropdown(context)),
          Gap(8),
          Expanded(child: _buildNameField(context)),
        ],
      );
    }
  }

  Widget _buildCategoryDropdown(BuildContext context) {
    return Consumer<SubCategoryProvider>(
      builder: (context, subCatProvider, child) {
        return CustomDropdown(
          initialValue: subCatProvider.selectedCategory,
          hintText: subCatProvider.selectedCategory?.name ?? 'Select category',
          items: context.dataProvider.categories,
          displayItem: (Category? category) => category?.name ?? '',
          onChanged: (newValue) {
            if (newValue != null) {
              subCatProvider.selectedCategory = newValue;
              subCatProvider.updateUI();
            }
          },
          validator: (value) {
            if (value == null) {
              return 'Please select a category';
            }
            return null;
          },
        );
      },
    );
  }

  Widget _buildNameField(BuildContext context) {
    return CustomTextField(
      controller: context.subCategoryProvider.subCategoryNameCtrl,
      labelText: 'Sub Category Name',
      onSave: (val) {},
      validator: (value) {
        if (value == null || value.isEmpty) {
          return 'Please enter a sub category name';
        }
        return null;
      },
    );
  }

  Widget _buildActionButtons(BuildContext context) {
    return Container(
      padding: EdgeInsets.only(top: 16),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          ElevatedButton(
            style: ElevatedButton.styleFrom(
              foregroundColor: Colors.white,
              backgroundColor: secondaryColor,
              padding: EdgeInsets.symmetric(horizontal: 20, vertical: 12),
            ),
            onPressed: () {
              Navigator.of(context).pop();
            },
            child: Text('Cancel'),
          ),
          Gap(ResponsiveUtils.getPadding(context)),
          ElevatedButton(
            style: ElevatedButton.styleFrom(
              foregroundColor: Colors.white,
              backgroundColor: primaryColor,
              padding: EdgeInsets.symmetric(horizontal: 20, vertical: 12),
            ),
            onPressed: () {
              if (context
                  .subCategoryProvider.addSubCategoryFormKey.currentState!
                  .validate()) {
                context.subCategoryProvider.addSubCategoryFormKey.currentState!
                    .save();
                context.subCategoryProvider.submitSubCategory();
                Navigator.of(context).pop();
              }
            },
            child: Text('Submit'),
          ),
        ],
      ),
    );
  }
}

void showAddSubCategoryForm(BuildContext context, SubCategory? subCategory) {
  showDialog(
    context: context,
    builder: (BuildContext context) {
      return CompactFormDialog(
        title: 'Add Sub Category',
        child: SubCategorySubmitForm(subCategory: subCategory),
      );
    },
  );
}

========== FILE: lib/screens/sub_category/components/sub_category_header.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';
import 'package:flutter/material.dart';
import '../../../widgets/responsive_header.dart';

class SubCategoryHeader extends StatelessWidget {
  const SubCategoryHeader({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return ResponsiveHeader(
      title: "Sub Category",
      onSearch: (val) => context.dataProvider.filteredSubCategories(val),
    );
  }
}

========== FILE: lib/screens/sub_category/components/sub_category_list_section.dart ==========

import 'package:admin_panal_start/services/admin_auth_service.dart';
import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:admin_panal_start/widgets/responsive_data_table.dart';
import 'package:get/get.dart';
import 'package:get/get_core/src/get_main.dart';
import '../../../core/data/data_provider.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../../utility/color_list.dart';
import '../../../utility/constants.dart';
import '../../../models/sub_category.dart';
import 'add_sub_category_form.dart';

class SubCategoryListSection extends StatelessWidget {
  const SubCategoryListSection({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
      decoration: const BoxDecoration(
        color: secondaryColor,
        borderRadius: BorderRadius.all(Radius.circular(10)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text("All Sub Categories",
              style: Theme.of(context).textTheme.titleMedium),
          const SizedBox(height: defaultPadding),
          Consumer<DataProvider>(
            builder: (context, dataProvider, child) {
              return ResponsiveDataTable(
                columns: const [
                  DataColumn(label: Text("Sub Category")),
                  DataColumn(label: Text("Category")),
                  DataColumn(label: Text("Added Date")),
                  DataColumn(label: Text("Edit")),
                  DataColumn(label: Text("Delete")),
                ],
                rows: List.generate(
                  dataProvider.subCategories.length,
                  (index) => subCategoryDataRow(
                    context, // Add context
                    dataProvider.subCategories[index],
                    index + 1,
                    edit: () {
                      // TODO: Implement edit subcategory form
                    },
                    delete: () {
                      context.subCategoryProvider
                          .deleteSubCategory(dataProvider.subCategories[index]);
                    },
                  ),
                ),
              );
            },
          ),
        ],
      ),
    );
  }
}

DataRow subCategoryDataRow(
    BuildContext context, SubCategory subCategoryInfo, int index,
    {Function? edit, Function? delete}) {
  return DataRow(
    cells: [
      DataCell(
        Row(
          children: [
            Container(
              width: 36,
              height: 36,
              decoration: BoxDecoration(
                color: colors[index % colors.length],
                shape: BoxShape.circle,
              ),
              child: Center(
                child: Text(
                  '${index}',
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 14,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Text(
                    subCategoryInfo.name ?? 'No Name',
                    style: const TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.w500,
                      fontSize: 14,
                    ),
                    overflow: TextOverflow.ellipsis,
                    maxLines: 1,
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
      DataCell(
        Column(
          mainAxisAlignment: MainAxisAlignment.center,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              subCategoryInfo.categoryId?.name ?? 'N/A',
              style: const TextStyle(color: Colors.white70),
              overflow: TextOverflow.ellipsis,
              maxLines: 1,
            ),
          ],
        ),
      ),
      DataCell(
        Column(
          mainAxisAlignment: MainAxisAlignment.center,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              _formatDate(subCategoryInfo.createdAt),
              style: const TextStyle(color: Colors.white70),
              overflow: TextOverflow.ellipsis,
              maxLines: 1,
            ),
          ],
        ),
      ),
      DataCell(
        IconButton(
          onPressed: Get.find<AdminAuthService>().canEditItem(subCategoryInfo)
              ? () {
                  if (edit != null) edit();
                }
              : null,
          icon: Get.find<AdminAuthService>().canEditItem(subCategoryInfo)
              ? const Icon(Icons.edit, color: Colors.blue, size: 20)
              : const Icon(Icons.lock, color: Colors.grey, size: 20),
          tooltip: Get.find<AdminAuthService>().canEditItem(subCategoryInfo)
              ? 'Edit Sub Category'
              : 'No permission',
        ),
      ),
      DataCell(
        IconButton(
          onPressed: Get.find<AdminAuthService>().canDeleteItem(subCategoryInfo)
              ? () {
                  if (delete != null) delete();
                }
              : null,
          icon: Get.find<AdminAuthService>().canDeleteItem(subCategoryInfo)
              ? const Icon(Icons.delete, color: Colors.red, size: 20)
              : const Icon(Icons.lock, color: Colors.grey, size: 20),
          tooltip: Get.find<AdminAuthService>().canDeleteItem(subCategoryInfo)
              ? 'Delete Sub Category'
              : 'No permission',
        ),
      ),
    ],
  );
}

String _formatDate(String? dateString) {
  if (dateString == null) return 'N/A';
  try {
    final date = DateTime.parse(dateString);
    return '${date.day}/${date.month}/${date.year}';
  } catch (e) {
    return dateString;
  }
}

========== FILE: lib/screens/sub_category/provider/sub_category_provider.dart ==========

import 'package:flutter/cupertino.dart';
import 'package:get/get.dart';
import '../../../core/data/data_provider.dart';
import '../../../models/category.dart';
import '../../../models/sub_category.dart';
import '../../../services/admin_auth_service.dart';
import '../../../services/http_services.dart';
import 'package:admin_panal_start/models/api_response.dart';
import 'package:admin_panal_start/utility/snack_bar_helper.dart';
import 'package:admin_panal_start/utility/error_utils.dart';

class SubCategoryProvider extends ChangeNotifier {
  HttpService service = HttpService();
  final DataProvider _dataProvider;
  final AdminAuthService _authService = Get.find<AdminAuthService>();

  final addSubCategoryFormKey = GlobalKey<FormState>();
  TextEditingController subCategoryNameCtrl = TextEditingController();
  Category? selectedCategory;
  SubCategory? subCategoryForUpdate;

  SubCategoryProvider(this._dataProvider);

  addSubCategory() async {
    try {
      Map<String, dynamic> subCategory = {
        'name': subCategoryNameCtrl.text,
        'categoryId': selectedCategory?.sId,
        'createdBy': _authService.getUserId(), // Add createdBy
      };

      final response = await service.addItem(
        endpointUrl: 'subCategories',
        itemData: subCategory,
      );

      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          clearFields();
          SnackBarHelper.showSuccessSnackBar('Sub Category added successfully');
          _dataProvider.getAllSubCategory();
        } else {
          SnackBarHelper.showOperationErrorSnackBar('add', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar('add', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('add', e);
      rethrow;
    }
  }

  updateSubCategory() async {
    try {
      // Check permission
      if (!_authService.canEditItem(subCategoryForUpdate)) {
        SnackBarHelper.showErrorSnackBar(
            'You do not have permission to edit this sub category');
        return;
      }

      Map<String, dynamic> subCategory = {
        'name': subCategoryNameCtrl.text,
        'categoryId': selectedCategory?.sId,
      };

      final response = await service.updateItem(
        endpointUrl: 'subCategories',
        itemId: subCategoryForUpdate?.sId ?? '',
        itemData: subCategory,
      );

      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          clearFields();
          SnackBarHelper.showSuccessSnackBar(
              'Sub Category updated successfully');
          _dataProvider.getAllSubCategory();
        } else {
          SnackBarHelper.showOperationErrorSnackBar(
              'update', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar(
            'update', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('update', e);
      rethrow;
    }
  }

  submitSubCategory() {
    if (subCategoryForUpdate != null) {
      updateSubCategory();
    } else {
      addSubCategory();
    }
  }

  deleteSubCategory(SubCategory subCategory) async {
    try {
      // Check permission
      if (!_authService.canDeleteItem(subCategory)) {
        SnackBarHelper.showErrorSnackBar(
            'You do not have permission to delete this sub category');
        return;
      }

      Response response = await service.deleteItem(
        endpointUrl: 'subCategories',
        itemId: subCategory.sId ?? '',
      );

      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          SnackBarHelper.showSuccessSnackBar(
              "Sub Category deleted successfully");
          _dataProvider.getAllSubCategory();
        } else {
          SnackBarHelper.showOperationErrorSnackBar(
              'delete', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar(
            'delete', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('delete', e);
      rethrow;
    }
  }

  setDataForUpdateSubCategory(SubCategory? subCategory) {
    if (subCategory != null) {
      subCategoryForUpdate = subCategory;
      subCategoryNameCtrl.text = subCategory.name ?? '';
      selectedCategory = _dataProvider.categories.firstWhereOrNull(
        (element) => element.sId == subCategory.categoryId?.sId,
      );
    } else {
      clearFields();
    }
  }

  clearFields() {
    subCategoryNameCtrl.clear();
    selectedCategory = null;
    subCategoryForUpdate = null;
  }

  updateUI() {
    notifyListeners();
  }
}

========== FILE: lib/screens/sub_category/sub_category_screen.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import '../../utility/constants.dart';
import 'components/add_sub_category_form.dart';
import 'components/sub_category_header.dart';
import 'components/sub_category_list_section.dart';

class SubCategoryScreen extends StatefulWidget {
  @override
  State<SubCategoryScreen> createState() => _SubCategoryScreenState();
}

class _SubCategoryScreenState extends State<SubCategoryScreen> {
  @override
  void initState() {
    super.initState();
    // Auto-load subcategories when screen is created
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.dataProvider.getAllSubCategory();
    });
  }

  @override
  Widget build(BuildContext context) {
    return SafeArea(
      child: SingleChildScrollView(
        primary: false,
        padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
        child: Column(
          children: [
            SubCategoryHeader(),
            Gap(defaultPadding),
            Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Expanded(
                  flex: 5,
                  child: Column(
                    children: [
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Expanded(
                            child: Text(
                              "My Sub Categories",
                              style: Theme.of(context).textTheme.titleMedium,
                            ),
                          ),
                          ElevatedButton.icon(
                            style: TextButton.styleFrom(
                              padding: EdgeInsets.symmetric(
                                horizontal: ResponsiveUtils.isMobile(context)
                                    ? defaultPadding
                                    : defaultPadding * 1.5,
                                vertical: ResponsiveUtils.isMobile(context)
                                    ? defaultPadding / 2
                                    : defaultPadding,
                              ),
                            ),
                            onPressed: () {
                              showAddSubCategoryForm(context, null);
                            },
                            icon: Icon(Icons.add),
                            label: Text("Add New"),
                          ),
                          Gap(ResponsiveUtils.isMobile(context) ? 8 : 20),
                          IconButton(
                            onPressed: () {
                              context.dataProvider
                                  .getAllSubCategory(showSnack: true);
                            },
                            icon: Icon(Icons.refresh),
                          ),
                        ],
                      ),
                      Gap(defaultPadding),
                      SubCategoryListSection(),
                    ],
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}

========== FILE: lib/screens/users/components/add_user_form.dart ==========

import 'package:admin_panal_start/models/api_response.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:admin_panal_start/widgets/compact_form_dialog.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import 'package:get/get.dart';
import '../../../models/admin_user.dart';
import '../../../services/admin_auth_service.dart';
import '../../../utility/constants.dart';
import '../../../utility/snack_bar_helper.dart';
import '../../../widgets/custom_dropdown.dart';
import '../../../widgets/custom_text_field.dart';

class UserSubmitForm extends StatefulWidget {
  final AdminUser? user;
  final Function()? onUserAdded;

  const UserSubmitForm({super.key, this.user, this.onUserAdded});

  @override
  State<UserSubmitForm> createState() => _UserSubmitFormState();
}

class _UserSubmitFormState extends State<UserSubmitForm> {
  final _formKey = GlobalKey<FormState>();
  final _usernameCtrl = TextEditingController();
  final _nameCtrl = TextEditingController();
  final _emailCtrl = TextEditingController();
  final _passwordCtrl = TextEditingController();
  final _confirmPasswordCtrl = TextEditingController();

  String _selectedClearanceLevel = 'admin';
  bool _isLoading = false;

  final AdminAuthService _authService = Get.find<AdminAuthService>();

  @override
  void initState() {
    super.initState();
    if (widget.user != null) {
      _setDataForUpdate(widget.user!);
    }
  }

  void _setDataForUpdate(AdminUser user) {
    _usernameCtrl.text = user.username ?? '';
    _nameCtrl.text = user.name ?? '';
    _emailCtrl.text = user.email ?? '';
    _selectedClearanceLevel = user.clearanceLevel ?? 'admin';
  }

  Future<void> _submitForm() async {
    if (!_formKey.currentState!.validate()) return;

    if (widget.user == null &&
        _passwordCtrl.text != _confirmPasswordCtrl.text) {
      SnackBarHelper.showErrorSnackBar('Passwords do not match');
      return;
    }

    setState(() {
      _isLoading = true;
    });

    try {
      final userData = {
        'username': _usernameCtrl.text.trim(),
        'name': _nameCtrl.text.trim(),
        'email': _emailCtrl.text.trim(),
        'clearanceLevel': _selectedClearanceLevel,
      };

      // Only include password for new users
      if (widget.user == null) {
        userData['password'] = _passwordCtrl.text;
      }

      ApiResponse<AdminUser> result;

      if (widget.user != null) {
        result =
            await _authService.updateAdminUser(widget.user!.sId!, userData);
      } else {
        result = await _authService.createAdminUser(userData);
      }

      if (result.success) {
        SnackBarHelper.showSuccessSnackBar(result.message);
        widget.onUserAdded?.call();
        Navigator.of(context).pop();
      } else {
        SnackBarHelper.showErrorSnackBar(result.message);
      }
    } catch (e) {
      SnackBarHelper.showErrorSnackBar('Failed to save user: $e');
    } finally {
      setState(() {
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    final isEditing = widget.user != null;

    return SingleChildScrollView(
      child: Form(
        key: _formKey,
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Gap(ResponsiveUtils.getPadding(context)),
            CustomTextField(
              controller: _usernameCtrl,
              labelText: 'Username',
              validator: (value) {
                if (value == null || value.isEmpty) {
                  return 'Please enter username';
                }
                if (value.length < 3) {
                  return 'Username must be at least 3 characters';
                }
                return null;
              },
            ),
            const Gap(8),
            CustomTextField(
              controller: _nameCtrl,
              labelText: 'Full Name',
              validator: (value) {
                if (value == null || value.isEmpty) {
                  return 'Please enter full name';
                }
                return null;
              },
            ),
            const Gap(8),
            CustomTextField(
              controller: _emailCtrl,
              labelText: 'Email',
              inputType: TextInputType.emailAddress,
              validator: (value) {
                if (value == null || value.isEmpty) {
                  return 'Please enter email';
                }
                if (!value.contains('@')) {
                  return 'Please enter a valid email';
                }
                return null;
              },
            ),
            const Gap(8),
            if (!isEditing) ...[
              CustomTextField(
                controller: _passwordCtrl,
                labelText: 'Password',
                obscureText: true,
                validator: (value) {
                  if (value == null || value.isEmpty) {
                    return 'Please enter password';
                  }
                  if (value.length < 6) {
                    return 'Password must be at least 6 characters';
                  }
                  return null;
                },
              ),
              const Gap(8),
              CustomTextField(
                controller: _confirmPasswordCtrl,
                labelText: 'Confirm Password',
                obscureText: true,
                validator: (value) {
                  if (value == null || value.isEmpty) {
                    return 'Please confirm password';
                  }
                  return null;
                },
              ),
              const Gap(8),
            ],
            CustomDropdown(
              hintText: 'Select clearance level',
              initialValue: _selectedClearanceLevel,
              items: const ['admin', 'super_admin'],
              displayItem: (val) =>
                  val == 'super_admin' ? 'Super Admin' : 'Admin',
              onChanged: (newValue) {
                setState(() {
                  _selectedClearanceLevel = newValue ?? 'admin';
                });
              },
              validator: (value) {
                if (value == null) {
                  return 'Please select clearance level';
                }
                return null;
              },
            ),
            Gap(ResponsiveUtils.getPadding(context) * 2),
            _isLoading
                ? const Center(child: CircularProgressIndicator())
                : Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      ElevatedButton(
                        style: ElevatedButton.styleFrom(
                          foregroundColor: Colors.white,
                          backgroundColor: secondaryColor,
                        ),
                        onPressed: () {
                          Navigator.of(context).pop();
                        },
                        child: const Text('Cancel'),
                      ),
                      SizedBox(width: ResponsiveUtils.getPadding(context)),
                      ElevatedButton(
                        style: ElevatedButton.styleFrom(
                          foregroundColor: Colors.white,
                          backgroundColor: primaryColor,
                        ),
                        onPressed: _submitForm,
                        child: Text(isEditing ? 'Update User' : 'Create User'),
                      ),
                    ],
                  ),
            const Gap(16),
          ],
        ),
      ),
    );
  }

  @override
  void dispose() {
    _usernameCtrl.dispose();
    _nameCtrl.dispose();
    _emailCtrl.dispose();
    _passwordCtrl.dispose();
    _confirmPasswordCtrl.dispose();
    super.dispose();
  }
}

void showAddUserForm(BuildContext context, AdminUser? user,
    {Function()? onUserAdded}) {
  showDialog(
    context: context,
    builder: (BuildContext context) {
      return CompactFormDialog(
        title: user == null ? 'Add Admin User' : 'Edit User',
        child: UserSubmitForm(user: user, onUserAdded: onUserAdded),
      );
    },
  );
}

========== FILE: lib/screens/users/users_screen.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:admin_panal_start/widgets/responsive_data_table.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import 'package:get/get.dart';
import '../../models/admin_user.dart';
import '../../services/admin_auth_service.dart';
import '../../utility/color_list.dart';
import '../../utility/constants.dart';
import '../../utility/snack_bar_helper.dart';
import '../../widgets/responsive_header.dart';
import 'components/add_user_form.dart';

class UsersScreen extends StatefulWidget {
  const UsersScreen({super.key});

  @override
  State<UsersScreen> createState() => _UsersScreenState();
}

class _UsersScreenState extends State<UsersScreen> {
  final AdminAuthService _authService = Get.find<AdminAuthService>();
  bool _isLoading = false;

  @override
  void initState() {
    super.initState();
    _loadUsers();
  }

  Future<void> _loadUsers() async {
    if (!_authService.canManageUsers()) return;

    setState(() {
      _isLoading = true;
    });

    try {
      final result = await _authService.getAdminUsers();
      if (!result.success) {
        SnackBarHelper.showErrorSnackBar(result.message);
      }
    } catch (e) {
      SnackBarHelper.showErrorSnackBar('Failed to load users: $e');
    } finally {
      setState(() {
        _isLoading = false;
      });
    }
  }

  Future<void> _deleteUser(AdminUser user) async {
    final currentUser = _authService.currentUser;
    if (currentUser.value?.sId == user.sId) {
      SnackBarHelper.showErrorSnackBar('You cannot delete your own account');
      return;
    }

    final shouldDelete = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: secondaryColor,
        title: const Text(
          "Delete User",
          style: TextStyle(color: Colors.white),
        ),
        content: Text(
          "Are you sure you want to delete ${user.name}? This action cannot be undone.",
          style: const TextStyle(color: Colors.white70),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(false),
            child:
                const Text("Cancel", style: TextStyle(color: Colors.white70)),
          ),
          ElevatedButton(
            onPressed: () => Navigator.of(context).pop(true),
            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
            child: const Text("Delete"),
          ),
        ],
      ),
    );

    if (shouldDelete == true) {
      try {
        final result = await _authService.deleteAdminUser(user.sId!);
        if (result.success) {
          SnackBarHelper.showSuccessSnackBar('User deleted successfully');
        } else {
          SnackBarHelper.showErrorSnackBar(result.message);
        }
      } catch (e) {
        SnackBarHelper.showErrorSnackBar('Failed to delete user: $e');
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return SafeArea(
      child: SingleChildScrollView(
        primary: false,
        padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
        child: Column(
          children: [
            _buildHeader(),
            const Gap(defaultPadding),
            _buildUserListSection(),
          ],
        ),
      ),
    );
  }

  Widget _buildHeader() {
    return ResponsiveHeader(
      title: "User Management",
      onSearch: (val) {
        // Implement search functionality
      },
      actionButton: _authService.canManageUsers()
          ? () => showAddUserForm(context, null, onUserAdded: _loadUsers)
          : null,
    );
  }

  Widget _buildUserListSection() {
    if (!_authService.canManageUsers()) {
      return Container(
        padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
        decoration: const BoxDecoration(
          color: secondaryColor,
          borderRadius: BorderRadius.all(Radius.circular(10)),
        ),
        child: const Center(
          child: Text(
            "You don't have permission to manage users",
            style: TextStyle(color: Colors.white70, fontSize: 16),
          ),
        ),
      );
    }

    if (_isLoading) {
      return const Center(
        child: Padding(
          padding: EdgeInsets.all(40),
          child: CircularProgressIndicator(),
        ),
      );
    }

    final users = _authService.allAdminUsers;

    return Container(
      padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
      decoration: const BoxDecoration(
        color: secondaryColor,
        borderRadius: BorderRadius.all(Radius.circular(10)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                "Admin Users (${users.length})",
                style: const TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w500,
                  color: Colors.white,
                ),
              ),
              IconButton(
                onPressed: _loadUsers,
                icon: const Icon(Icons.refresh, color: Colors.white),
              ),
            ],
          ),
          const Gap(defaultPadding),
          if (users.isEmpty)
            const Center(
              child: Column(
                children: [
                  Icon(Icons.people_outline, size: 64, color: Colors.white54),
                  Gap(16),
                  Text(
                    "No admin users found",
                    style: TextStyle(color: Colors.white70, fontSize: 16),
                  ),
                  Gap(8),
                  Text(
                    "Click 'Add Admin' to create the first user",
                    style: TextStyle(color: Colors.white54, fontSize: 14),
                  ),
                ],
              ),
            )
          else
            ResponsiveDataTable(
              columns: const [
                DataColumn(label: Text("User")),
                DataColumn(label: Text("Email")),
                DataColumn(label: Text("Role")),
                DataColumn(label: Text("Created")),
                DataColumn(label: Text("Edit")),
                DataColumn(label: Text("Delete")),
              ],
              rows: List.generate(
                users.length,
                (index) => _userDataRow(users[index], index + 1),
              ),
            ),
        ],
      ),
    );
  }

  DataRow _userDataRow(AdminUser user, int index) {
    final currentUser = _authService.currentUser;
    final isCurrentUser = currentUser.value?.sId == user.sId;

    return DataRow(
      cells: [
        DataCell(
          Row(
            children: [
              Container(
                height: 36,
                width: 36,
                decoration: BoxDecoration(
                  color: colors[index % colors.length],
                  shape: BoxShape.circle,
                ),
                child: Center(
                  child: Text(
                    user.name?.substring(0, 1).toUpperCase() ?? 'U',
                    style: const TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ),
              const SizedBox(width: 12),
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Text(
                    user.name ?? 'No Name',
                    style: const TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                  Text(
                    '@${user.username}',
                    style: const TextStyle(
                      color: Colors.white70,
                      fontSize: 12,
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
        DataCell(
          Text(
            user.email ?? 'No email',
            style: const TextStyle(color: Colors.white70),
          ),
        ),
        DataCell(
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
            decoration: BoxDecoration(
              color: user.isSuperAdmin ? Colors.purple : Colors.blue,
              borderRadius: BorderRadius.circular(12),
            ),
            child: Text(
              user.isSuperAdmin ? 'Super Admin' : 'Admin',
              style: const TextStyle(
                color: Colors.white,
                fontSize: 12,
                fontWeight: FontWeight.w500,
              ),
            ),
          ),
        ),
        DataCell(
          Text(
            _formatDate(user.createdAt),
            style: const TextStyle(color: Colors.white70),
          ),
        ),
        DataCell(
          IconButton(
            onPressed: () {
              showAddUserForm(context, user, onUserAdded: _loadUsers);
            },
            icon: const Icon(Icons.edit, color: Colors.blue, size: 20),
            tooltip: 'Edit User',
          ),
        ),
        DataCell(
          IconButton(
            onPressed: isCurrentUser ? null : () => _deleteUser(user),
            icon: Icon(Icons.delete,
                color: isCurrentUser ? Colors.grey : Colors.red, size: 20),
            tooltip: isCurrentUser
                ? 'Cannot delete your own account'
                : 'Delete User',
          ),
        ),
      ],
    );
  }

  String _formatDate(String? dateString) {
    if (dateString == null) return 'N/A';
    try {
      final date = DateTime.parse(dateString);
      return '${date.day}/${date.month}/${date.year}';
    } catch (e) {
      return dateString;
    }
  }
}

========== FILE: lib/screens/variants/components/add_variant_form.dart ==========

import '../../../models/variant.dart';
import '../../../models/variant_type.dart';
import '../../../utility/responsive_utils.dart';
import '../../../widgets/compact_form_dialog.dart';
import '../provider/variant_provider.dart';
import '../../../utility/extensions.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../../utility/constants.dart';
import '../../../widgets/custom_dropdown.dart';
import '../../../widgets/custom_text_field.dart';
import '../../../utility/extensions.dart';

class VariantSubmitForm extends StatelessWidget {
  final Variant? variant;

  const VariantSubmitForm({super.key, this.variant});

  @override
  Widget build(BuildContext context) {
    context.variantProvider.setDataForUpdateVariant(variant);
    return SingleChildScrollView(
      child: Form(
        key: context.variantProvider.addVariantFormKey,
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            SizedBox(height: ResponsiveUtils.getPadding(context)),
            _buildFormFields(context),
            SizedBox(height: ResponsiveUtils.getPadding(context) * 2),
            _buildActionButtons(context),
          ],
        ),
      ),
    );
  }

  Widget _buildFormFields(BuildContext context) {
    if (ResponsiveUtils.isMobile(context)) {
      return Column(
        children: [
          _buildVariantTypeDropdown(context),
          SizedBox(height: 8),
          _buildNameField(context),
        ],
      );
    } else {
      return Row(
        children: [
          Expanded(child: _buildVariantTypeDropdown(context)),
          SizedBox(width: 8),
          Expanded(child: _buildNameField(context)),
        ],
      );
    }
  }

  Widget _buildVariantTypeDropdown(BuildContext context) {
    return Consumer<VariantProvider>(
      builder: (context, variantProvider, child) {
        return CustomDropdown(
          initialValue: variantProvider.selectedVariantType,
          items: context.dataProvider.variantTypes,
          hintText: variantProvider.selectedVariantType?.name ??
              'Select Variant Type',
          displayItem: (VariantType? variantType) => variantType?.name ?? '',
          onChanged: (newValue) {
            variantProvider.selectedVariantType = newValue;
            variantProvider.updateUI();
          },
          validator: (value) {
            if (value == null) {
              return 'Please select a Variant Type';
            }
            return null;
          },
        );
      },
    );
  }

  Widget _buildNameField(BuildContext context) {
    return CustomTextField(
      controller: context.variantProvider.variantNameCtrl,
      labelText: 'Variant Name',
      onSave: (val) {},
      validator: (value) {
        if (value == null || value.isEmpty) {
          return 'Please enter a variant name';
        }
        return null;
      },
    );
  }

  Widget _buildActionButtons(BuildContext context) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        ElevatedButton(
          style: ElevatedButton.styleFrom(
            foregroundColor: Colors.white,
            backgroundColor: secondaryColor,
          ),
          onPressed: () {
            Navigator.of(context).pop();
          },
          child: Text('Cancel'),
        ),
        SizedBox(width: ResponsiveUtils.getPadding(context)),
        ElevatedButton(
          style: ElevatedButton.styleFrom(
            foregroundColor: Colors.white,
            backgroundColor: primaryColor,
          ),
          onPressed: () {
            if (context.variantProvider.addVariantFormKey.currentState!
                .validate()) {
              context.variantProvider.addVariantFormKey.currentState!.save();
              context.variantProvider.submitVariant();
              Navigator.of(context).pop();
            }
          },
          child: Text('Submit'),
        ),
      ],
    );
  }
}

void showAddVariantForm(BuildContext context, Variant? variant) {
  showDialog(
    context: context,
    builder: (BuildContext context) {
      return CompactFormDialog(
        title: 'Add Variant',
        child: VariantSubmitForm(variant: variant),
      );
    },
  );
}

========== FILE: lib/screens/variants/components/variant_header.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';
import 'package:flutter/material.dart';
import '../../../widgets/responsive_header.dart';

class VariantHeader extends StatelessWidget {
  const VariantHeader({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return ResponsiveHeader(
      title: "Variants",
      onSearch: (val) => context.dataProvider.filterVariants(val),
    );
  }
}

========== FILE: lib/screens/variants/components/variants_list_section.dart ==========

import 'package:admin_panal_start/services/admin_auth_service.dart';
import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:admin_panal_start/widgets/responsive_data_table.dart';
import 'package:get/get.dart';
import '../../../core/data/data_provider.dart';
import 'add_variant_form.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../../utility/color_list.dart';
import '../../../utility/constants.dart';
import '../../../models/variant.dart';

class VariantListSection extends StatelessWidget {
  const VariantListSection({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
      decoration: const BoxDecoration(
        color: secondaryColor,
        borderRadius: BorderRadius.all(Radius.circular(10)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text("All Variants", style: Theme.of(context).textTheme.titleMedium),
          const SizedBox(height: defaultPadding),
          Consumer<DataProvider>(
            builder: (context, dataProvider, child) {
              return ResponsiveDataTable(
                columns: const [
                  DataColumn(label: Text("Variant")),
                  DataColumn(label: Text("Variant Type")),
                  DataColumn(label: Text("Added Date")),
                  DataColumn(label: Text("Edit")),
                  DataColumn(label: Text("Delete")),
                ],
                rows: List.generate(
                  dataProvider.variants.length,
                  (index) => variantDataRow(
                    context,
                    dataProvider.variants[index],
                    index + 1,
                    edit: () {
                      showAddVariantForm(context, dataProvider.variants[index]);
                    },
                    delete: () {
                      context.variantProvider
                          .deleteVariant(dataProvider.variants[index]);
                    },
                  ),
                ),
              );
            },
          ),
        ],
      ),
    );
  }
}

DataRow variantDataRow(BuildContext context, Variant variantInfo, int index,
    {Function? edit, Function? delete}) {
  return DataRow(
    cells: [
      DataCell(
        Row(
          children: [
            Container(
              width: 36,
              height: 36,
              decoration: BoxDecoration(
                color: colors[index % colors.length],
                shape: BoxShape.circle,
              ),
              child: Center(
                child: Text(
                  '$index',
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 14,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Text(
                    variantInfo.name ?? 'No Name',
                    style: const TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.w500,
                      fontSize: 14,
                    ),
                    overflow: TextOverflow.ellipsis,
                    maxLines: 1,
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
      DataCell(
        Column(
          mainAxisAlignment: MainAxisAlignment.center,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              variantInfo.variantTypeId?.name ?? 'N/A',
              style: const TextStyle(color: Colors.white70),
              overflow: TextOverflow.ellipsis,
              maxLines: 1,
            ),
          ],
        ),
      ),
      DataCell(
        Column(
          mainAxisAlignment: MainAxisAlignment.center,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              _formatDate(variantInfo.createdAt),
              style: const TextStyle(color: Colors.white70),
              overflow: TextOverflow.ellipsis,
              maxLines: 1,
            ),
          ],
        ),
      ),
      DataCell(
        IconButton(
          onPressed: Get.find<AdminAuthService>().canEditItem(variantInfo)
              ? () {
                  if (edit != null) edit();
                }
              : null,
          icon: Get.find<AdminAuthService>().canEditItem(variantInfo)
              ? const Icon(Icons.edit, color: Colors.blue, size: 20)
              : const Icon(Icons.lock, color: Colors.grey, size: 20),
          tooltip: Get.find<AdminAuthService>().canEditItem(variantInfo)
              ? 'Edit Variant'
              : 'No permission',
        ),
      ),
      DataCell(
        IconButton(
          onPressed: Get.find<AdminAuthService>().canDeleteItem(variantInfo)
              ? () {
                  if (delete != null) delete();
                }
              : null,
          icon: Get.find<AdminAuthService>().canDeleteItem(variantInfo)
              ? const Icon(Icons.delete, color: Colors.red, size: 20)
              : const Icon(Icons.lock, color: Colors.grey, size: 20),
          tooltip: Get.find<AdminAuthService>().canDeleteItem(variantInfo)
              ? 'Delete Variant'
              : 'No permission',
        ),
      ),
    ],
  );
}

String _formatDate(String? dateString) {
  if (dateString == null) return 'N/A';
  try {
    final date = DateTime.parse(dateString);
    return '${date.day}/${date.month}/${date.year}';
  } catch (e) {
    return dateString;
  }
}

========== FILE: lib/screens/variants/provider/variant_provider.dart ==========

import 'package:flutter/cupertino.dart';
import 'package:get/get.dart';
import '../../../core/data/data_provider.dart';
import '../../../models/variant.dart';
import '../../../models/variant_type.dart';
import '../../../services/admin_auth_service.dart';
import '../../../services/http_services.dart';
import 'package:admin_panal_start/models/api_response.dart';
import 'package:admin_panal_start/utility/snack_bar_helper.dart';
import 'package:admin_panal_start/utility/error_utils.dart';

class VariantProvider extends ChangeNotifier {
  HttpService service = HttpService();
  final DataProvider _dataProvider;
  final AdminAuthService _authService = Get.find<AdminAuthService>();

  final addVariantFormKey = GlobalKey<FormState>();
  TextEditingController variantNameCtrl = TextEditingController();
  VariantType? selectedVariantType;
  Variant? variantForUpdate;

  VariantProvider(this._dataProvider);

  addVariant() async {
    try {
      final currentUserId = _authService.getUserId();

      Map<String, dynamic> variant = {
        'name': variantNameCtrl.text,
        'variantTypeId': selectedVariantType?.sId,
        'createdBy': currentUserId, // Add createdBy
      };

      final response = await service.addItem(
        endpointUrl: 'variants',
        itemData: variant,
      );

      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          clearFields();
          SnackBarHelper.showSuccessSnackBar('Variant added successfully');
          _dataProvider.getAllVariant();
        } else {
          SnackBarHelper.showOperationErrorSnackBar('add', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar('add', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('add', e);
      rethrow;
    }
  }

  updateVariant() async {
    try {
      // Check permission
      if (!_authService.canEditItem(variantForUpdate)) {
        SnackBarHelper.showErrorSnackBar(
            'You do not have permission to edit this variant');
        return;
      }

      Map<String, dynamic> variant = {
        'name': variantNameCtrl.text,
        'variantTypeId': selectedVariantType?.sId,
      };

      final response = await service.updateItem(
        endpointUrl: 'variants',
        itemId: variantForUpdate?.sId ?? '',
        itemData: variant,
      );

      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          clearFields();
          SnackBarHelper.showSuccessSnackBar('Variant updated successfully');
          _dataProvider.getAllVariant();
        } else {
          SnackBarHelper.showOperationErrorSnackBar(
              'update', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar(
            'update', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('update', e);
      rethrow;
    }
  }

  submitVariant() {
    if (variantForUpdate != null) {
      updateVariant();
    } else {
      addVariant();
    }
  }

  deleteVariant(Variant variant) async {
    try {
      // Check permission
      if (!_authService.canDeleteItem(variant)) {
        SnackBarHelper.showErrorSnackBar(
            'You do not have permission to delete this variant');
        return;
      }

      Response response = await service.deleteItem(
        endpointUrl: 'variants',
        itemId: variant.sId ?? '',
      );

      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          SnackBarHelper.showSuccessSnackBar("Variant deleted successfully");
          _dataProvider.getAllVariant();
        } else {
          SnackBarHelper.showOperationErrorSnackBar(
              'delete', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar(
            'delete', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('delete', e);
      rethrow;
    }
  }

  setDataForUpdateVariant(Variant? variant) {
    if (variant != null) {
      variantForUpdate = variant;
      variantNameCtrl.text = variant.name ?? '';
      selectedVariantType = _dataProvider.variantTypes.firstWhereOrNull(
        (element) => element.sId == variant.variantTypeId?.sId,
      );
    } else {
      clearFields();
    }
  }

  clearFields() {
    variantNameCtrl.clear();
    selectedVariantType = null;
    variantForUpdate = null;
  }

  updateUI() {
    notifyListeners();
  }
}

========== FILE: lib/screens/variants_type/components/add_variant_type_form.dart ==========

import '../../../models/variant_type.dart';
import '../../../utility/responsive_utils.dart';
import '../../../widgets/compact_form_dialog.dart';
import '../../../utility/extensions.dart';
import 'package:flutter/material.dart';
import '../../../utility/constants.dart';
import '../../../widgets/custom_text_field.dart';

class VariantTypeSubmitForm extends StatelessWidget {
  final VariantType? variantType;

  const VariantTypeSubmitForm({super.key, this.variantType});

  @override
  Widget build(BuildContext context) {
    context.variantTypeProvider.setDataForUpdateVariantType(variantType);
    return SingleChildScrollView(
      child: Form(
        key: context.variantTypeProvider.addVariantTypeFormKey,
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            SizedBox(height: ResponsiveUtils.getPadding(context)),
            _buildFormFields(context),
            SizedBox(height: ResponsiveUtils.getPadding(context) * 2),
            _buildActionButtons(context),
          ],
        ),
      ),
    );
  }

  Widget _buildFormFields(BuildContext context) {
    if (ResponsiveUtils.isMobile(context)) {
      return Column(
        children: [
          _buildNameField(context),
          SizedBox(height: 8),
          _buildTypeField(context),
        ],
      );
    } else {
      return Row(
        children: [
          Expanded(child: _buildNameField(context)),
          SizedBox(width: 8),
          Expanded(child: _buildTypeField(context)),
        ],
      );
    }
  }

  Widget _buildNameField(BuildContext context) {
    return CustomTextField(
      controller: context.variantTypeProvider.variantTypeNameCtrl,
      labelText: 'Variant Name',
      onSave: (val) {},
      validator: (value) {
        if (value == null || value.isEmpty) {
          return 'Please enter a variant name';
        }
        return null;
      },
    );
  }

  Widget _buildTypeField(BuildContext context) {
    return CustomTextField(
      controller: context.variantTypeProvider.variantTypeTypeCtrl,
      labelText: 'Variant Type',
      onSave: (val) {},
      validator: (value) {
        if (value == null || value.isEmpty) {
          return 'Please enter a type name';
        }
        return null;
      },
    );
  }

  Widget _buildActionButtons(BuildContext context) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        ElevatedButton(
          style: ElevatedButton.styleFrom(
            foregroundColor: Colors.white,
            backgroundColor: secondaryColor,
          ),
          onPressed: () {
            Navigator.of(context).pop();
          },
          child: Text('Cancel'),
        ),
        SizedBox(width: ResponsiveUtils.getPadding(context)),
        ElevatedButton(
          style: ElevatedButton.styleFrom(
            foregroundColor: Colors.white,
            backgroundColor: primaryColor,
          ),
          onPressed: () {
            if (context.variantTypeProvider.addVariantTypeFormKey.currentState!
                .validate()) {
              context.variantTypeProvider.addVariantTypeFormKey.currentState!
                  .save();
              context.variantTypeProvider.submitVariantType();
              Navigator.of(context).pop();
            }
          },
          child: Text('Submit'),
        ),
      ],
    );
  }
}

void showAddVariantsTypeForm(BuildContext context, VariantType? variantType) {
  showDialog(
    context: context,
    builder: (BuildContext context) {
      return CompactFormDialog(
        title: 'Add Variant Type',
        child: VariantTypeSubmitForm(variantType: variantType),
      );
    },
  );
}

========== FILE: lib/screens/variants_type/components/variant_type_header.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';
import 'package:flutter/material.dart';
import '../../../widgets/responsive_header.dart';

class VariantTypeHeader extends StatelessWidget {
  const VariantTypeHeader({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return ResponsiveHeader(
      title: "Variant Types",
      onSearch: (val) => context.dataProvider.filterVariantTypes(val),
    );
  }
}

========== FILE: lib/screens/variants_type/components/variant_type_list_section.dart ==========

import 'package:admin_panal_start/services/admin_auth_service.dart';
import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:admin_panal_start/widgets/responsive_data_table.dart';
import 'package:get/get.dart';
import '../../../core/data/data_provider.dart';
import 'add_variant_type_form.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../../utility/color_list.dart';
import '../../../utility/constants.dart';
import '../../../models/variant_type.dart';

class VariantTypeListSection extends StatelessWidget {
  const VariantTypeListSection({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
      decoration: const BoxDecoration(
        color: secondaryColor,
        borderRadius: BorderRadius.all(Radius.circular(10)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text("All Variant Types",
              style: Theme.of(context).textTheme.titleMedium),
          const SizedBox(height: defaultPadding),
          Consumer<DataProvider>(
            builder: (context, dataProvider, child) {
              return ResponsiveDataTable(
                columns: const [
                  DataColumn(label: Text("Name")),
                  DataColumn(label: Text("Type")),
                  DataColumn(label: Text("Added Date")),
                  DataColumn(label: Text("Edit")),
                  DataColumn(label: Text("Delete")),
                ],
                rows: List.generate(
                  dataProvider.variantTypes.length,
                  (index) => variantTypeDataRow(
                    context,
                    dataProvider.variantTypes[index],
                    index + 1,
                    edit: () {
                      showAddVariantsTypeForm(
                          context, dataProvider.variantTypes[index]);
                    },
                    delete: () {
                      context.variantTypeProvider
                          .deleteVariantType(dataProvider.variantTypes[index]);
                    },
                  ),
                ),
              );
            },
          ),
        ],
      ),
    );
  }
}

DataRow variantTypeDataRow(
    BuildContext context, VariantType variantTypeInfo, int index,
    {Function? edit, Function? delete}) {
  return DataRow(
    cells: [
      DataCell(
        Row(
          children: [
            Container(
              width: 36,
              height: 36,
              decoration: BoxDecoration(
                color: colors[index % colors.length],
                shape: BoxShape.circle,
              ),
              child: Center(
                child: Text(
                  '$index',
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 14,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Text(
                    variantTypeInfo.name ?? 'No Name',
                    style: const TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.w500,
                      fontSize: 14,
                    ),
                    overflow: TextOverflow.ellipsis,
                    maxLines: 1,
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
      DataCell(
        Column(
          mainAxisAlignment: MainAxisAlignment.center,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              variantTypeInfo.type ?? 'N/A',
              style: const TextStyle(color: Colors.white70),
              overflow: TextOverflow.ellipsis,
              maxLines: 1,
            ),
          ],
        ),
      ),
      DataCell(
        Column(
          mainAxisAlignment: MainAxisAlignment.center,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              _formatDate(variantTypeInfo.createdAt),
              style: const TextStyle(color: Colors.white70),
              overflow: TextOverflow.ellipsis,
              maxLines: 1,
            ),
          ],
        ),
      ),
      DataCell(
        IconButton(
          onPressed: Get.find<AdminAuthService>().canEditItem(variantTypeInfo)
              ? () {
                  if (edit != null) edit();
                }
              : null,
          icon: Get.find<AdminAuthService>().canEditItem(variantTypeInfo)
              ? const Icon(Icons.edit, color: Colors.blue, size: 20)
              : const Icon(Icons.lock, color: Colors.grey, size: 20),
          tooltip: Get.find<AdminAuthService>().canEditItem(variantTypeInfo)
              ? 'Edit Variant Type'
              : 'No permission',
        ),
      ),
      DataCell(
        IconButton(
          onPressed: Get.find<AdminAuthService>().canDeleteItem(variantTypeInfo)
              ? () {
                  if (delete != null) delete();
                }
              : null,
          icon: Get.find<AdminAuthService>().canDeleteItem(variantTypeInfo)
              ? const Icon(Icons.delete, color: Colors.red, size: 20)
              : const Icon(Icons.lock, color: Colors.grey, size: 20),
          tooltip: Get.find<AdminAuthService>().canDeleteItem(variantTypeInfo)
              ? 'Delete Variant Type'
              : 'No permission',
        ),
      ),
    ],
  );
}

String _formatDate(String? dateString) {
  if (dateString == null) return 'N/A';
  try {
    final date = DateTime.parse(dateString);
    return '${date.day}/${date.month}/${date.year}';
  } catch (e) {
    return dateString;
  }
}

========== FILE: lib/screens/variants_type/provider/variant_type_provider.dart ==========

import 'package:flutter/cupertino.dart';
import 'package:get/get.dart';
import '../../../core/data/data_provider.dart';
import '../../../models/variant_type.dart';
import '../../../services/admin_auth_service.dart';
import '../../../services/http_services.dart';
import 'package:admin_panal_start/models/api_response.dart';
import 'package:admin_panal_start/utility/snack_bar_helper.dart';
import 'package:admin_panal_start/utility/error_utils.dart';

class VariantTypeProvider extends ChangeNotifier {
  HttpService service = HttpService();
  final DataProvider _dataProvider;
  final AdminAuthService _authService = Get.find<AdminAuthService>();

  final addVariantTypeFormKey = GlobalKey<FormState>();
  TextEditingController variantTypeNameCtrl = TextEditingController();
  TextEditingController variantTypeTypeCtrl = TextEditingController();
  VariantType? variantTypeForUpdate;

  VariantTypeProvider(this._dataProvider);

  addVariantType() async {
    try {
      final currentUserId = _authService.getUserId();

      Map<String, dynamic> variantType = {
        'name': variantTypeNameCtrl.text,
        'type': variantTypeTypeCtrl.text,
        'createdBy': currentUserId, // Add createdBy
      };

      final response = await service.addItem(
        endpointUrl: 'variantTypes',
        itemData: variantType,
      );

      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          clearFields();
          SnackBarHelper.showSuccessSnackBar('Variant type added successfully');
          _dataProvider.getAllVariantType();
        } else {
          SnackBarHelper.showOperationErrorSnackBar('add', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar('add', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('add', e);
      rethrow;
    }
  }

  updateVariantType() async {
    try {
      // Check permission
      if (!_authService.canEditItem(variantTypeForUpdate)) {
        SnackBarHelper.showErrorSnackBar(
            'You do not have permission to edit this variant type');
        return;
      }

      Map<String, dynamic> variantType = {
        'name': variantTypeNameCtrl.text,
        'type': variantTypeTypeCtrl.text,
      };

      final response = await service.updateItem(
        endpointUrl: 'variantTypes',
        itemId: variantTypeForUpdate?.sId ?? '',
        itemData: variantType,
      );

      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          clearFields();
          SnackBarHelper.showSuccessSnackBar(
              'Variant type updated successfully');
          _dataProvider.getAllVariantType();
        } else {
          SnackBarHelper.showOperationErrorSnackBar(
              'update', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar(
            'update', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('update', e);
      rethrow;
    }
  }

  submitVariantType() {
    if (variantTypeForUpdate != null) {
      updateVariantType();
    } else {
      addVariantType();
    }
  }

  deleteVariantType(VariantType variantType) async {
    try {
      // Check permission
      if (!_authService.canDeleteItem(variantType)) {
        SnackBarHelper.showErrorSnackBar(
            'You do not have permission to delete this variant type');
        return;
      }

      Response response = await service.deleteItem(
        endpointUrl: 'variantTypes',
        itemId: variantType.sId ?? '',
      );

      if (response.isOk) {
        ApiResponse apiResponse = ApiResponse.fromJson(response.body, null);
        if (apiResponse.success) {
          SnackBarHelper.showSuccessSnackBar(
              "Variant type deleted successfully");
          _dataProvider.getAllVariantType();
        } else {
          SnackBarHelper.showOperationErrorSnackBar(
              'delete', apiResponse.message);
        }
      } else {
        SnackBarHelper.showOperationErrorSnackBar(
            'delete', response.statusText);
      }
    } catch (e) {
      SnackBarHelper.showOperationErrorSnackBar('delete', e);
      rethrow;
    }
  }

  setDataForUpdateVariantType(VariantType? variantType) {
    if (variantType != null) {
      variantTypeForUpdate = variantType;
      variantTypeNameCtrl.text = variantType.name ?? '';
      variantTypeTypeCtrl.text = variantType.type ?? '';
    } else {
      clearFields();
    }
  }

  clearFields() {
    variantTypeNameCtrl.clear();
    variantTypeTypeCtrl.clear();
    variantTypeForUpdate = null;
  }

  updateUI() {
    notifyListeners();
  }
}

========== FILE: lib/screens/variants_type/variants_type_screen.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import '../../utility/constants.dart';
import 'components/add_variant_type_form.dart';
import 'components/variant_type_header.dart';
import 'components/variant_type_list_section.dart';

class VariantsTypeScreen extends StatefulWidget {
  @override
  State<VariantsTypeScreen> createState() => _VariantsTypeScreenState();
}

class _VariantsTypeScreenState extends State<VariantsTypeScreen> {
  @override
  void initState() {
    super.initState();
    // Auto-load variant types when screen is created
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.dataProvider.getAllVariantType();
    });
  }

  @override
  Widget build(BuildContext context) {
    return SafeArea(
      child: SingleChildScrollView(
        primary: false,
        padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
        child: Column(
          children: [
            VariantTypeHeader(),
            Gap(defaultPadding),
            Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Expanded(
                  flex: 5,
                  child: Column(
                    children: [
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Expanded(
                            child: Text(
                              "My Variant Types",
                              style: Theme.of(context).textTheme.titleMedium,
                            ),
                          ),
                          ElevatedButton.icon(
                            style: TextButton.styleFrom(
                              padding: EdgeInsets.symmetric(
                                horizontal: ResponsiveUtils.isMobile(context)
                                    ? defaultPadding
                                    : defaultPadding * 1.5,
                                vertical: ResponsiveUtils.isMobile(context)
                                    ? defaultPadding / 2
                                    : defaultPadding,
                              ),
                            ),
                            onPressed: () {
                              showAddVariantsTypeForm(context, null);
                            },
                            icon: Icon(Icons.add),
                            label: Text("Add New"),
                          ),
                          Gap(ResponsiveUtils.isMobile(context) ? 8 : 20),
                          IconButton(
                            onPressed: () {
                              context.dataProvider
                                  .getAllVariantType(showSnack: true);
                            },
                            icon: Icon(Icons.refresh),
                          ),
                        ],
                      ),
                      const Gap(defaultPadding),
                      const VariantTypeListSection(),
                    ],
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}

========== FILE: lib/screens/variants/variants_screen.dart ==========

import 'package:admin_panal_start/utility/extensions.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:flutter/material.dart';
import 'package:gap/gap.dart';
import '../../utility/constants.dart';
import 'components/add_variant_form.dart';
import 'components/variant_header.dart';
import 'components/variants_list_section.dart';

class VariantsScreen extends StatefulWidget {
  @override
  State<VariantsScreen> createState() => _VariantsScreenState();
}

class _VariantsScreenState extends State<VariantsScreen> {
  @override
  void initState() {
    super.initState();
    // Auto-load variants when screen is created
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.dataProvider.getAllVariant();
    });
  }

  @override
  Widget build(BuildContext context) {
    return SafeArea(
      child: SingleChildScrollView(
        primary: false,
        padding: EdgeInsets.all(ResponsiveUtils.getPadding(context)),
        child: Column(
          children: [
            VariantHeader(),
            Gap(defaultPadding),
            Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Expanded(
                  flex: 5,
                  child: Column(
                    children: [
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Expanded(
                            child: Text(
                              "My Variants",
                              style: Theme.of(context).textTheme.titleMedium,
                            ),
                          ),
                          ElevatedButton.icon(
                            style: TextButton.styleFrom(
                              padding: EdgeInsets.symmetric(
                                horizontal: ResponsiveUtils.isMobile(context)
                                    ? defaultPadding
                                    : defaultPadding * 1.5,
                                vertical: ResponsiveUtils.isMobile(context)
                                    ? defaultPadding / 2
                                    : defaultPadding,
                              ),
                            ),
                            onPressed: () {
                              showAddVariantForm(context, null);
                            },
                            icon: Icon(Icons.add),
                            label: Text("Add New"),
                          ),
                          Gap(ResponsiveUtils.isMobile(context) ? 8 : 20),
                          IconButton(
                            onPressed: () {
                              context.dataProvider
                                  .getAllVariant(showSnack: true);
                            },
                            icon: Icon(Icons.refresh),
                          ),
                        ],
                      ),
                      Gap(defaultPadding),
                      VariantListSection(),
                    ],
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}

========== FILE: lib/services/admin_auth_service.dart ==========

import 'dart:convert';
import 'package:flutter/foundation.dart';
import 'package:get/get.dart';
import 'package:get_storage/get_storage.dart';
import '../models/admin_user.dart';
import '../models/api_response.dart';
import 'http_services.dart';

class AdminAuthService extends GetxService {
  final HttpService _httpService = Get.find<HttpService>();
  final GetStorage _storage = GetStorage();

  final RxBool isLoggedIn = false.obs;
  final Rxn<AdminUser> currentUser = Rxn<AdminUser>();
  final RxString authToken = ''.obs;
  final RxList<AdminUser> adminUsers = <AdminUser>[].obs;

  @override
  void onInit() {
    super.onInit();
    _loadAuthState();
  }

  void _loadAuthState() {
    final token = _storage.read('auth_token');
    final userData = _storage.read('user_data');

    if (token != null && userData != null) {
      authToken.value = token;
      try {
        currentUser.value = AdminUser.fromJson(userData);
        isLoggedIn.value = true;
      } catch (e) {
        if (kDebugMode) {
          print('Error loading user data: $e');
        }
        _clearAuthData();
      }
    }
  }

  Future<ApiResponse<AdminUser>> login(String username, String password) async {
    try {
      print('üîê Attempting admin login with:');
      print('   Username: $username');
      print('   Password: ${'*' * password.length}');

      final response = await _httpService.addItem(
        endpointUrl: 'admin-users/login',
        itemData: {
          'username': username.trim(),
          'password': password,
        },
      );

      print('üì• Login response status: ${response.statusCode}');
      print('üì• Login response body: ${response.body}');

      if (response.isOk) {
        final responseBody = response.body;

        if (responseBody is! Map<String, dynamic>) {
          return ApiResponse(
            success: false,
            message: 'Invalid server response format',
            data: null,
          );
        }

        final apiResponse = ApiResponse<AdminUser>.fromJson(
          responseBody,
          (json) => AdminUser.fromJson(json as Map<String, dynamic>),
        );

        if (apiResponse.success && apiResponse.data != null) {
          // Store auth data
          await _storage.write('auth_token', apiResponse.data?.sId);
          await _storage.write('user_data', apiResponse.data?.toJson());

          // Update state
          authToken.value = apiResponse.data?.sId ?? '';
          currentUser.value = apiResponse.data;
          isLoggedIn.value = true;

          return ApiResponse(
            success: true,
            message: 'Login successful',
            data: apiResponse.data,
          );
        } else {
          return ApiResponse(
            success: false,
            message: apiResponse.message,
            data: null,
          );
        }
      } else {
        final errorMessage = response.body?['message'] ?? 'Login failed';
        return ApiResponse(
          success: false,
          message: errorMessage,
          data: null,
        );
      }
    } catch (e) {
      print('‚ùå Login error: $e');
      return ApiResponse(
        success: false,
        message: 'Connection failed. Please check your internet.',
        data: null,
      );
    }
  }

  Future<void> logout() async {
    _clearAuthData();
    Get.offAllNamed('/login');
  }

  void _clearAuthData() {
    _storage.remove('auth_token');
    _storage.remove('user_data');
    authToken.value = '';
    currentUser.value = null;
    isLoggedIn.value = false;
    adminUsers.clear();
  }

  Future<ApiResponse<List<AdminUser>>> getAdminUsers() async {
    try {
      final response = await _httpService.getItems(
        endpointUrl: 'admin-users',
      );

      if (response.isOk) {
        final responseBody = response.body;

        if (responseBody is! Map<String, dynamic>) {
          return ApiResponse(
            success: false,
            message: 'Invalid server response',
            data: null,
          );
        }

        final apiResponse = ApiResponse<List<AdminUser>>.fromJson(
          responseBody,
          (json) => (json as List)
              .map((item) => AdminUser.fromJson(item as Map<String, dynamic>))
              .toList(),
        );

        if (apiResponse.success && apiResponse.data != null) {
          adminUsers.value = apiResponse.data!;
          return ApiResponse(
            success: true,
            message: 'Users loaded successfully',
            data: adminUsers,
          );
        } else {
          return ApiResponse(
            success: false,
            message: apiResponse.message,
            data: null,
          );
        }
      } else {
        final errorMessage =
            response.body?['message'] ?? 'Failed to load users';
        return ApiResponse(
          success: false,
          message: errorMessage,
          data: null,
        );
      }
    } catch (e) {
      return ApiResponse(
        success: false,
        message: 'Failed to load users: $e',
        data: null,
      );
    }
  }

  Future<ApiResponse<AdminUser>> createAdminUser(
      Map<String, dynamic> userData) async {
    try {
      final response = await _httpService.addItem(
        endpointUrl: 'admin-users',
        itemData: userData,
      );

      if (response.isOk) {
        final responseBody = response.body;

        if (responseBody is! Map<String, dynamic>) {
          return ApiResponse(
            success: false,
            message: 'Invalid server response',
            data: null,
          );
        }

        final apiResponse = ApiResponse<AdminUser>.fromJson(
          responseBody,
          (json) => AdminUser.fromJson(json as Map<String, dynamic>),
        );

        if (apiResponse.success && apiResponse.data != null) {
          await getAdminUsers();
          return ApiResponse(
            success: true,
            message: 'User created successfully',
            data: apiResponse.data,
          );
        } else {
          return ApiResponse(
            success: false,
            message: apiResponse.message,
            data: null,
          );
        }
      } else {
        final errorMessage =
            response.body?['message'] ?? 'Failed to create user';
        return ApiResponse(
          success: false,
          message: errorMessage,
          data: null,
        );
      }
    } catch (e) {
      if (kDebugMode) {
        print('Create admin user error: $e');
      }
      return ApiResponse(
        success: false,
        message: 'Failed to create user: $e',
        data: null,
      );
    }
  }

  Future<ApiResponse<AdminUser>> updateAdminUser(
      String userId, Map<String, dynamic> userData) async {
    try {
      final response = await _httpService.updateItem(
        endpointUrl: 'admin-users',
        itemId: userId,
        itemData: userData,
      );

      if (response.isOk) {
        final responseBody = response.body;

        if (responseBody is! Map<String, dynamic>) {
          return ApiResponse(
            success: false,
            message: 'Invalid server response',
            data: null,
          );
        }

        final apiResponse = ApiResponse<AdminUser>.fromJson(
          responseBody,
          (json) => AdminUser.fromJson(json as Map<String, dynamic>),
        );

        if (apiResponse.success && apiResponse.data != null) {
          await getAdminUsers();
          return ApiResponse(
            success: true,
            message: 'User updated successfully',
            data: apiResponse.data,
          );
        } else {
          return ApiResponse(
            success: false,
            message: apiResponse.message,
            data: null,
          );
        }
      } else {
        final errorMessage =
            response.body?['message'] ?? 'Failed to update user';
        return ApiResponse(
          success: false,
          message: errorMessage,
          data: null,
        );
      }
    } catch (e) {
      if (kDebugMode) {
        print('Update admin user error: $e');
      }
      return ApiResponse(
        success: false,
        message: 'Failed to update user: $e',
        data: null,
      );
    }
  }

  Future<ApiResponse<void>> deleteAdminUser(String userId) async {
    try {
      final response = await _httpService.deleteItem(
        endpointUrl: 'admin-users',
        itemId: userId,
      );

      if (response.isOk) {
        final responseBody = response.body;

        if (responseBody is! Map<String, dynamic>) {
          return ApiResponse(
            success: false,
            message: 'Invalid server response',
            data: null,
          );
        }

        final apiResponse = ApiResponse.fromJson(responseBody, null);

        if (apiResponse.success) {
          await getAdminUsers();
          return ApiResponse(
            success: true,
            message: 'User deleted successfully',
            data: null,
          );
        } else {
          return ApiResponse(
            success: false,
            message: apiResponse.message,
            data: null,
          );
        }
      } else {
        final errorMessage =
            response.body?['message'] ?? 'Failed to delete user';
        return ApiResponse(
          success: false,
          message: errorMessage,
          data: null,
        );
      }
    } catch (e) {
      if (kDebugMode) {
        print('Delete admin user error: $e');
      }
      return ApiResponse(
        success: false,
        message: 'Failed to delete user: $e',
        data: null,
      );
    }
  }

  // Permission methods
  bool canManageUsers() {
    return currentUser.value?.isSuperAdmin ?? false;
  }

  bool canManageAllContent() {
    return currentUser.value?.isSuperAdmin ?? false;
  }

  bool canEditItem(dynamic item) {
    if (currentUser.value?.isSuperAdmin ?? false) {
      return true;
    }

    final currentUserId = currentUser.value?.sId;
    final itemCreatedBy = _getItemCreatedBy(item);
    return itemCreatedBy == currentUserId;
  }

  bool canDeleteItem(dynamic item) {
    return canEditItem(item);
  }

  String? _getItemCreatedBy(dynamic item) {
    if (item == null) return null;

    if (item is Map<String, dynamic>) {
      return item['createdBy']?.toString();
    }

    try {
      // For model objects with createdBy property
      if (item is AdminUser) return item.sId;
      // Add other model types as they get createdBy field
    } catch (e) {
      return null;
    }

    return null;
  }

  // Getters for UI
  AdminUser? get currentAdmin => currentUser.value;
  List<AdminUser> get allAdminUsers => adminUsers;
  String? getUserId() => currentUser.value?.sId;
  String? getUserName() => currentUser.value?.name;
  String? getUserEmail() => currentUser.value?.email;

  bool hasPermission(String requiredLevel) {
    final userLevel = currentUser.value?.clearanceLevel;
    switch (requiredLevel) {
      case 'super_admin':
        return userLevel == 'super_admin';
      case 'admin':
        return userLevel == 'super_admin' || userLevel == 'admin';
      default:
        return false;
    }
  }
}

========== FILE: lib/services/http_services.dart ==========

import 'package:get/get_connect.dart';
import 'package:get/get.dart';
import '../utility/constants.dart';

class HttpService extends GetConnect {
  final String baseUrl = MAIN_URL;

  @override
  void onInit() {
    httpClient.baseUrl = baseUrl;
    httpClient.timeout = const Duration(seconds: 30);
    super.onInit();
  }

  Future<Response> getItems({required String endpointUrl}) async {
    try {
      final response = await get('/$endpointUrl');

      if (response.statusCode == null) {
        return const Response(
          statusCode: 500,
          statusText: 'Connection failed',
          body: {'success': false, 'message': 'Unable to connect to server'},
        );
      }

      return response;
    } catch (e) {
      return Response(
        statusCode: 500,
        statusText: 'Network error',
        body: {'success': false, 'message': 'Network error: $e'},
      );
    }
  }

  Future<Response> addItem(
      {required String endpointUrl, required dynamic itemData}) async {
    try {
      final response = await post('/$endpointUrl', itemData);

      if (response.statusCode == null) {
        return const Response(
          statusCode: 500,
          statusText: 'Connection failed',
          body: {'success': false, 'message': 'Unable to connect to server'},
        );
      }

      return response;
    } catch (e) {
      return Response(
        statusCode: 500,
        statusText: 'Network error',
        body: {'success': false, 'message': 'Network error: $e'},
      );
    }
  }

  Future<Response> postItem(
      {required String endpointUrl, required dynamic itemData}) async {
    return await addItem(endpointUrl: endpointUrl, itemData: itemData);
  }

  Future<Response> updateItem(
      {required String endpointUrl,
      required String itemId,
      required dynamic itemData}) async {
    try {
      final response = await put('/$endpointUrl/$itemId', itemData);

      if (response.statusCode == null) {
        return const Response(
          statusCode: 500,
          statusText: 'Connection failed',
          body: {'success': false, 'message': 'Unable to connect to server'},
        );
      }

      return response;
    } catch (e) {
      return Response(
        statusCode: 500,
        statusText: 'Network error',
        body: {'success': false, 'message': 'Network error: $e'},
      );
    }
  }

  Future<Response> deleteItem(
      {required String endpointUrl, required String itemId}) async {
    try {
      final response = await delete('/$endpointUrl/$itemId');

      if (response.statusCode == null) {
        return const Response(
          statusCode: 500,
          statusText: 'Connection failed',
          body: {'success': false, 'message': 'Unable to connect to server'},
        );
      }

      return response;
    } catch (e) {
      return Response(
        statusCode: 500,
        statusText: 'Network error',
        body: {'success': false, 'message': 'Network error: $e'},
      );
    }
  }
}

========== FILE: lib/utility/color_list.dart ==========

import 'package:flutter/material.dart';

final List<MaterialColor> colors = [
  Colors.red,
  Colors.blue,
  Colors.green,
  Colors.orange,
  Colors.purple,
  Colors.teal,
  Colors.indigo,
  Colors.amber,
  Colors.deepOrange,
  Colors.lime
];
========== FILE: lib/utility/constants.dart ==========

import 'package:flutter/material.dart';
import 'package:flutter/foundation.dart';

const primaryColor = Color(0xFF2697FF);
const secondaryColor = Color(0xFF2A2D3E);
const bgColor = Color(0xFF212332);
const defaultPadding = 16.0;

// Dynamic URL that works on all platforms
String getBaseUrl() {
  return 'https://yonasmarketplace-backend.onrender.com';
}

const MAIN_URL = 'https://yonasmarketplace-backend.onrender.com';

// Admin login credentials (already in your database)
// Username: superadmin
// Password: admin123

========== FILE: lib/utility/debug_utils.dart ==========

import 'package:flutter/foundation.dart';

class DebugUtils {
  static void log(String message) {
    if (kDebugMode) {
      print('[APP] $message');
    }
  }

  static void error(String location, dynamic error) {
    if (kDebugMode) {
      print('[ERROR] $location: $error');
    }
  }

  static void info(String message) {
    if (kDebugMode) {
      print('[INFO] $message');
    }
  }

  static void http(String method, String endpoint, int statusCode) {
    if (kDebugMode) {
      print('[HTTP] $method $endpoint - Status: $statusCode');
    }
  }
}

========== FILE: lib/utility/error_utils.dart ==========

class ErrorUtils {
  static String getHumanReadableError(dynamic error) {
    final errorString = error.toString().toLowerCase();

    if (errorString.contains('socketexception') ||
        errorString.contains('connection failed') ||
        errorString.contains('network is unreachable')) {
      return 'Network connection failed. Please check your internet connection.';
    }

    if (errorString.contains('timeout') || errorString.contains('timed out')) {
      return 'Server is taking too long to respond. Please try again.';
    }

    if (errorString.contains('401') || errorString.contains('unauthorized')) {
      return 'Session expired. Please log in again.';
    }

    if (errorString.contains('404') || errorString.contains('not found')) {
      return 'Requested resource not found.';
    }

    if (errorString.contains('500') ||
        errorString.contains('internal server error')) {
      return 'Server error. Please try again later.';
    }

    if (errorString.contains('format') ||
        errorString.contains('json') ||
        errorString.contains('parsing')) {
      return 'Invalid response from server. Please try again.';
    }

    return 'Something went wrong. Please try again.';
  }

  static String getOperationErrorMessage(String operation) {
    switch (operation.toLowerCase()) {
      case 'add':
      case 'create':
        return 'Failed to create item. Please try again.';
      case 'update':
      case 'edit':
        return 'Failed to update item. Please try again.';
      case 'delete':
      case 'remove':
        return 'Failed to delete item. Please try again.';
      case 'fetch':
      case 'load':
      case 'get':
        return 'Failed to load data. Please try again.';
      default:
        return 'Operation failed. Please try again.';
    }
  }
}

========== FILE: lib/utility/extensions.dart ==========

import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../core/data/data_provider.dart';
import '../screens/main/provider/main_screen_provider.dart';
import '../screens/category/provider/category_provider.dart';
import '../screens/sub_category/provider/sub_category_provider.dart';
import '../screens/brands/provider/brand_provider.dart';
import '../screens/variants_type/provider/variant_type_provider.dart';
import '../screens/variants/provider/variant_provider.dart';
import '../screens/dashboard/provider/dash_board_provider.dart';
import '../screens/coupon_code/provider/coupon_code_provider.dart';
import '../screens/posters/provider/poster_provider.dart';
import '../screens/order/provider/order_provider.dart';
import '../screens/ratings/provider/rating_provider.dart';
import '../screens/notification/provider/notification_provider.dart';
import '../services/admin_auth_service.dart';

extension ContextExtensions on BuildContext {
  DataProvider get dataProvider =>
      Provider.of<DataProvider>(this, listen: false);

  MainScreenProvider get mainScreenProvider =>
      Provider.of<MainScreenProvider>(this, listen: false);

  CategoryProvider get categoryProvider =>
      Provider.of<CategoryProvider>(this, listen: false);

  SubCategoryProvider get subCategoryProvider =>
      Provider.of<SubCategoryProvider>(this, listen: false);

  BrandProvider get brandProvider =>
      Provider.of<BrandProvider>(this, listen: false);

  VariantTypeProvider get variantTypeProvider =>
      Provider.of<VariantTypeProvider>(this, listen: false);

  VariantProvider get variantProvider =>
      Provider.of<VariantProvider>(this, listen: false);

  DashBoardProvider get dashBoardProvider =>
      Provider.of<DashBoardProvider>(this, listen: false);

  CouponCodeProvider get couponCodeProvider =>
      Provider.of<CouponCodeProvider>(this, listen: false);

  PosterProvider get posterProvider =>
      Provider.of<PosterProvider>(this, listen: false);

  OrderProvider get orderProvider =>
      Provider.of<OrderProvider>(this, listen: false);

  RatingProvider get ratingProvider =>
      Provider.of<RatingProvider>(this, listen: false);

  NotificationProvider get notificationProvider =>
      Provider.of<NotificationProvider>(this, listen: false);
}

========== FILE: lib/utility/responsive.dart ==========

import 'package:flutter/material.dart';

class Responsive extends StatelessWidget {
  final Widget mobile;
  final Widget? tablet;
  final Widget desktop;

  const Responsive({
    Key? key,
    required this.mobile,
    this.tablet,
    required this.desktop,
  }) : super(key: key);

// This size work fine on my design, maybe you need some customization depends on your design

  // This isMobile, isTablet, isDesktop help us later
  static bool isMobile(BuildContext context) =>
      MediaQuery.of(context).size.width < 850;

  static bool isTablet(BuildContext context) =>
      MediaQuery.of(context).size.width < 1100 &&
      MediaQuery.of(context).size.width >= 850;

  static bool isDesktop(BuildContext context) =>
      MediaQuery.of(context).size.width >= 1100;

  @override
  Widget build(BuildContext context) {
    final Size _size = MediaQuery.of(context).size;
    // If our width is more than 1100 then we consider it a desktop
    if (_size.width >= 1100) {
      return desktop;
    }
    // If width it less then 1100 and more then 850 we consider it as tablet
    else if (_size.width >= 850 && tablet != null) {
      return tablet!;
    }
    // Or less then that we called it mobile
    else {
      return mobile;
    }
  }
}

========== FILE: lib/utility/responsive_utils.dart ==========

// lib/utility/responsive_utils.dart
import 'package:flutter/material.dart';

class ResponsiveUtils {
  static const double mobileBreakpoint = 600;
  static const double tabletBreakpoint = 900;
  static const double desktopBreakpoint = 1200;

  static bool isMobile(BuildContext context) =>
      MediaQuery.of(context).size.width < mobileBreakpoint;

  static bool isTablet(BuildContext context) =>
      MediaQuery.of(context).size.width >= mobileBreakpoint &&
      MediaQuery.of(context).size.width < desktopBreakpoint;

  static bool isDesktop(BuildContext context) =>
      MediaQuery.of(context).size.width >= desktopBreakpoint;

  static double dialogWidth(BuildContext context) {
    final size = MediaQuery.of(context).size;
    return isMobile(context)
        ? size.width * 0.95
        : isTablet(context)
            ? size.width * 0.8
            : 600;
  }

  static double getPadding(BuildContext context) {
    return isMobile(context) ? 8.0 : 16.0;
  }

  static int getGridCrossAxisCount(BuildContext context) {
    if (isMobile(context)) return 2;
    if (isTablet(context)) return 3;
    return 4;
  }
}

========== FILE: lib/utility/snack_bar_helper.dart ==========

import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'error_utils.dart';

class SnackBarHelper {
  static void showSuccessSnackBar(String message) {
    Get.snackbar(
      'Success',
      message,
      backgroundColor: Colors.green,
      colorText: Colors.white,
      snackPosition: SnackPosition.BOTTOM,
      duration: Duration(seconds: 3),
    );
  }

  static void showErrorSnackBar(String message, [dynamic error]) {
    final userMessage =
        error != null ? ErrorUtils.getHumanReadableError(error) : message;

    Get.snackbar(
      'Error',
      userMessage,
      backgroundColor: Colors.red,
      colorText: Colors.white,
      snackPosition: SnackPosition.BOTTOM,
      duration: Duration(seconds: 4),
    );
  }

  static void showOperationErrorSnackBar(String operation, dynamic error) {
    final userMessage = ErrorUtils.getOperationErrorMessage(operation);

    Get.snackbar(
      'Error',
      userMessage,
      backgroundColor: Colors.red,
      colorText: Colors.white,
      snackPosition: SnackPosition.BOTTOM,
      duration: Duration(seconds: 4),
    );
  }

  static void showInfoSnackBar(String message) {
    Get.snackbar(
      'Info',
      message,
      backgroundColor: Colors.blue,
      colorText: Colors.white,
      snackPosition: SnackPosition.BOTTOM,
      duration: Duration(seconds: 3),
    );
  }

  static void showWarningSnackBar(String message) {
    Get.snackbar(
      'Warning',
      message,
      backgroundColor: Colors.orange,
      colorText: Colors.white,
      snackPosition: SnackPosition.BOTTOM,
      duration: Duration(seconds: 4),
    );
  }
}

========== FILE: lib/widgets/camera_picker_dialog.dart ==========

// lib/widgets/camera_picker_dialog.dart
import 'package:flutter/material.dart';
import 'package:image_picker/image_picker.dart';

class CameraPickerDialog extends StatelessWidget {
  final Function(XFile?) onImageSelected;

  const CameraPickerDialog({
    Key? key,
    required this.onImageSelected,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      backgroundColor: Colors.white,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
      ),
      title: Text(
        'Select Image Source',
        style: TextStyle(
          fontSize: 18,
          fontWeight: FontWeight.bold,
          color: Colors.black87,
        ),
        textAlign: TextAlign.center,
      ),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          _buildOptionButton(
            context,
            icon: Icons.camera_alt,
            title: 'Camera',
            onTap: () => _pickImage(ImageSource.camera, context),
          ),
          SizedBox(height: 12),
          _buildOptionButton(
            context,
            icon: Icons.photo_library,
            title: 'Gallery',
            onTap: () => _pickImage(ImageSource.gallery, context),
          ),
        ],
      ),
    );
  }

  Widget _buildOptionButton(
    BuildContext context, {
    required IconData icon,
    required String title,
    required VoidCallback onTap,
  }) {
    return Material(
      borderRadius: BorderRadius.circular(12),
      color: Colors.blue[50],
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(12),
        child: Container(
          padding: EdgeInsets.all(16),
          width: double.infinity,
          child: Row(
            children: [
              Icon(icon, color: Colors.blue[600], size: 24),
              SizedBox(width: 16),
              Text(
                title,
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w500,
                  color: Colors.blue[800],
                ),
              ),
              Spacer(),
              Icon(Icons.chevron_right, color: Colors.blue[400]),
            ],
          ),
        ),
      ),
    );
  }

  void _pickImage(ImageSource source, BuildContext context) async {
    final ImagePicker picker = ImagePicker();
    try {
      final XFile? image = await picker.pickImage(source: source);
      Navigator.of(context).pop();
      onImageSelected(image);
    } catch (e) {
      Navigator.of(context).pop();
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Failed to pick image: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }
}

// Usage function
void showCameraPickerDialog(
    BuildContext context, Function(XFile?) onImageSelected) {
  showDialog(
    context: context,
    builder: (BuildContext context) {
      return CameraPickerDialog(onImageSelected: onImageSelected);
    },
  );
}

========== FILE: lib/widgets/category_image_card.dart ==========

import 'dart:io';
import 'package:flutter/material.dart';
import 'package:cached_network_image/cached_network_image.dart';
import '../utility/constants.dart';

class CategoryImageCard extends StatelessWidget {
  final String labelText;
  final File? imageFile;
  final String? imageUrlForUpdateImage;
  final VoidCallback onTap;
  final VoidCallback onRemoveImage;

  const CategoryImageCard({
    Key? key,
    required this.labelText,
    required this.imageFile,
    this.imageUrlForUpdateImage,
    required this.onTap,
    required this.onRemoveImage,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final hasImage = imageFile != null ||
        (imageUrlForUpdateImage != null &&
            imageUrlForUpdateImage!.isNotEmpty &&
            imageUrlForUpdateImage != 'no_url');

    return Column(
      children: [
        GestureDetector(
          onTap: onTap,
          child: Container(
            width: double.infinity,
            height: 120,
            decoration: BoxDecoration(
              color: secondaryColor,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(
                color: hasImage ? primaryColor : Colors.grey.shade600,
                width: 2,
              ),
            ),
            child: Stack(
              children: [
                // Image content
                if (hasImage) _buildImageContent() else _buildPlaceholder(),

                // Camera icon positioned properly
                if (!hasImage)
                  Positioned(
                    top: 30,
                    left: 0,
                    right: 0,
                    child: Column(
                      children: [
                        Icon(
                          Icons.camera_alt,
                          color: Colors.white70,
                          size: 32,
                        ),
                        SizedBox(height: 8),
                        Text(
                          'Add Image',
                          style: TextStyle(
                            color: Colors.white70,
                            fontSize: 12,
                          ),
                        ),
                      ],
                    ),
                  ),
              ],
            ),
          ),
        ),

        // Label text
        SizedBox(height: 8),
        Text(
          labelText,
          style: TextStyle(
            color: Colors.white,
            fontSize: 14,
            fontWeight: FontWeight.w500,
          ),
        ),

        // Remove button if image exists
        if (hasImage) ...[
          SizedBox(height: 8),
          ElevatedButton.icon(
            onPressed: onRemoveImage,
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.red.shade800,
              foregroundColor: Colors.white,
              padding: EdgeInsets.symmetric(horizontal: 12, vertical: 6),
              minimumSize: Size(0, 0),
            ),
            icon: Icon(Icons.delete, size: 16),
            label: Text('Remove'),
          ),
        ],
      ],
    );
  }

  Widget _buildImageContent() {
    if (imageFile != null) {
      return ClipRRect(
        borderRadius: BorderRadius.circular(10),
        child: Image.file(
          imageFile!,
          fit: BoxFit.cover,
          width: double.infinity,
          height: double.infinity,
        ),
      );
    } else if (imageUrlForUpdateImage != null &&
        imageUrlForUpdateImage!.isNotEmpty &&
        imageUrlForUpdateImage != 'no_url') {
      return ClipRRect(
        borderRadius: BorderRadius.circular(10),
        child: CachedNetworkImage(
          imageUrl: imageUrlForUpdateImage!,
          fit: BoxFit.cover,
          width: double.infinity,
          height: double.infinity,
          placeholder: (context, url) => Center(
            child: CircularProgressIndicator(
              strokeWidth: 2,
              valueColor: AlwaysStoppedAnimation<Color>(primaryColor),
            ),
          ),
          errorWidget: (context, url, error) => _buildPlaceholder(),
        ),
      );
    }

    return _buildPlaceholder();
  }

  Widget _buildPlaceholder() {
    return Container(
      decoration: BoxDecoration(
        color: Colors.grey[800]!.withOpacity(0.5),
        borderRadius: BorderRadius.circular(10),
      ),
      child: SizedBox(), // Empty container, camera icon is positioned above
    );
  }
}

========== FILE: lib/widgets/compact_form_dialog.dart ==========

import 'package:flutter/material.dart';
import '../utility/responsive_utils.dart';

class CompactFormDialog extends StatelessWidget {
  final String title;
  final Widget child;
  final double? maxWidth;

  const CompactFormDialog({
    Key? key,
    required this.title,
    required this.child,
    this.maxWidth,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final isMobile = ResponsiveUtils.isMobile(context);

    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: EdgeInsets.all(isMobile ? 16 : 24),
      child: ConstrainedBox(
        constraints: BoxConstraints(
          maxWidth: maxWidth ?? (isMobile ? double.infinity : 600),
          maxHeight:
              MediaQuery.of(context).size.height * 0.95, // Increased max height
        ),
        child: Container(
          decoration: BoxDecoration(
            color: Color(0xFF2A2D3E),
            borderRadius: BorderRadius.circular(12),
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Compact header
              Container(
                padding: EdgeInsets.symmetric(
                  horizontal: 16,
                  vertical: 12, // Reduced vertical padding
                ),
                decoration: BoxDecoration(
                  color: Color(0xFF212332),
                  borderRadius: BorderRadius.only(
                    topLeft: Radius.circular(12),
                    topRight: Radius.circular(12),
                  ),
                ),
                child: Row(
                  children: [
                    Expanded(
                      child: Text(
                        title,
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 16,
                          fontWeight: FontWeight.w600,
                        ),
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ),
                    IconButton(
                      icon: Icon(Icons.close, color: Colors.white70, size: 20),
                      onPressed: () => Navigator.of(context).pop(),
                      padding: EdgeInsets.zero,
                      constraints: BoxConstraints(minWidth: 32, minHeight: 32),
                    ),
                  ],
                ),
              ),

              // Form content with flexible space
              Expanded(
                child: child,
              ),
            ],
          ),
        ),
      ),
    );
  }
}

========== FILE: lib/widgets/custom_date_picker.dart ==========

// lib/widgets/custom_date_picker.dart
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import '../utility/constants.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';

class CustomDatePicker extends StatefulWidget {
  final String labelText;
  final TextEditingController controller;
  final DateTime initialDate;
  final DateTime firstDate;
  final DateTime lastDate;
  final void Function(DateTime) onDateSelected;

  const CustomDatePicker({
    Key? key,
    required this.labelText,
    required this.controller,
    required this.initialDate,
    required this.firstDate,
    required this.lastDate,
    required this.onDateSelected,
  }) : super(key: key);

  @override
  State<CustomDatePicker> createState() => _CustomDatePickerState();
}

class _CustomDatePickerState extends State<CustomDatePicker> {
  void _selectDate(BuildContext context) async {
    final DateTime? picked = await showDatePicker(
      context: context,
      initialDate: widget.initialDate,
      firstDate: widget.firstDate,
      lastDate: widget.lastDate,
      builder: (BuildContext context, Widget? child) {
        return Theme(
          data: ThemeData.light().copyWith(
            colorScheme: ColorScheme.light(
              primary: primaryColor,
              onPrimary: Colors.white,
              onSurface: Colors.black,
            ),
            dialogBackgroundColor: Colors.white,
            textButtonTheme: TextButtonThemeData(
              style: TextButton.styleFrom(
                foregroundColor: primaryColor,
              ),
            ),
          ),
          child: child!,
        );
      },
    );
    if (picked != null && picked != widget.initialDate) {
      setState(() {
        widget.controller.text = DateFormat('yyyy-MM-dd').format(picked);
        widget.onDateSelected(picked);
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.all(8.0),
      child: TextFormField(
        controller: widget.controller,
        decoration: InputDecoration(
          labelText: widget.labelText,
          labelStyle: TextStyle(
            color: Colors.grey.shade600,
            fontSize: ResponsiveUtils.isMobile(context) ? 14 : 16,
          ),
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12.0),
            borderSide: BorderSide(color: Colors.grey.shade400),
          ),
          enabledBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12.0),
            borderSide: BorderSide(color: Colors.grey.shade400),
          ),
          focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12.0),
            borderSide: BorderSide(color: primaryColor, width: 2),
          ),
          filled: true,
          fillColor: Colors.grey[50],
          contentPadding: EdgeInsets.symmetric(
            horizontal: 16,
            vertical: ResponsiveUtils.isMobile(context) ? 12 : 16,
          ),
          suffixIcon: IconButton(
            icon: Icon(Icons.calendar_today, color: primaryColor),
            onPressed: () => _selectDate(context),
          ),
        ),
        readOnly: true,
        onTap: () => _selectDate(context),
        style: TextStyle(
          fontSize: ResponsiveUtils.isMobile(context) ? 14 : 16,
          color: Colors.black87,
        ),
      ),
    );
  }
}

========== FILE: lib/widgets/custom_dropdown.dart ==========

// lib/widgets/custom_dropdown.dart - Updated
import 'package:flutter/material.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';

class CustomDropdown<T> extends StatelessWidget {
  final T? initialValue;
  final List<T> items;
  final void Function(T?) onChanged;
  final String? Function(T?)? validator;
  final String hintText;
  final String Function(T) displayItem;
  final bool isExpanded;

  const CustomDropdown({
    Key? key,
    this.initialValue,
    required this.items,
    required this.onChanged,
    this.validator,
    this.hintText = 'Select an option',
    required this.displayItem,
    this.isExpanded = true,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.all(8.0),
      child: DropdownButtonFormField<T>(
        isExpanded: isExpanded,
        decoration: InputDecoration(
          labelText: hintText,
          hintText: hintText,
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12.0),
            borderSide: BorderSide(color: Colors.grey.shade600),
          ),
          enabledBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12.0),
            borderSide: BorderSide(color: Colors.grey.shade600),
          ),
          focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12.0),
            borderSide: BorderSide(color: Colors.blue.shade400, width: 2),
          ),
          filled: true,
          fillColor: Colors.transparent,
          contentPadding: EdgeInsets.symmetric(
            horizontal: 16,
            vertical: ResponsiveUtils.isMobile(context) ? 12 : 16,
          ),
        ),
        value: initialValue,
        items: items.map((T value) {
          return DropdownMenuItem<T>(
            value: value,
            child: Text(
              displayItem(value),
              overflow: TextOverflow.ellipsis,
              style: TextStyle(
                fontSize: ResponsiveUtils.isMobile(context) ? 14 : 16,
                color: Colors.white,
              ),
            ),
          );
        }).toList(),
        onChanged: onChanged,
        validator: validator,
        style: TextStyle(
          fontSize: ResponsiveUtils.isMobile(context) ? 14 : 16,
          color: Colors.white,
        ),
        dropdownColor: Color(0xFF2A2D3E),
        icon: Icon(Icons.arrow_drop_down, color: Colors.grey.shade400),
        borderRadius: BorderRadius.circular(12),
        elevation: 4,
      ),
    );
  }
}

========== FILE: lib/widgets/custom_text_field.dart ==========

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import '../utility/constants.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';

// Update your CustomTextField widget to make onSave optional
class CustomTextField extends StatelessWidget {
  final String labelText;
  final TextEditingController controller;
  final TextInputType? inputType;
  final int? lineNumber;
  final void Function(String?)? onSave; // Make this optional
  final String? Function(String?)? validator;
  final bool enabled;
  final bool obscureText;
  final Widget? suffixIcon;
  final Widget? prefixIcon; // Add this if you're using prefixIcon

  const CustomTextField({
    super.key,
    required this.labelText,
    this.onSave, // Now optional
    this.inputType = TextInputType.text,
    this.lineNumber = 1,
    this.validator,
    required this.controller,
    this.enabled = true,
    this.obscureText = false,
    this.suffixIcon,
    this.prefixIcon, // Add this
  });

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.all(8.0),
      child: TextFormField(
        controller: controller,
        maxLines: lineNumber,
        enabled: enabled,
        obscureText: obscureText,
        decoration: InputDecoration(
          labelText: labelText,
          labelStyle: TextStyle(
            color: Colors.grey.shade400,
            fontSize: ResponsiveUtils.isMobile(context) ? 14 : 16,
          ),
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12.0),
            borderSide: BorderSide(color: Colors.grey.shade600),
          ),
          enabledBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12.0),
            borderSide: BorderSide(color: Colors.grey.shade600),
          ),
          focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12.0),
            borderSide: BorderSide(color: primaryColor, width: 2),
          ),
          errorBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12.0),
            borderSide: BorderSide(color: Colors.red.shade400),
          ),
          focusedErrorBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12.0),
            borderSide: BorderSide(color: Colors.red.shade400, width: 2),
          ),
          filled: true,
          fillColor: enabled ? Colors.transparent : Colors.grey.shade800,
          contentPadding: EdgeInsets.symmetric(
            horizontal: 16,
            vertical: ResponsiveUtils.isMobile(context) ? 12 : 16,
          ),
          suffixIcon: suffixIcon,
          prefixIcon: prefixIcon != null
              ? Padding(
                  padding: const EdgeInsets.all(12.0),
                  child: IconTheme(
                    data: IconThemeData(color: Colors.grey.shade400),
                    child: prefixIcon!,
                  ),
                )
              : null,
        ),
        keyboardType: inputType,
        onSaved: onSave, // This can be null now
        validator: validator,
        inputFormatters: [
          LengthLimitingTextInputFormatter(700),
          if (inputType == TextInputType.number)
            FilteringTextInputFormatter.allow(RegExp(r'^-?\d*\.?\d*')),
        ],
        style: TextStyle(
          fontSize: ResponsiveUtils.isMobile(context) ? 14 : 16,
          color: enabled ? Colors.white : Colors.grey.shade400,
        ),
      ),
    );
  }
}

========== FILE: lib/widgets/multi_select_drop_down.dart ==========

// lib/widgets/multi_select_drop_down.dart
import 'package:dropdown_button2/dropdown_button2.dart';
import 'package:flutter/material.dart';
import '../utility/constants.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';

class MultiSelectDropDown<T> extends StatefulWidget {
  final List<T> items;
  final Function(List<T>) onSelectionChanged;
  final String Function(T) displayItem;
  final List<T> selectedItems;
  final String? hintText;

  const MultiSelectDropDown({
    Key? key,
    required this.items,
    required this.onSelectionChanged,
    required this.displayItem,
    required this.selectedItems,
    this.hintText = 'Select items',
  }) : super(key: key);

  @override
  State<MultiSelectDropDown<T>> createState() => _MultiSelectDropDownState<T>();
}

class _MultiSelectDropDownState<T> extends State<MultiSelectDropDown<T>> {
  @override
  Widget build(BuildContext context) {
    final isMobile = ResponsiveUtils.isMobile(context);

    return Padding(
      padding: const EdgeInsets.all(8.0),
      child: DropdownButtonHideUnderline(
        child: DropdownButton2<T>(
          isExpanded: true,
          hint: Text(
            widget.hintText!,
            style: TextStyle(
              fontSize: isMobile ? 14 : 16,
              color: Colors.grey.shade600,
            ),
            overflow: TextOverflow.ellipsis,
          ),
          items: widget.items.map((T item) {
            return DropdownMenuItem<T>(
              value: item,
              child: StatefulBuilder(
                builder: (context, menuSetState) {
                  final isSelected = widget.selectedItems.contains(item);
                  return Row(
                    children: [
                      Container(
                        width: 18,
                        height: 18,
                        decoration: BoxDecoration(
                          color: isSelected ? primaryColor : Colors.transparent,
                          border: Border.all(
                            color: isSelected
                                ? primaryColor
                                : Colors.grey.shade400,
                            width: 2,
                          ),
                          borderRadius: BorderRadius.circular(4),
                        ),
                        child: isSelected
                            ? Icon(Icons.check, size: 14, color: Colors.white)
                            : null,
                      ),
                      SizedBox(width: 12),
                      Expanded(
                        child: Text(
                          widget.displayItem(item),
                          style: TextStyle(
                            fontSize: isMobile ? 14 : 16,
                            color: Colors.black87,
                          ),
                          overflow: TextOverflow.ellipsis,
                        ),
                      ),
                    ],
                  );
                },
              ),
            );
          }).toList(),
          value: null, // Always null to show hint
          onChanged: (T? value) {
            if (value != null) {
              setState(() {
                if (widget.selectedItems.contains(value)) {
                  widget.selectedItems.remove(value);
                } else {
                  widget.selectedItems.add(value);
                }
              });
              widget.onSelectionChanged(widget.selectedItems);
            }
          },
          buttonStyleData: ButtonStyleData(
            height: isMobile ? 44 : 52,
            padding: const EdgeInsets.only(left: 16, right: 8),
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.grey.shade400),
              color: Colors.grey[50],
            ),
            elevation: 0,
          ),
          iconStyleData: IconStyleData(
            icon: Icon(Icons.arrow_drop_down, color: Colors.grey.shade600),
            iconSize: 24,
          ),
          dropdownStyleData: DropdownStyleData(
            maxHeight: 200,
            width: isMobile ? MediaQuery.of(context).size.width * 0.8 : null,
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(12),
              color: Colors.white,
              boxShadow: [
                BoxShadow(
                  color: Colors.black26,
                  blurRadius: 8,
                  offset: Offset(0, 4),
                ),
              ],
            ),
            offset: Offset(0, -8),
          ),
          menuItemStyleData: MenuItemStyleData(
            height: 48,
            padding: EdgeInsets.symmetric(horizontal: 16),
          ),
          dropdownSearchData: widget.items.length > 5
              ? DropdownSearchData(
                  searchController: TextEditingController(),
                  searchInnerWidgetHeight: 50,
                  searchInnerWidget: Container(
                    height: 50,
                    padding: const EdgeInsets.only(
                      top: 8,
                      bottom: 4,
                      right: 8,
                      left: 8,
                    ),
                    child: TextFormField(
                      expands: true,
                      maxLines: null,
                      controller: TextEditingController(),
                      decoration: InputDecoration(
                        isDense: true,
                        contentPadding: const EdgeInsets.symmetric(
                          horizontal: 10,
                          vertical: 8,
                        ),
                        hintText: 'Search...',
                        hintStyle: const TextStyle(fontSize: 12),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                        ),
                      ),
                    ),
                  ),
                  searchMatchFn: (item, searchValue) {
                    return widget
                        .displayItem(item.value!)
                        .toLowerCase()
                        .contains(searchValue.toLowerCase());
                  },
                )
              : null,
          onMenuStateChange: (isOpen) {
            if (!isOpen) {
              // Menu closed
            }
          },
        ),
      ),
    );
  }
}

========== FILE: lib/widgets/product_image_card.dart ==========

import 'dart:io';
import 'package:flutter/material.dart';
import 'package:cached_network_image/cached_network_image.dart';
import '../utility/constants.dart';

class ProductImageCard extends StatelessWidget {
  final String labelText;
  final File? imageFile;
  final String? imageUrlForUpdateImage;
  final VoidCallback onTap;
  final VoidCallback onRemoveImage;

  const ProductImageCard({
    Key? key,
    required this.labelText,
    required this.imageFile,
    this.imageUrlForUpdateImage,
    required this.onTap,
    required this.onRemoveImage,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final hasImage = imageFile != null ||
        (imageUrlForUpdateImage != null &&
            imageUrlForUpdateImage!.isNotEmpty &&
            imageUrlForUpdateImage != 'no_url');

    return Container(
      width: 80,
      child: Column(
        children: [
          GestureDetector(
            onTap: onTap,
            child: Container(
              width: 80,
              height: 80,
              decoration: BoxDecoration(
                color: secondaryColor,
                borderRadius: BorderRadius.circular(8),
                border: Border.all(
                  color: hasImage ? primaryColor : Colors.grey.shade600,
                  width: 1.5,
                ),
              ),
              child: Stack(
                children: [
                  // Image content
                  if (hasImage) _buildImageContent() else _buildPlaceholder(),

                  // Camera icon for empty state
                  if (!hasImage)
                    Center(
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(
                            Icons.camera_alt,
                            color: Colors.white70,
                            size: 20,
                          ),
                          SizedBox(height: 4),
                          Text(
                            'Add',
                            style: TextStyle(
                              color: Colors.white70,
                              fontSize: 10,
                            ),
                          ),
                        ],
                      ),
                    ),
                ],
              ),
            ),
          ),

          // Label text
          SizedBox(height: 4),
          Text(
            labelText,
            style: TextStyle(
              color: Colors.white,
              fontSize: 11,
              fontWeight: FontWeight.w500,
            ),
            textAlign: TextAlign.center,
            maxLines: 1,
            overflow: TextOverflow.ellipsis,
          ),

          // Remove button if image exists
          if (hasImage) ...[
            SizedBox(height: 4),
            GestureDetector(
              onTap: onRemoveImage,
              child: Container(
                padding: EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                decoration: BoxDecoration(
                  color: Colors.red.shade800,
                  borderRadius: BorderRadius.circular(4),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(Icons.close, size: 10, color: Colors.white),
                    SizedBox(width: 2),
                    Text(
                      'Remove',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 8,
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ],
      ),
    );
  }

  Widget _buildImageContent() {
    if (imageFile != null) {
      return ClipRRect(
        borderRadius: BorderRadius.circular(6),
        child: Image.file(
          imageFile!,
          fit: BoxFit.cover,
          width: double.infinity,
          height: double.infinity,
        ),
      );
    } else if (imageUrlForUpdateImage != null &&
        imageUrlForUpdateImage!.isNotEmpty &&
        imageUrlForUpdateImage != 'no_url') {
      return ClipRRect(
        borderRadius: BorderRadius.circular(6),
        child: CachedNetworkImage(
          imageUrl: imageUrlForUpdateImage!,
          fit: BoxFit.cover,
          width: double.infinity,
          height: double.infinity,
          placeholder: (context, url) => Center(
            child: CircularProgressIndicator(
              strokeWidth: 1.5,
              valueColor: AlwaysStoppedAnimation<Color>(primaryColor),
            ),
          ),
          errorWidget: (context, url, error) => _buildPlaceholder(),
        ),
      );
    }

    return _buildPlaceholder();
  }

  Widget _buildPlaceholder() {
    return Container(
      decoration: BoxDecoration(
        color: Colors.grey[800]!.withOpacity(0.5),
        borderRadius: BorderRadius.circular(6),
      ),
    );
  }
}

========== FILE: lib/widgets/responsive_data_table.dart ==========

import 'package:flutter/material.dart';
import '../utility/responsive_utils.dart';

class ResponsiveDataTable extends StatelessWidget {
  final List<DataColumn> columns;
  final List<DataRow> rows;
  final double? dataRowMinHeight;
  final double? dataRowMaxHeight;

  const ResponsiveDataTable({
    Key? key,
    required this.columns,
    required this.rows,
    this.dataRowMinHeight,
    this.dataRowMaxHeight,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    if (ResponsiveUtils.isMobile(context)) {
      return _buildMobileView(context);
    } else {
      return _buildDesktopView(context);
    }
  }

  Widget _buildDesktopView(BuildContext context) {
    return SingleChildScrollView(
      scrollDirection: Axis.horizontal,
      child: ConstrainedBox(
        constraints: BoxConstraints(
          minWidth: MediaQuery.of(context).size.width,
        ),
        child: DataTable(
          columnSpacing: 12,
          horizontalMargin: 12,
          headingRowHeight: 40,
          dataRowMinHeight: dataRowMinHeight ?? 60, // Increased min height
          dataRowMaxHeight: dataRowMaxHeight ?? 80, // Increased max height
          columns: columns,
          rows: rows,
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(8),
          ),
          dataTextStyle: TextStyle(
            color: Colors.white70,
            fontSize: 14,
          ),
          headingTextStyle: TextStyle(
            color: Colors.white,
            fontSize: 14,
            fontWeight: FontWeight.bold,
          ),
        ),
      ),
    );
  }

  Widget _buildMobileView(BuildContext context) {
    return ListView.builder(
      shrinkWrap: true,
      physics: NeverScrollableScrollPhysics(),
      itemCount: rows.length,
      itemBuilder: (context, index) {
        return Card(
          margin: EdgeInsets.symmetric(vertical: 4, horizontal: 8),
          color: Colors.grey[900],
          child: Padding(
            padding: EdgeInsets.all(12),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                for (int i = 0; i < columns.length; i++)
                  if (_shouldShowColumnInMobile(i))
                    Padding(
                      padding: EdgeInsets.symmetric(vertical: 4),
                      child: Row(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Expanded(
                            flex: 2,
                            child: Text(
                              _getColumnLabel(columns[i]),
                              style: TextStyle(
                                color: Colors.white,
                                fontWeight: FontWeight.bold,
                                fontSize: 12,
                              ),
                            ),
                          ),
                          SizedBox(width: 8),
                          Expanded(
                            flex: 3,
                            child: Container(
                              constraints: BoxConstraints(
                                minHeight: _getMinHeightForColumn(i),
                              ),
                              child: _buildMobileCellContent(
                                  rows[index].cells[i], i),
                            ),
                          ),
                        ],
                      ),
                    ),
              ],
            ),
          ),
        );
      },
    );
  }

  bool _shouldShowColumnInMobile(int columnIndex) {
    // Show all columns in mobile, but you can customize this
    return true;
  }

  String _getColumnLabel(DataColumn column) {
    if (column.label is Text) {
      return (column.label as Text).data ?? '';
    }
    return '';
  }

  double _getMinHeightForColumn(int columnIndex) {
    // Return larger height for image columns to ensure full visibility
    final columnLabel = _getColumnLabel(columns[columnIndex]).toLowerCase();
    if (columnLabel.contains('image') || columnLabel.contains('photo')) {
      return 60; // More height for images
    }
    return 40; // Default height for other columns
  }

  Widget _buildMobileCellContent(DataCell cell, int columnIndex) {
    final columnLabel = _getColumnLabel(columns[columnIndex]).toLowerCase();

    // Special handling for image columns
    if (columnLabel.contains('image') || columnLabel.contains('photo')) {
      return Container(
        child: cell.child,
        constraints: BoxConstraints(
          maxWidth: 80, // Limit width for images in mobile
        ),
      );
    }

    // For other columns, use the original cell content
    return cell.child;
  }
}

========== FILE: lib/widgets/responsive_header.dart ==========

import 'package:admin_panal_start/services/admin_auth_service.dart';
import 'package:admin_panal_start/utility/constants.dart';
import 'package:admin_panal_start/utility/responsive_utils.dart';
import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:gap/gap.dart';

class ResponsiveHeader extends StatelessWidget {
  final String title;
  final Function(String)? onSearch;
  final VoidCallback? actionButton;
  final String? actionButtonText;

  const ResponsiveHeader({
    Key? key,
    required this.title,
    this.onSearch,
    this.actionButton,
    this.actionButtonText,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final AdminAuthService authService = Get.find<AdminAuthService>();

    return Row(
      children: [
        Expanded(
          child: Text(
            title,
            style: Theme.of(context).textTheme.headlineSmall,
          ),
        ),
        if (onSearch != null) ...[
          Expanded(
            child: TextField(
              onChanged: onSearch,
              decoration: InputDecoration(
                hintText: "Search",
                fillColor: secondaryColor,
                filled: true,
                border: OutlineInputBorder(
                  borderSide: BorderSide.none,
                  borderRadius: BorderRadius.circular(10),
                ),
                prefixIcon: const Icon(Icons.search, color: Colors.white54),
              ),
            ),
          ),
          const Gap(defaultPadding),
        ],
        if (actionButton != null && actionButtonText != null) ...[
          ElevatedButton.icon(
            style: TextButton.styleFrom(
              padding: EdgeInsets.symmetric(
                horizontal: ResponsiveUtils.isMobile(context)
                    ? defaultPadding
                    : defaultPadding * 1.5,
                vertical: ResponsiveUtils.isMobile(context)
                    ? defaultPadding / 2
                    : defaultPadding,
              ),
            ),
            onPressed: actionButton,
            icon: const Icon(Icons.add),
            label: Text(actionButtonText!),
          ),
          Gap(ResponsiveUtils.isMobile(context) ? 8 : 20),
        ],
        // User info section
        Obx(() {
          final currentAdmin = authService.currentAdmin; // This should work now
          return Row(
            children: [
              CircleAvatar(
                backgroundColor: primaryColor,
                child: Text(
                  currentAdmin?.name?.substring(0, 1).toUpperCase() ?? 'A',
                  style: const TextStyle(color: Colors.white),
                ),
              ),
              if (!ResponsiveUtils.isMobile(context)) ...[
                const Gap(8),
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      currentAdmin?.name ?? 'Admin',
                      style: const TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                        fontSize: 14,
                      ),
                    ),
                    Text(
                      currentAdmin?.clearanceLevel?.replaceAll('_', ' ') ??
                          'Admin',
                      style: const TextStyle(
                        color: Colors.white70,
                        fontSize: 12,
                      ),
                    ),
                  ],
                ),
              ],
            ],
          );
        }),
      ],
    );
  }
}
